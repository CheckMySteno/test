<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="robots" content="noindex">
<title>Steno Practice Tool - KC Passages</title>

<!-- External Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>


<!-- Google Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">


<style>
    /* --- 1. Global Styles --- */
    :root {
      --primary-blue: #007bff; --primary-blue-dark: #0056b3;
      --text-color: #111827; --dark-grey: #333; --medium-grey: #555;
      --bg-color: #f8fafc; --surface-color: #ffffff;
      --border-color: #e2e8f0; --white: #fff;
      --font-family: 'Inter', sans-serif;
      --accent-purple: #7c3aed;
      --accent-purple-light: #f3e8ff;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 0; width: 100%; min-height: 100vh; line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    button { font-family: var(--font-family); cursor: pointer; border: none; }
    .view { display: none; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 1a. SELECTION VIEW STYLES --- */
    #selection-view { max-width: 1200px; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 32px; }
    .page-header h1 { font-size: 2rem; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -0.025em; }
    
    .search-wrapper { position: relative; }
    .search-wrapper input { width: 300px; padding: 12px 16px 12px 44px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 0.95em; background-color: white; color: var(--text-color); box-shadow: var(--shadow-sm); transition: all 0.2s ease; }
    .search-wrapper input:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
    .search-wrapper svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: #9ca3af; }

    .intro-box { background: white; border: 1px solid var(--border-color); border-radius: 20px; padding: 24px; margin-bottom: 32px; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 16px; }
    .intro-header { display: flex; justify-content: space-between; align-items: center; }
    .intro-header h2 { font-size: 1.25rem; font-weight: 700; margin: 0; color: #1e293b; }
    .intro-header .tag { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 4px 12px; border-radius: 99px; font-size: 0.75em; font-weight: 700; letter-spacing: 0.5px; }
    .intro-actions button { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9em; transition: all 0.2s; }
    #startFirstTestBtn { background: #1e293b; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    #startFirstTestBtn:hover { background: #0f172a; transform: translateY(-1px); }
    #resetProgressBtn { background: white; border: 1px solid var(--border-color); color: #64748b; }
    #resetProgressBtn:hover { background: #f8fafc; color: #ef4444; border-color: #ef4444; }

    .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; }
    .filter-bar select { padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border-color); background-color: white; color: #4b5563; font-weight: 500; font-size: 0.9em; cursor: pointer; box-shadow: var(--shadow-sm); }

    #passage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
    .passage-card { background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
    .passage-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--accent-purple), #a78bfa); opacity: 0; transition: opacity 0.3s; }
    .passage-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: rgba(124, 58, 237, 0.3); }
    .passage-card:hover::before { opacity: 1; }

    .card-header { margin-bottom: 12px; width: 100%; }
    .card-title-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .card-title-group h3 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0; }
    .card-id-badge { font-size: 0.75em; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600; background-color: #f1f5f9; color: #64748b; width: 100%; }
    .status-badge.attempted { background-color: #ecfdf5; color: #059669; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background-color: currentColor; }

    .card-buttons { margin-top: 16px; }
    .take-test-btn { width: 100%; padding: 10px; background-color: white; border: 1px solid var(--border-color); color: #1e293b; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
    .passage-card:hover .take-test-btn { background-color: #1e293b; color: white; border-color: #1e293b; }

    /* --- 2. SLIM & MODERN PLAYER STYLES --- */
    #player-view { max-width: 680px; margin: 20px auto; }

    .practice-station { background: #ffffff; border-radius: 20px; box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.08); border: 1px solid rgba(0,0,0,0.04); overflow: visible; position: relative; }

    .player-header { background: #fff; padding: 15px 25px; border-bottom: 1px solid #f1f5f9; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .player-info h2 { margin: 0; font-size: 1.1rem; font-weight: 700; color: #1e293b; }
    .player-info p { margin: 2px 0 0 0; font-size: 0.85rem; color: #64748b; }

    .transcript-btn { background: #f8fafc; border: 1px solid #e2e8f0; padding: 6px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .transcript-btn:hover { background: #f1f5f9; color: #1e293b; }

    .player-body { padding: 30px 25px; text-align: center; }

    .progress-container { margin-bottom: 25px; }
    .progress-bar-wrapper { width: 100%; height: 6px; background-color: #f1f5f9; border-radius: 99px; cursor: pointer; position: relative; overflow: hidden; transition: height 0.2s; }
    .progress-bar-wrapper:hover { height: 10px; }
    #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #8b5cf6, #6366f1); border-radius: 99px; transition: width 0.1s linear; }
    .time-display { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem; color: #94a3b8; font-weight: 500; font-family: 'Inter', monospace; }

    .controls-cluster { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; }
    .control-btn { width: 44px; height: 44px; border-radius: 12px; border: none; background: white; color: #64748b; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
    .control-btn:hover { background: #f8fafc; color: #1e293b; transform: translateY(-1px); }
    .control-btn svg { width: 20px; height: 20px; }

    .play-btn-large { width: 64px; height: 64px; background: #1e293b; color: white; border-radius: 20px; box-shadow: 0 10px 20px -5px rgba(30, 41, 59, 0.3); border: none; }
    .play-btn-large:hover { transform: scale(1.05); background: #0f172a; }
    .play-btn-large svg { width: 28px; height: 28px; fill: currentColor; }

    .setting-wrapper { position: relative; }
    .setting-popover { position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: #1e293b; padding: 12px; border-radius: 12px; display: none; flex-direction: column; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 20; min-width: 140px; }
    .setting-popover::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
    .setting-wrapper:hover .setting-popover { display: flex; animation: fadeIn 0.2s; }
    .setting-label { color: #cbd5e1; font-size: 0.7rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }

    input[type=range] { width: 100%; accent-color: #a78bfa; cursor: pointer; }
    #wpmSpeedDisplay { color: white; font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; }

    .test-config-area { background-color: #f8fafc; border-top: 1px solid #e2e8f0; padding: 20px 25px; border-radius: 0 0 20px 20px; }
    .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .config-item label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
    .modern-select { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 0.9rem; color: #334155; background-color: white; cursor: pointer; transition: all 0.2s; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3e%3c/path%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.8rem center; background-size: 1em; }
    .modern-select:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }

    #estimatedTimePill { background: #fff1f2; color: #be123c; font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 6px; display: inline-block; margin-bottom: 15px; border: 1px solid #fecdd3; }
    
    #startTranscriptionBtn { font-size: 1rem; padding: 14px; width: 100%; border-radius: 12px; font-weight: 600; transition: all 0.2s ease; background: #1e293b; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    #startTranscriptionBtn:disabled { background-color: #e2e8f0; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
    #startTranscriptionBtn:not(:disabled):hover { background-color: #0f172a; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

    .back-btn { background: none; color: #94a3b8; font-size: 0.85rem; margin-top: 20px; width: 100%; text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .back-btn:hover { text-decoration: none; color: #64748b; }
    
    .loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 20px; }
    .spinner { border: 3px solid #f1f5f9; border-top: 3px solid #8b5cf6; border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- 3. SSC EXAM VIEW STYLES --- */
    #exam-view { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #fff; flex-direction: column; padding: 0; font-family: 'Tahoma', Arial, sans-serif; }
    .ssc-header { display: flex; align-items: center; justify-content: space-between; background-color: #f0f0f0; padding: 5px 20px; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    .ssc-header-left { display: flex; align-items: center; gap: 15px; }
    .ssc-logo img { height: 45px; }
    .ssc-title h1 { font-size: 1.1em; color: #000; margin: 0; font-weight: bold; }
    .ssc-title p { margin: 0; font-size: 0.8em; color: #555; }
    .ssc-header-right { font-size: 0.8em; text-align: right; }
    .ssc-main-content { display: flex; flex-grow: 1; overflow-y: auto; }
    .ssc-typing-area { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; }
    #typingBox { width: 100%; flex-grow: 1; border: 1px solid #000; border-radius: 0; padding: 10px; font-size: 16px; font-family: 'Courier New', Courier, monospace; resize: none; }
    #typingBox:focus { outline: none; }
    #submitBtn { width: 90px; padding: 5px 10px; font-size: 0.9em; background-color: #000; border-radius: 0; color: white; margin-top: 10px; }
    .ssc-candidate-panel { width: 280px; background-color: #f0f0f0; border-left: 1px solid #ccc; padding: 15px; text-align: left; font-size: 0.9em; color: #333; flex-shrink: 0; }
    .ssc-timer-box { margin-bottom: 20px; }
    .ssc-timer-box span { font-weight: bold; }
    #typingTimerDisplay { font-size: 1.5em; font-weight: bold; color: #d00; }
    .ssc-photo-box { text-align: center; margin-bottom: 20px; }
    .ssc-candidate-photo { width: 100px; height: 120px; border: 1px solid #000; background-color: #fff; margin: 0 auto 5px auto; display: flex; align-items: center; justify-content: center; }
    .ssc-candidate-photo img { width: 60%; height: auto; opacity: 0.5; }
    .ssc-candidate-info { line-height: 1.8; }
    .ssc-candidate-info b { font-weight: bold; color: #000; }

    /* --- 4. RESULT SHEET STYLES --- */
    #results-view { display: none; }
    .result-sheet-container {
        --bg-main: #f8fafc;
        --surface-card: #ffffff;
        --border-subtle: #e2e8f0;
        --text-header: #1e293b;
        --text-body: #334155;
        --text-muted: #64748b;
        --primary-cyan: #0891b2;
        --accent-red: #ef4444;
        --accent-amber: #f97316;
        --hl-additions: #fecdd3;     
        --hl-omissions: #d9f99d;     
        --hl-spelling: #fde68a;      
        --hl-capitalization: #bae6fd; 
        --hl-punctuation: #ddd6fe;   

        font-family: 'Inter', sans-serif;
        background-color: var(--surface-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 35px 45px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        max-width: 1200px;
        margin: auto;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    #results-view.reevaluate-mode-active .result-sheet-container {
        background-color: #f0f2f5;
        box-shadow: 0 0 0 3px var(--accent-purple), 0 8px 25px rgba(0,0,0,0.1);
    }

    #results-view.reevaluate-mode-active [contenteditable="true"] {
        outline: 2px solid var(--accent-purple);
        background-color: white;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        padding: 10px;
        border-radius: 8px;
    }

    .result-sheet-container h1 { font-size: 2.25em; font-weight: 800; margin: 0 0 25px 0; color: var(--text-header); }
    .stats-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
    .stats-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .stat-pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.95em; color: white; background-color: var(--primary-cyan); box-shadow: 0 4px 10px -2px rgba(8, 145, 178, 0.25); }
    .stat-pill.full-width { flex-grow: 1; font-size: 1.1em; }
    .stat-pill.red { background-color: var(--accent-red); box-shadow: 0 4px 10px -2px rgba(239, 68, 68, 0.2); }
    .stat-pill.amber { background-color: var(--accent-amber); box-shadow: 0 4px 10px -2px rgba(249, 115, 22, 0.2); }
    .stat-pill img, .stat-pill svg { width: 18px; height: 18px; }
    
    .legend-container { display: flex; flex-wrap: wrap; gap: 10px 15px; padding: 25px 0; margin-bottom: 25px; border-top: 1px solid var(--border-subtle); border-bottom: 1px solid var(--border-subtle); align-items: center; }
    .legend-item { display: flex; align-items: center; font-size: 0.9em; font-weight: 500; cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: all 0.2s ease; border: 1px solid transparent; }
    .legend-item:hover { background-color: #f0f2f5; transform: translateY(-2px); }
    .legend-item.active { background-color: var(--accent-purple-light); border-color: var(--accent-purple); font-weight: 600; color: var(--accent-purple); }
    .legend-color-box { width: 16px; height: 16px; border-radius: 4px; margin-right: 8px; flex-shrink: 0; }
    .mistake-count { font-weight: 700; margin-left: 6px; color: var(--text-muted); }
    .legend-item.active .mistake-count { color: var(--accent-purple); }
    #reset-filter-btn { margin-left: auto; }

    .result-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .action-section { display: flex; align-items: center; gap: 10px; }
    .view-switch-btn { background-color: var(--bg-main); border: 1px solid var(--border-subtle); padding: 8px 16px; border-radius: 8px; font-weight: 600; color: var(--text-body); cursor: pointer; transition: all 0.2s; }
    .view-switch-btn:hover { background-color: #e2e8f0; }
    
    #viewSwitchBtn { background-color: var(--accent-purple-light); color: var(--accent-purple); border-color: var(--accent-purple); }
    #viewSwitchBtn:hover { background-color: #dadaf7; }

    #deepAnalysisBtn { background-color: #374151; color: white; }

    .reevaluate-wrapper { position: relative; display: inline-flex; align-items: center; gap: 8px; }
    #toggleReevaluateBtn { background-color: var(--accent-amber); color: white; }
    .tooltip-icon { background-color: #9ca3af; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; cursor: help; position: relative; }
    .tooltip-icon:hover::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; white-space: nowrap; z-index: 10; opacity: 1; visibility: visible; transition: opacity 0.2s; }
    .tooltip-icon::after { content: attr(data-tooltip); opacity: 0; visibility: hidden; }
    
    .columns { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .columns.view-side-by-side { grid-template-columns: 1fr 1fr; } }
    .columns.view-top-bottom { grid-template-columns: 1fr; }
    .col { background: var(--bg-main); border-radius: 12px; padding: 25px; border: 1px solid var(--border-subtle); line-height: 1.7; font-size: 1.1em; word-wrap: break-word; }
    .col strong { display: block; margin-bottom: 12px; color: var(--text-header); font-weight: 700; }
    .col p { margin: 0; }
    .word-wrapper { cursor: pointer; display: inline; transition: background-color 0.2s ease, transform 0.2s ease; position: relative; }
    .active-highlight { background-color: #4B0082 !important; color: white !important; border-radius: 3px; animation: pop-3d 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
    @keyframes pop-3d { 0% { transform: scale3d(1, 1, 1); box-shadow: 0 0 0 rgba(0,0,0,0); } 50% { transform: scale3d(1.1, 1.1, 1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); } 100% { transform: scale3d(1, 1, 1); box-shadow: 0 0 0 rgba(0,0,0,0); } }
    .word-wrapper.status-shown::after { content: attr(data-status-icon); position: absolute; top: 50%; left: 50%; font-size: 1.8em; color: white; text-shadow: 0 2px 8px black; opacity: 0; animation: fade-in-out 0.8s ease-in-out forwards; pointer-events: none; z-index: 10; }
    @keyframes fade-in-out { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 30% { opacity: 0.9; } 80% { opacity: 0.9; } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
    .highlight { position: relative; padding: 2px 5px; border-radius: 4px; margin: 0 1px; font-weight: 500; -webkit-box-decoration-break: clone; box-decoration-break: clone; display: inline; transition: transform 0.2s ease-out; }
    .highlight:hover { transform: scale(1.15); z-index: 5; }
    .highlight:hover::after { content: attr(data-tooltip-text); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; padding: 8px 12px; background-color: #111827; color: white; font-size: 0.8em; font-weight: 500; font-family: 'Inter', sans-serif; border-radius: 6px; white-space: nowrap; z-index: 10; opacity: 1; visibility: visible; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .extra, .substitution { background: var(--hl-additions); }
    .omission { background: var(--hl-omissions); }
    .spelling { background: var(--hl-spelling); }
    .spelling b { font-weight: 700; color: #166534; }
    .capitalization { background: var(--hl-capitalization); }
    .punctuation { background: var(--hl-punctuation); }
    .addition { background: var(--hl-additions); }
    .hidden-mistake { background: none !important; text-decoration: none !important; color: inherit !important; padding: 0 !important; margin: 0 !important; border-radius: 0 !important; font-weight: normal !important; }
    .hidden-mistake b { font-weight: normal !important; color: inherit !important; }
    .action-buttons { text-align: center; padding-top: 30px; padding-bottom: 10px; }
    .action-buttons .primary-btn { background-color: #374151; max-width: 400px; margin: 10px auto; display: inline-block; color: white; padding: 12px 25px; border-radius: 8px; font-weight: 600; }
    .action-buttons .secondary-btn { background-color: var(--primary-cyan); color: white; }
    
    /* --- MODALS --- */
    #instructions-modal, .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(20, 20, 30, 0.8);
        backdrop-filter: blur(5px);
        display: none; justify-content: center; align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .modal-overlay.visible, #instructions-modal.visible {
        display: flex; opacity: 1;
    }
    .modal-content { background-color: var(--surface-color); color: var(--text-color); padding: 30px 40px; border-radius: 8px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-subtle); }
    .modal-content h2 { font-size: 1.8em; margin-top: 0; margin-bottom: 25px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 15px; color: var(--text-header);}
    .modal-content ul { text-align: left; list-style-position: inside; padding: 0; margin: 0 0 30px 0; line-height: 2.2; color: var(--text-body); }
    .modal-content ul li::marker { color: var(--accent-purple); }
    #continue-btn, .modal-close-btn { background-color: #1f2937; color: white; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border-radius: 8px; transition: background-color 0.2s; }
    #continue-btn:hover, .modal-close-btn:hover { background-color: #000; }

    /* --- NEW: MODERN, CLASSIC WELCOME MODAL --- */
    @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    #resultsWelcomeModal .modal-content { max-width: 800px; width: 95%; text-align: left; font-family: 'Inter', sans-serif; border-radius: 12px; padding: 0; overflow: hidden; animation: fadeInScaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid var(--border-subtle); }
    .pro-modal-header { text-align: center; padding: 30px 35px; border-bottom: 1px solid var(--border-subtle); }
    .pro-modal-header h2 { font-size: 1.8em; font-weight: 700; margin: 0 0 8px 0; border: none; padding: 0; }
    .pro-modal-header p { color: var(--text-muted); max-width: 550px; margin: 0 auto; font-size: 1em; line-height: 1.6; }
    .pro-welcome-grid { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 30px 35px; }
    @media (min-width: 768px) { .pro-welcome-grid { grid-template-columns: 1fr 1fr; } }
    .pro-feature-box { background-color: var(--bg-main); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 25px; position: relative; overflow: hidden; }
    .pro-feature-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
    .pro-feature-icon { background-color: #f3f4f6; color: var(--text-header); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .pro-feature-icon svg { width: 22px; height: 22px; }
    .pro-feature-title { font-size: 1.1em; font-weight: 600; margin: 0; color: var(--text-header); }
    .pro-feature-box p { font-size: 0.9em; line-height: 1.6; color: var(--text-body); margin: 0 0 15px 0; }
    .pro-feature-box .pro-step-list { padding-left: 0; list-style: none; margin: 0; }
    .pro-step-list li { font-size: 0.9em; color: var(--text-body); margin-bottom: 10px; }
    .pro-step-list b { font-weight: 600; color: var(--text-header); }
    .pro-exclusive-badge { position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #FFD700, #FDB813); color: #4a2c00; padding: 10px 15px; font-size: 0.7em; font-weight: 700; text-transform: uppercase; border-bottom-left-radius: 12px; border-top-right-radius: 11px; }
    .pro-modal-footer { background-color: #f8fafc; padding: 15px 35px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-subtle); }
    .pro-modal-footer label { font-size: 0.85em; cursor: pointer; color: var(--text-muted); }
    .pro-modal-footer input[type="checkbox"] { vertical-align: middle; margin-right: 5px; }
     
    /* Advanced Report Modal Styles */
    #reportErrorModal .modal-content { max-width: 500px; text-align: left; }
    #reportErrorModal h2 { text-align: left; }
    #reportErrorModal p { color: var(--text-body); }
    #reportErrorModal label { font-weight: 600; color: var(--text-header); }
    #reportErrorModal select, #reportErrorModal textarea { width: 100%; padding: 10px 12px; background-color: var(--bg-main); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 1em; margin-top: 5px; color: var(--text-color); }
    #reportErrorModal select:focus, #reportErrorModal textarea:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
    #submitReportBtn:disabled { background-color: #d1d5db; opacity: 0.7; cursor: not-allowed; }

    #deepAnalysisModal .modal-content { max-width: 900px; width: 95%; text-align: left; }
    #deepAnalysisModal table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95em; }
    #deepAnalysisModal th, #deepAnalysisModal td { padding: 12px 15px; border: 1px solid var(--border-subtle); text-align: left; }
    #deepAnalysisModal th { background-color: var(--bg-main); font-weight: 600; }
    #deepAnalysisModal tr:nth-child(even) { background-color: #fcfdff; }
    #deepAnalysisModal em { color: var(--text-muted); font-style: italic; }

    /* New Transcript Modal Styles */
    #transcriptModal .modal-content { max-width: 600px; text-align: left; max-height: 80vh; display: flex; flex-direction: column; }
    #transcriptTextBody { overflow-y: auto; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; line-height: 1.8; color: #374151; font-size: 1.05rem; margin-bottom: 15px; }

    .confirm-dialog { background: var(--surface-color); padding: 24px; border-radius: 16px; text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .confirm-dialog h3 { margin: 0 0 8px 0; font-size: 1.25em; }
    .confirm-dialog p { margin: 0 0 20px 0; color: var(--medium-grey); }
    .confirm-dialog-actions { display: flex; gap: 10px; justify-content: center; }
    .confirm-dialog-actions button { padding: 10px 20px; border-radius: 8px; font-weight: 600; }
    #confirmResetBtn { background-color: #ef4444; color: white; }
    #cancelResetBtn { background-color: #e5e7eb; color: #4b5563; }
    
    .full-page-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 9999; }
    
    @media (max-width: 768px) {
        .ssc-header { flex-direction: column; gap: 10px; padding: 10px; text-align: center; }
        .ssc-header-left, .ssc-header-right { text-align: center; width: 100%; }
        .ssc-title h1 { font-size: 1em; }
        .ssc-main-content { flex-direction: column; }
        .ssc-typing-area { padding: 10px; min-height: 50vh; }
        .ssc-candidate-panel { width: 100%; border-left: none; border-top: 1px solid #ccc; flex-shrink: 1; padding: 10px; }
        .ssc-photo-box { margin-bottom: 10px; }
        .config-grid { grid-template-columns: 1fr; }
    }

    @media print {
      body, .app-container, .result-sheet-container { background: #fff !important; color: #000 !important; box-shadow: none; border: none; }
      .view { display: none !important; }
      #results-view { display: block !important; }
      .action-buttons, .result-controls, .legend-container, .back-btn { display: none !important; }
      .result-sheet-container { padding: 0; }
      .col { border: 1px solid #ccc; max-height: none; overflow-y: visible; }
      .columns { grid-template-columns: 1fr 1fr !important; }
    }
    
    /* Specific styles for AI Modal & Icon */
    .ai-mistake-context { background:#f1f5f9; padding:10px; border-radius:6px; margin-bottom:15px; border-left:4px solid #4f46e5; }
    .ai-explanation-text { font-size: 1rem; color: #1e293b; }
    .ai-rule-badge { display: inline-block; background: #e0e7ff; color: #4338ca; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: 700; text-transform:uppercase; margin-bottom: 5px; }
    
    /* AI Icon Styling */
    .ai-icon {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background-color: #4f46e5;
        color: white !important;
        border-radius: 50%;
        font-size: 10px;
        font-weight: bold;
        margin-left: 5px;
        cursor: pointer;
        vertical-align: middle;
        user-select: none;
        transition: transform 0.2s;
    }

    .ai-icon:hover {
        transform: scale(1.2);
        background-color: #4338ca;
    }
</style>
</head>
<body oncontextmenu="return false;">

<div id="fullPageLoader" class="full-page-loader">
    <div class="spinner"></div>
</div>

<div class="app-container">
    <div id="selection-view" class="view">
        <div class="page-header">
            <h1>Kailash Chandra (KC) Passages</h1>
            <div class="header-controls">
                <div class="search-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    <input type="search" id="passageSearch" placeholder="Search passages...">
                </div>
            </div>
        </div>
        
        <div id="quick-resume-container"></div>

        <div class="intro-box">
            <div class="intro-header">
                <h2>Practice Section</h2>
                <span class="tag">PAID</span>
            </div>
            <p>Practice all passages. Your progress is saved automatically in this browser. Use the reset button to clear your local and cloud data.</p>
            <div class="intro-actions">
                <button id="startFirstTestBtn">Start First Test</button>
                <button id="resetProgressBtn">Reset Progress</button>
            </div>
        </div>

        <div class="filter-bar">
            <select id="filter-select">
                <option value="all">Show All</option>
                <option value="attempted">Show Attempted</option>
                <option value="not-attempted">Show Not Attempted</option>
            </select>
            <select id="sort-select">
                <option value="default">Sort by Number</option>
                <option value="score-asc">Sort by Score (Low to High)</option>
                <option value="score-desc">Sort by Score (High to Low)</option>
            </select>
        </div>

        <div id="passage-grid"></div>
    </div>
    
    <div id="player-view" class="view">
        <div id="player"></div> <!-- Hidden YouTube Player -->
        
        <div class="practice-station">
            <div id="player-loader" class="loader"><div class="spinner"></div></div>
            
            <!-- Modern Header -->
            <div class="player-header">
                <div class="player-info">
                    <h2 class="player-title">Dictation Player</h2>
                    <p id="player-subtitle">Kailash Chandra - Loading...</p>
                </div>
                <button class="transcript-btn" onclick="openTranscriptModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    View Transcript
                </button>
            </div>

            <div class="player-body">
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar-wrapper">
                        <div id="progress-fill"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">00:00</span>
                        <span id="total-time">00:00</span>
                    </div>
                </div>

                <!-- Controls Cluster -->
                <div class="controls-cluster">
                     <!-- Volume -->
                    <div class="setting-wrapper">
                        <button class="control-btn" id="volumeBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        </button>
                        <div class="setting-popover">
                            <span class="setting-label">Volume</span>
                            <input type="range" id="volume-slider" min="0" max="100" value="100">
                        </div>
                    </div>

                    <!-- Seek Back -->
                    <button class="control-btn" onclick="seekRelative(-5)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>
                    </button>

                    <!-- Play/Pause (Big) -->
                    <button id="playBtn" class="control-btn play-btn-large" onclick="togglePlay()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button id="pauseBtn" class="control-btn play-btn-large" onclick="togglePlay()" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>

                    <!-- Seek Forward -->
                    <button class="control-btn" onclick="seekRelative(5)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
                    </button>

                     <!-- Speed -->
                     <div class="setting-wrapper">
                        <button class="control-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        </button>
                        <div class="setting-popover" style="min-width: 200px;">
                            <span class="setting-label">Speed</span>
                            <div id="wpmSpeedDisplay">100 WPM</div>
                            <input type="range" id="wpmRange" min="60" max="160" step="5" value="100" oninput="updateSpeedDisplay(this.value)" onchange="setPlaybackSpeed()">
                            <!-- Hidden input for compatibility -->
                            <input type="hidden" id="wpmSpeed" value="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Area -->
            <div class="test-config-area">
                <div style="text-align: center;">
                    <span id="estimatedTimePill">Full Passage Mode</span>
                </div>
                
                <div class="config-grid">
                    <div class="config-item">
                        <label>Target Words</label>
                        <select id="wordCountSelect" class="modern-select" onchange="updateAutoStopSettings()">
                            <!-- JS Populated -->
                        </select>
                    </div>
                    <div class="config-item">
                        <label>Timer Duration</label>
                        <select id="timer-select" class="modern-select">
                            <option value="50" selected>50 Minutes</option>
                            <option value="40">40 Minutes</option>
                            <option value="10">10 Minutes</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <label style="font-size: 0.9rem; color: #4b5563; font-weight: 500; cursor: pointer;">
                        <input type="checkbox" id="includeComma" style="accent-color: #7c3aed; vertical-align: text-bottom;"> 
                        Count comma (,) mistakes
                    </label>
                </div>

                <button id="startTranscriptionBtn" onclick="showInstructions()" disabled>üöÄ Start Transcription Test</button>
            </div>
        </div>
        <button onclick="clearStateAndGoBack()" class="back-btn">Choose a different dictation</button>
    </div>

    <div id="results-view" class="view">
        <div id="resultSheetContainer"></div>
        <div class="action-buttons">
            <button id="printReportBtn" class="primary-btn">Download Report</button>
            <button onclick="goHome()" class="primary-btn">üè† Try Another Dictation</button>
        </div>
    </div>
</div>

<div id="instructions-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Practice Test Instructions</h2>
        <ul>
            <li>This is a simulation of the official SSC Stenographer Skill Test.</li>
            <li>The timer will begin automatically as soon as you type the first character.</li>
            <li>Do not close or refresh this window during the test.</li>
            <li>Ensure you have a stable internet connection.</li>
            <li>Click the "Submit" button to finish the test and view your results.</li>
            <li>Good Luck!</li>
        </ul>
        <button id="continue-btn" onclick="startTranscriptionTest()">Continue</button>
    </div>
</div>

<div id="error-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="error-title">An Error Occurred</h2>
        <p id="error-message" style="line-height: 1.6; margin-bottom: 25px;">Could not load the requested passage. Please check your internet connection and try again.</p>
        <button id="error-close-btn" class="modal-close-btn">Close</button>
    </div>
</div>

<div id="deepAnalysisModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Deep Analysis Report</h2>
        <div style="max-height: 60vh; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Mistake Type</th>
                        <th>Your Transcription</th>
                        <th>Original Text</th>
                    </tr>
                </thead>
                <tbody id="deep-analysis-table-body">
                    <!-- Rows will be injected by JavaScript -->
                </tbody>
            </table>
        </div>
        <button id="closeDeepAnalysisBtn" class="modal-close-btn" style="margin-top: 20px;">Close</button>
    </div>
</div>

<div id="reportErrorModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Report Transcription Error</h2>
        <p>Help us improve! Please specify the error in the original passage.</p>
        <div style="margin-bottom: 15px; text-align: left;">
            <label for="errorTypeSelect" style="display: block; margin-bottom: 5px; font-weight: 600;">Type of Error:</label>
            <select id="errorTypeSelect" style="width: 100%; padding: 10px; color: #333; background-color: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px;">
                <option value="" disabled selected>-- Select an error type --</option>
                <option value="Year is incorrect">Year is incorrect</option>
                <option value="Word is different from audio">Word is different from audio</option>
                <option value="Punctuation mismatch">Punctuation mismatch</option>
                <option value="Word is missing/extra">Word is missing/extra</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div style="margin-bottom: 20px; text-align: left;">
            <label for="otherErrorText" style="display: block; margin-bottom: 5px; font-weight: 600;">Describe the mistake:</label>
            <textarea id="otherErrorText" rows="3" placeholder="e.g., The year should be 1985, not 1984." style="width: 100%; padding: 10px; color: #333; background-color: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; resize: vertical;"></textarea>
        </div>
        <div style="text-align: right;">
            <button id="cancelReportBtn" class="modal-close-btn" style="background-color: #777; margin-right: 10px;">Cancel</button>
            <button id="submitReportBtn" class="modal-close-btn" disabled>Submit Report</button>
        </div>
    </div>
</div>

<div id="resultsWelcomeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 550px;">
        <div class="pro-modal-header" style="padding: 25px 30px;">
            <h2 style="font-size: 1.6em;">Advanced Re-evaluation Mode</h2>
            <p style="font-size: 0.95em;">Instantly see how corrections impact your score. In this mode, you can edit both the original text and your own transcription.</p>
        </div>
        
        <div class="pro-welcome-grid" style="padding: 20px 30px; grid-template-columns: 1fr;">
            <div class="pro-feature-box">
                <div class="pro-feature-header">
                    <div class="pro-feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    </div>
                    <h3 class="pro-feature-title">How It Works</h3>
                </div>
                <ul class="pro-step-list">
                    <li><b>1. Enter Mode:</b> Click <b>"Enter Re-evaluate Mode"</b>.</li>
                    <li><b>2. Edit:</b> Click directly on words in either box to make corrections. The highlights will guide you.</li>
                    <li><b>3. Calculate:</b> Click <b>"Calculate & Exit Mode"</b> to see your new score.</li>
                </ul>
            </div>
        </div>

        <div class="pro-modal-footer" style="padding: 15px 30px;">
            <label>
                <input type="checkbox" id="dontShowAgainCheckbox">
                Don't show me this again
            </label>
            <button id="closeWelcomeBtn" class="modal-close-btn">Okay, Got It!</button>
        </div>
    </div>
</div>

<div id="transcriptModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="text-align: left; margin-bottom: 15px;">Passage Transcript</h2>
        <div id="transcriptTextBody"></div>
        <div style="text-align: right;">
            <button class="modal-close-btn" onclick="document.getElementById('transcriptModal').classList.remove('visible')">Close</button>
        </div>
    </div>
</div>

<div id="exam-view">
    <header class="ssc-header">
        <div class="ssc-header-left">
            <div class="ssc-logo">
                <img id="ssc-logo-img" src="" alt="SSC Logo">
            </div>
            <div class="ssc-title">
                <h1>STAFF SELECTION COMMISSION</h1>
                <p>SSC STENOGRAPHER GRADE C & D EXAMINATION - 2024</p>
            </div>
        </div>
        <div class="ssc-header-right">
            <div id="exam-date"><b>Exam Date:</b> </div>
            <div><b>Shift:</b> 1st Shift (Morning)</div>
            <div><b>Exam Centre:</b> Your Assigned Centre</div>
        </div>
    </header>
    <main class="ssc-main-content">
        <div class="ssc-typing-area">
            <textarea id="typingBox" placeholder="Start typing..." autocapitalize="off" autocorrect="off" spellcheck="false"></textarea>
            <button id="submitBtn" onclick="submitTranscription()">Submit</button>
        </div>
        <aside class="ssc-candidate-panel">
            <div class="ssc-timer-box">
                <span>Time Left:</span>
                <span id="typingTimerDisplay">50:00</span>
            </div>
            <div class="ssc-photo-box">
                <div class="ssc-candidate-photo">
                    <img src="" alt="Candidate Photo">
                </div>
                <span>Profile Picture</span>
            </div>
            <div class="ssc-candidate-info">
                <div><b>Name:</b> <span id="candidate-name-display">CANDIDATE</span></div>
                <div><b>Roll No.:</b> 9876543210</div>
                <div><b>Language:</b> English</div>
                <div><b>Exam -</b> SSC Stenographer Grade C & D Examination - 2024</div>
            </div>
        </aside>
    </main>
</div>

<div id="resetConfirmModal" class="modal-overlay">
    <div class="confirm-dialog">
        <h3>Reset KC Progress?</h3>
        <p>This will permanently delete your saved scores and attempt history from this browser and from the cloud. This action cannot be undone.</p>
        <div class="confirm-dialog-actions">
            <button id="cancelResetBtn">Cancel</button>
            <button id="confirmResetBtn">Confirm & Reset</button>
        </div>
    </div>
</div>

<!-- AI Analysis Modal -->
<div id="aiModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; text-align: left; border-radius: 12px; font-family: 'Inter', sans-serif;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0; font-size:1.1rem; color:#4f46e5; display:flex; align-items:center; gap:8px;">
                <span>üß†</span> AI Teacher Analysis
            </h3>
            <button class="modal-close-btn" onclick="document.getElementById('aiModal').classList.remove('visible')" style="background:none; color:#666; font-size:1.2rem; padding:0;">‚úï</button>
        </div>
        
        <div id="aiModalContent" style="line-height:1.6; color:#334155; font-size:0.95rem;">
            <!-- AI Content Goes Here -->
        </div>

        <div id="aiLoadingState" style="display:none; text-align:center; padding:30px;">
            <div class="spinner" style="margin:0 auto 15px auto; border-top-color:#4f46e5;"></div>
            <p style="color:#64748b; font-weight:500;">Analyzing your dictation context...</p>
            <p style="font-size:0.8rem; color:#94a3b8;">This will take a few seconds, then other clicks will be instant.</p>
        </div>
    </div>
</div>

<!-- Link to your new JavaScript files -->
<script>
// --- Dexie.js Local Database Setup ---
const localDb = new Dexie("CheckMyStenoDB");
localDb.version(1).stores({
    attempts: '++id, timestamp, dictationName, accuracy, wpm',
    mistakeLibrary: '++id, &[originalWord+typedWord], count',
    overallStats: 'id'
});

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE",
  authDomain: "checkmysteno.firebaseapp.com",
  projectId: "checkmysteno",
  storageBucket: "checkmysteno.firebasestorage.app",
  messagingSenderId: "719325115943",
  appId: "1:719325115943:web:0dd50a67978816d42a8002"
};
// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
} catch (e) {
    console.error("Firebase initialization failed. Please provide valid credentials.", e);
}
const db = firebase.firestore ? firebase.firestore() : null;

// --- Global State Variables ---
let player, originalText = "", wordCount = 0;
let totalVideoDuration = 0, currentPlaybackRate = 1, progressInterval;
let g_vol = "", g_tran = "", candidateId, attemptsRef;
let transcriptionTimerTotalTime = 0, timeLeft = 0, timer = null, timerStarted = false;
let g_lastAnalysisResult; 
let allPassageData = [];
let g_lastTypedText = "";
let isReevaluateModeActive = false;
let analysisWorker; 
let g_selectedTarget = "full"; 
let g_stopVideoWatcher = null; 
let g_autoStopTimestamp = Infinity; 
let g_synonymData = [];

document.addEventListener("DOMContentLoaded", initializePracticeKC);

// --- Anti-Cheating & Setup ---
function setupAntiInspection() {
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) || (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
        }
    });
    const typingBox = document.getElementById('typingBox');
    if (typingBox) {
        typingBox.addEventListener('contextmenu', (e) => e.stopPropagation());
    }
}

function setLogoSource() {
    const defaultLogo = ""; 
    const logoImg = document.getElementById('ssc-logo-img');
    if (logoImg) logoImg.src = defaultLogo || "";
}

// --- Initialization ---
async function initializePracticeKC() {
    const accessCode = localStorage.getItem("currentAccessCode");
    if (!accessCode) {
        showErrorModal("Access Denied", "No access code found. Please log in first.");
        document.body.innerHTML = '';
        return;
    }
    candidateId = accessCode;
    document.getElementById('candidate-name-display').textContent = candidateId.toUpperCase();
    
    if (db) {
        attemptsRef = db.collection("testAnalysis").doc(candidateId).collection("attempts");
    }

    setupAntiInspection();
    setupProgressBar();
    setupExtraControls();
    setLogoSource();
    restoreSession();

    if (window.Worker) {
        analysisWorker = new Worker('worker.js');
    } else {
        alert("Your browser does not support Web Workers. The application may be slow.");
    }
    
    await loadSynonyms();
    await generateAllPassageData();
    renderGrid();

    initializeEventListeners();
    renderQuickResume();
}

async function loadSynonyms() {
    try {
        const response = await fetch('/config/flex_synonyms.php');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        g_synonymData = Array.isArray(data) ? data : [];
    } catch (error) {
        console.error("Could not load synonym data.", error);
        g_synonymData = []; 
    }
}

function getCurrentConfigForWorker() {
    const includeCommas = document.getElementById("includeComma")?.checked;
    return {
      mode: 'exam',
      addition: 1,
      omission: 1,
      spelling: 0.5,
      capitalization: 0.5,
      punctuation: { 
          mode: includeCommas ? 'all' : 'fullstop-only', 
          weight: 0.5 
      },
    };
}

// --- Passage Data and Grid Rendering ---
function generateAllPassageData() {
    allPassageData = [];
    let transcriptCounter = 1;
    for (let i = 1; i <= 24; i++) {
        for (let j = 1; j <= 22; j++) {
            allPassageData.push({
                id: `passage-${i}-${j}`,
                volume: i,
                transcript: transcriptCounter,
                transcriptNumber: transcriptCounter,
                volId: `vol${i}`,
                tranId: `t${transcriptCounter}`
            });
            transcriptCounter++;
        }
    }
}

function renderGrid() {
    const grid = document.getElementById('passage-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const progressData = JSON.parse(localStorage.getItem(`kcProgress_${candidateId}`) || '{}');
    let dataToRender = [...allPassageData];

    const filterValue = document.getElementById('filter-select').value;
    if (filterValue !== 'all') {
        dataToRender = dataToRender.filter(passage => {
            const key = `${passage.volId}-${passage.tranId}`;
            const hasAttempt = !!progressData[key];
            return (filterValue === 'attempted' && hasAttempt) || (filterValue === 'not-attempted' && !hasAttempt);
        });
    }

    const sortValue = document.getElementById('sort-select').value;
    if (sortValue !== 'default') {
        dataToRender.sort((a, b) => {
            const keyA = `${a.volId}-${a.tranId}`;
            const keyB = `${b.volId}-${b.tranId}`;
            const scoreA = progressData[keyA] ? progressData[keyA].accuracy : -1;
            const scoreB = progressData[keyB] ? progressData[keyB].accuracy : -1;
            if (sortValue === 'score-asc') return scoreA - scoreB;
            if (sortValue === 'score-desc') return scoreB - scoreA;
            return 0;
        });
    }

    const searchTerm = document.getElementById('passageSearch').value.toLowerCase();
    if (searchTerm) {
        dataToRender = dataToRender.filter(p => {
            const title = `vol ${p.volume} / tran ${p.transcript}`;
            const passageNum = `passage ${p.transcriptNumber}`;
            return title.includes(searchTerm) || passageNum.includes(searchTerm);
        });
    }

    const fragment = document.createDocumentFragment();
    dataToRender.forEach(data => {
        const card = document.createElement('div');
        card.className = 'passage-card';
        card.id = data.id;
        card.dataset.volume = data.volId;
        card.dataset.transcript = data.tranId;

        const key = `${data.volId}-${data.tranId}`;
        const attemptData = progressData[key];
        const isAttempted = !!attemptData;

        card.innerHTML = `
              <div class="card-header">
                  <div class="card-title-group">
                      <span class="card-id-badge">KC / VOL ${data.volume}</span>
                      <span class="status-badge ${isAttempted ? 'attempted' : ''}">
                        <span class="status-dot"></span>
                        ${isAttempted ? `${attemptData.accuracy}%` : 'New'}
                      </span>
                  </div>
                  <h3>Passage ${data.transcriptNumber}</h3>
              </div>
              <div class="card-buttons">
                  <button class="take-test-btn">${isAttempted ? 'Retake Test' : 'Start Practice'}</button>
              </div>
          `;
        fragment.appendChild(card);
    });
    grid.appendChild(fragment);
}

// --- Application State and View Management ---
function saveState(state) { localStorage.setItem('stenoState', JSON.stringify(state)); }
function clearState() { localStorage.removeItem('stenoState'); }

function restoreSession() {
    const savedState = JSON.parse(localStorage.getItem('stenoState'));
    if (!savedState) {
        showView('selection-view');
        return;
    }
    if (savedState.view === 'exam-view') {
        g_vol = savedState.g_vol;
        g_tran = savedState.g_tran;
        originalText = savedState.originalText;
        wordCount = savedState.wordCount;
        showView('exam-view');
        document.documentElement.requestFullscreen().catch(err => { });
        document.getElementById('typingBox').value = savedState.typedText || '';
        transcriptionTimerTotalTime = savedState.totalTime;
        timeLeft = savedState.timeLeft;
        timerStarted = true;
        startTimer();
    } else {
        showView('selection-view');
    }
}

function showView(viewId) {
    document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
    document.getElementById('exam-view').style.display = 'none';
    const viewToShow = document.getElementById(viewId);
    if (viewToShow) viewToShow.style.display = 'block';

    if (viewId === 'exam-view') {
        document.querySelector('.app-container').style.display = 'none';
        document.getElementById('exam-view').style.display = 'flex';
    } else {
        document.querySelector('.app-container').style.display = 'block';
    }

    if (viewId === 'selection-view') {
        clearState();
        if (player && typeof player.stopVideo === 'function') player.stopVideo();
        renderGrid();
        renderQuickResume();
    }
}

function goHome() {
    if (document.fullscreenElement) document.exitFullscreen().catch(() => { });
    showView('selection-view');
}

function clearStateAndGoBack() {
    showView('selection-view');
}

// --- Player and Test Logic ---
async function loadPractice(volumeId, transcriptId) {
    g_vol = volumeId;
    g_tran = transcriptId;
    if (!g_vol || !g_tran) {
        showErrorModal("Passage Error", "Could not identify the passage. Please try again.");
        return;
    }
    document.getElementById('fullPageLoader').style.display = 'flex';
    try {
        if (!db) throw new Error("Database connection is not available.");
        const textDoc = await db.collection("volumes").doc(g_vol).collection("transcripts").doc(g_tran).get();
        if (!textDoc.exists) throw new Error("Transcript text not found.");
        originalText = textDoc.data().text;
        const audioDoc = await db.collection("audioLinks").doc(g_vol).collection("transcripts").doc(g_tran).get();
        if (!audioDoc.exists) throw new Error("Audio link document not found.");
        const audioData = audioDoc.data();
        if (!audioData || !audioData.audioUrl || typeof audioData.wordCount !== 'number') throw new Error("Audio document is missing required fields.");
        wordCount = audioData.wordCount;

        document.getElementById('transcriptTextBody').textContent = originalText;

        saveState({ view: 'player-view', g_vol, g_tran, originalText, wordCount, audioUrl: audioData.audioUrl });

        showView('player-view');
        setPlayerLoading(true);

        setupWordCountOptions();

        const passageData = allPassageData.find(p => p.volId === g_vol && p.tranId === g_tran);
        document.getElementById('player-subtitle').textContent = `Kailash Chandra - Passage ${passageData.transcriptNumber}`;
        loadVideo(audioData.audioUrl, false);
    } catch (error) {
        showErrorModal("Loading Error", "Error: " + error.message);
        showView('selection-view');
    } finally {
        document.getElementById('fullPageLoader').style.display = 'none';
    }
}

function setupWordCountOptions() {
    const select = document.getElementById('wordCountSelect');
    select.innerHTML = ''; 
    let step = 200;
    for (let i = step; i < wordCount; i += step) {
        let option = document.createElement('option');
        option.value = i;
        option.text = `${i} Words (Approx)`;
        select.appendChild(option);
    }
    let fullOption = document.createElement('option');
    fullOption.value = "full";
    fullOption.text = `Full Passage (${wordCount} Words)`;
    fullOption.selected = true;
    select.appendChild(fullOption);
    updateAutoStopSettings();
}

function updateAutoStopSettings() {
    const display = document.getElementById('estimatedTimePill');
    const select = document.getElementById('wordCountSelect');
    const val = select.value;
    g_selectedTarget = val;

    if (val === "full") {
        g_autoStopTimestamp = Infinity;
        display.innerText = "Audio plays until end";
        display.style.background = "#ecfdf5";
        display.style.color = "#047857";
        display.style.borderColor = "#a7f3d0";
    } else {
        let words = parseInt(val);
        if(totalVideoDuration > 0) {
            let ratio = words / wordCount;
            g_autoStopTimestamp = (totalVideoDuration * ratio) + 10; 
            if(g_autoStopTimestamp > totalVideoDuration) g_autoStopTimestamp = totalVideoDuration - 0.5;
        }
        display.innerText = `Auto-Stop for ~${words} words`;
        display.style.background = "#fffbeb";
        display.style.color = "#b45309";
        display.style.borderColor = "#fcd34d";
    }
    if(totalVideoDuration === 0 && player && player.getDuration) {
        totalVideoDuration = player.getDuration();
    }
}

function showInstructions() {
    if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
    document.getElementById('instructions-modal').classList.add('visible');
}

function startTranscriptionTest() {
    document.getElementById('instructions-modal').classList.remove('visible');
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => console.log("Fullscreen optional"));
    }
    showView('exam-view');
    transcriptionTimerTotalTime = parseInt(document.getElementById('timer-select').value) * 60;
    timeLeft = transcriptionTimerTotalTime;
    document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
    document.getElementById('typingBox').value = '';
    document.getElementById('typingBox').focus();
    
    const box = document.getElementById('typingBox');
    box.removeEventListener('keydown', handleFirstKeydown);
    box.addEventListener('keydown', handleFirstKeydown);

    const currentState = JSON.parse(localStorage.getItem('stenoState'));
    saveState({ ...currentState, view: 'exam-view', totalTime: transcriptionTimerTotalTime, timeLeft: timeLeft, typedText: '' });
}

function handleFirstKeydown() {
    if (!timerStarted) {
        timerStarted = true;
        startTimer();
        document.getElementById('typingBox').removeEventListener('keydown', handleFirstKeydown);
    }
}

function startTimer() {
    if (timer) return;
    timer = setInterval(() => {
        if (--timeLeft < 0) {
            clearInterval(timer);
            alert("Time is up! Submitting automatically.");
            submitTranscription();
        } else {
            document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
            const currentState = JSON.parse(localStorage.getItem('stenoState'));
            if (currentState) saveState({ ...currentState, timeLeft, typedText: document.getElementById('typingBox').value });
        }
    }, 1000);
}

function resetTimer() {
    if (timer) clearInterval(timer);
    timer = null;
    timerStarted = false;
    timeLeft = transcriptionTimerTotalTime;
    document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
}

// --- YouTube Player Controls ---
function onYouTubeIframeAPIReady() { }
function extractVideoID(url) { if (typeof url !== 'string') return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/; return (url.match(regex) || [])[1] || null; }

function loadVideo(url, autoPlay = false) {
    const videoId = extractVideoID(url);
    if (!videoId) { showErrorModal("Invalid URL", "Invalid YouTube URL provided."); return; }
    const onPlayerReady = (event) => {
        totalVideoDuration = event.target.getDuration();
        setPlayerLoading(false);
        setPlaybackSpeed();
        updateAutoStopSettings();
    };
    if (player && typeof player.loadVideoById === 'function' && player.getIframe()?.isConnected) {
        player.loadVideoById(videoId);
        const readyCheck = setInterval(() => {
            if (player.getDuration() > 0 && player.getPlayerState() !== -1) { clearInterval(readyCheck); onPlayerReady({ target: player }); }
        }, 100);
    } else {
        if (player && typeof player.destroy === 'function') player.destroy();
        player = new YT.Player('player', { height: '1', width: '1', videoId, playerVars: { 'autoplay': autoPlay ? 1 : 0, 'controls': 0 }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } });
    }
}

function onPlayerStateChange(event) {
    const playBtn = document.getElementById("playBtn"), pauseBtn = document.getElementById("pauseBtn");
    if (g_stopVideoWatcher) clearInterval(g_stopVideoWatcher);
    if (event.data === YT.PlayerState.PLAYING) { 
        playBtn.style.display = 'none'; 
        pauseBtn.style.display = 'flex'; 
        if (g_autoStopTimestamp !== Infinity) {
            g_stopVideoWatcher = setInterval(() => {
                if(player && player.getCurrentTime) {
                    if (player.getCurrentTime() >= g_autoStopTimestamp) {
                        player.pauseVideo();
                        clearInterval(g_stopVideoWatcher);
                    }
                }
            }, 100);
        }
        trackProgress(); 
    }
    else { 
        playBtn.style.display = 'flex'; 
        pauseBtn.style.display = 'none'; 
        clearInterval(progressInterval); 
    }
}

function setPlaybackSpeed() {
    if (!player || !player.setPlaybackRate) return;
    const targetWPM = parseInt(document.getElementById('wpmRange').value);
    if (!isNaN(targetWPM) && wordCount && totalVideoDuration) { 
        const originalWPM = wordCount / (totalVideoDuration / 60); 
        currentPlaybackRate = originalWPM > 0 ? targetWPM / originalWPM : 1;
    } else {
        currentPlaybackRate = 1;
    }
    player.setPlaybackRate(currentPlaybackRate);
    updateVideoTimeDisplay();
}

function updateSpeedDisplay(val) {
    document.getElementById('wpmSpeedDisplay').textContent = val + " WPM";
}

function togglePlay() { if (!player || !player.getPlayerState) return; player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo(); }
function seekRelative(seconds) { if (!player || !player.getCurrentTime) return; const newTime = player.getCurrentTime() + seconds; player.seekTo(newTime, true); }
function trackProgress() { clearInterval(progressInterval); progressInterval = setInterval(updateVideoTimeDisplay, 250); }
function setupProgressBar() { document.getElementById("progressBar").addEventListener("click", function (e) { if (!player || !player.seekTo || !totalVideoDuration) return; const rect = e.currentTarget.getBoundingClientRect(); const clickPosition = (e.clientX - rect.left) / rect.width; player.seekTo(clickPosition * totalVideoDuration, true); }); }
function formatTime(s) { const m = Math.floor(s / 60).toString().padStart(2, '0'); const sec = Math.round(s % 60).toString().padStart(2, '0'); return isNaN(m) || isNaN(sec) ? "00:00" : `${m}:${sec}` }

function updateVideoTimeDisplay() { 
    if (!player || typeof player.getCurrentTime !== 'function') return; 
    const rawCurrentTime = player.getCurrentTime(); 
    const effectiveCurrentTime = rawCurrentTime / currentPlaybackRate; 
    const effectiveTotalDuration = totalVideoDuration / currentPlaybackRate; 
    document.getElementById("progress-fill").style.width = (rawCurrentTime / totalVideoDuration) * 100 + "%"; 
    document.getElementById('current-time').innerText = formatTime(effectiveCurrentTime); 
    document.getElementById('total-time').innerText = formatTime(effectiveTotalDuration); 
}

function setPlayerLoading(isLoading) { document.getElementById('player-loader').style.display = isLoading ? 'flex' : 'none'; document.querySelectorAll('#player-view button, #player-view select').forEach(el => { if (el.id !== 'startTranscriptionBtn') el.disabled = isLoading; }); document.getElementById('startTranscriptionBtn').disabled = true; if (!isLoading) document.getElementById('startTranscriptionBtn').disabled = false; }
function setupExtraControls() { document.getElementById('volume-slider').addEventListener('input', (e) => player?.setVolume(e.target.value)); document.addEventListener('keydown', (e) => { if (document.getElementById('player-view').style.display === 'block') { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); togglePlay(); } if (e.code === 'ArrowLeft') { e.preventDefault(); seekRelative(-5); } if (e.code === 'ArrowRight') { e.preventDefault(); seekRelative(5); } } }); const today = new Date(); document.getElementById('exam-date').innerHTML = `<b>Exam Date:</b> ${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`; }

// --- Result Processing and Display ---
function escapeHtml(s = "") { return s.toString().replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

function renderResultSheet(analysisResult, isReevaluation = false) {
    g_lastAnalysisResult = analysisResult; 

    if (isReevaluation) {
        const reevalContainer = document.getElementById('reevaluated-accuracy-container');
        if (reevalContainer) {
            reevalContainer.innerHTML = `<div class="stats-row"><div class="stat-pill" style="background-color: var(--accent-purple);">Re-evaluated Accuracy: ${analysisResult.accuracy.toFixed(2)}%</div></div>`;
        }
        document.getElementById('editableTypedText').innerHTML = analysisResult.resultHTML;
        let originalTextHtml = analysisResult.originalWords.map((word, index) => `<span class="word-wrapper" data-index="${index}">${escapeHtml(word)}</span>`).join(' ');
        document.getElementById('editableOriginalText').innerHTML = originalTextHtml;
        initializeResultInteractivity();

    } else {
        const container = document.getElementById('resultSheetContainer');
        const dictationName = `Kailash Chandra - Volume ${g_vol.replace('vol', '')} / Transcript ${g_tran.replace('t', '')}`;
        const testDate = new Date().toLocaleString('en-IN', { dateStyle: 'long', timeStyle: 'short' });
        const { mistakeCounters, halfBucketCount, totalWordsP1, totalWordsP2, percentageDiff, accuracy } = analysisResult;
        
        const timeTakenMinutes = (transcriptionTimerTotalTime - timeLeft) / 60;
        const wpm = timeTakenMinutes > 0 ? (totalWordsP2 / timeTakenMinutes).toFixed(2) : "0.00";
        analysisResult.wpm = wpm; 

        const fullMistakesCount = (mistakeCounters.addition || 0) + (mistakeCounters.omission || 0);

        let originalTextHtml = analysisResult.originalWords.map((word, index) => `<span class="word-wrapper" data-index="${index}">${escapeHtml(word)}</span>`).join(' ');

        container.innerHTML = `
        <div class="result-sheet-container">
            <h1>Result Sheet:</h1>
            <div class="stats-container">
                <div class="stats-row"><div class="stat-pill full-width">${escapeHtml(dictationName)}</div></div>
                <div class="stats-row">
                    <div class="stat-pill">Total words: ${totalWordsP1}</div>
                    <div class="stat-pill">Typed words: ${totalWordsP2}</div>
                    <div class="stat-pill">Typing Speed: ${wpm} WPM</div>
                </div>
                <div class="stats-row">
                    <div class="stat-pill red">Full Mistakes: ${fullMistakesCount}</div>
                    <div class="stat-pill amber">Half Mistakes: ${halfBucketCount}</div>
                    <div class="stat-pill">Total % of Mistakes: ${percentageDiff.toFixed(2)}%</div>
                    <div class="stat-pill">Accuracy: ${accuracy.toFixed(2)}%</div>
                </div>
                <div id="reevaluated-accuracy-container"></div>
                <div class="stats-row"><div class="stat-pill">Test Date: ${escapeHtml(testDate)}</div></div>
            </div>
            <div class="legend-container" id="interactive-legend">
                <div class="legend-item" data-filter-type="omission"><span class="legend-color-box" style="background-color: var(--hl-omissions);"></span>Omissions<span class="mistake-count"></span></div>
                <div class="legend-item" data-filter-type="addition"><span class="legend-color-box" style="background-color: var(--hl-additions);"></span>Additions<span class="mistake-count"></span></div>
                <div class="legend-item" data-filter-type="spelling"><span class="legend-color-box" style="background-color: var(--hl-spelling);"></span>Spelling<span class="mistake-count"></span></div>
                <div class="legend-item" data-filter-type="capitalization"><span class="legend-color-box" style="background-color: var(--hl-capitalization);"></span>Capitalization<span class="mistake-count"></span></div>
                <div class="legend-item" data-filter-type="punctuation"><span class="legend-color-box" style="background-color: var(--hl-punctuation);"></span>Punctuation<span class="mistake-count"></span></div>
                <button id="reset-filter-btn" class="view-switch-btn">Show All</button>
            </div>
            <div class="result-controls">
                <div class="action-section">
                    <button id="deepAnalysisBtn" class="view-switch-btn">Deep Analysis</button>
                    <div class="reevaluate-wrapper">
                        <button id="toggleReevaluateBtn" class="view-switch-btn">Enter Re-evaluate Mode</button>
                        <span class="tooltip-icon" data-tooltip="Enter a special mode to edit BOTH your text and the original text, then recalculate your score to see the difference.">?</span>
                    </div>
                    <button id="reportErrorBtn" class="view-switch-btn" style="background-color: #f97316; color: white;">Report Error</button>
                </div>
                <button id="viewSwitchBtn" class="view-switch-btn">Switch to Side-by-Side View</button>
            </div>
            <div id="comparisonColumns" class="columns view-top-bottom">
                <div class="col" id="typedCol"><strong>Your Transcription:</strong><p id="editableTypedText" contenteditable="false">${analysisResult.resultHTML}</p></div>
                <div class="col" id="originalCol"><strong>Original Text:</strong><p id="editableOriginalText" contenteditable="false">${originalTextHtml}</p></div>
            </div>
        </div>`;

        if (!localStorage.getItem('hideResultsWelcome')) document.getElementById('resultsWelcomeModal').classList.add('visible');

        document.getElementById('viewSwitchBtn').addEventListener('click', () => {
            const columnsContainer = document.getElementById('comparisonColumns');
            const isTopBottom = columnsContainer.classList.contains('view-top-bottom');
            if (isTopBottom) {
                columnsContainer.classList.remove('view-top-bottom');
                columnsContainer.classList.add('view-side-by-side');
                document.getElementById('viewSwitchBtn').textContent = 'Switch to Top/Bottom View';
            } else {
                columnsContainer.classList.remove('view-side-by-side');
                columnsContainer.classList.add('view-top-bottom');
                document.getElementById('viewSwitchBtn').textContent = 'Switch to Side-by-Side View';
            }
        });
        document.getElementById('printReportBtn').addEventListener('click', () => window.print());
        initializeResultInteractivity();
    }
}

function submitTranscription() {
    aiMistakesCache = null; 
    const timeTakenSeconds = (transcriptionTimerTotalTime - timeLeft) > 0 ? (transcriptionTimerTotalTime - timeLeft) : 0;
    clearState();
    if (document.fullscreenElement) document.exitFullscreen().catch(() => {});

    try {
        if (!originalText) throw new Error("Original transcript not found.");
        const typedText = document.getElementById('typingBox').value;
        g_lastTypedText = typedText;

        if (typedText.trim().split(/\s+/).filter(Boolean).length < 10) {
            alert("Please type at least 10 words.");
            goHome();
            return;
        }

        let textForAnalysis = originalText;
        if (g_selectedTarget !== "full") {
            let targetWords = parseInt(g_selectedTarget);
            let safeLimit = targetWords + 50;
            let wordsArray = originalText.trim().split(/\s+/);
            if (safeLimit < wordsArray.length) textForAnalysis = wordsArray.slice(0, safeLimit).join(" ");
        }

        document.getElementById('fullPageLoader').style.display = 'flex';
        const config = getCurrentConfigForWorker();
        
        analysisWorker.postMessage({
            originalText: textForAnalysis,
            userText: g_lastTypedText,
            config: config, 
            synonymData: g_synonymData 
        });

        analysisWorker.onmessage = function(event) {
            const analysisResult = event.data;
            document.getElementById('fullPageLoader').style.display = 'none';
            showView('results-view');
            renderResultSheet(analysisResult, false);
            saveProgressToLocalStorage(analysisResult);
            saveAttemptHybrid(originalText, typedText, analysisResult);
            resetTimer();
        };

        analysisWorker.onerror = function(error) {
            document.getElementById('fullPageLoader').style.display = 'none';
            showErrorModal("Result Error", "Error in analysis worker.");
            goHome();
        };

    } catch (error) {
        document.getElementById('fullPageLoader').style.display = 'none';
        showErrorModal("Result Error", "An error occurred.");
        goHome();
    }
}

// --- Data Saving and Progress ---
function saveProgressToLocalStorage(resultData) {
    if (!candidateId) return;
    const key = `${g_vol}-${g_tran}`;
    const progressData = JSON.parse(localStorage.getItem(`kcProgress_${candidateId}`) || '{}');
    const newScore = { accuracy: parseFloat(resultData.accuracy), wpm: parseFloat(resultData.wpm) };
    const existingScore = progressData[key];
    if (!existingScore || newScore.accuracy > existingScore.accuracy) {
        progressData[key] = newScore;
        localStorage.setItem(`kcProgress_${candidateId}`, JSON.stringify(progressData));
    }
    localStorage.setItem(`kcLastAttempt_${candidateId}`, JSON.stringify({ vol: g_vol, tran: g_tran }));
}

async function resetProgress() {
    if (!candidateId) return;
    localStorage.removeItem(`kcProgress_${candidateId}`);
    localStorage.removeItem(`kcLastAttempt_${candidateId}`);
    localStorage.removeItem('hideResultsWelcome');
    try {
        await localDb.attempts.clear();
        await localDb.overallStats.clear();
        await localDb.mistakeLibrary.clear();
        if (attemptsRef) {
            const querySnapshot = await attemptsRef.get();
            querySnapshot.forEach(doc => doc.ref.delete());
        }
        alert("Progress reset successfully.");
        window.location.reload();
    } catch (error) {
        showErrorModal("Reset Error", "Could not clear all data.");
    }
}

async function updateMistakeLibrary(studentMistakes) {
    if (!studentMistakes || !studentMistakes.spelling || studentMistakes.spelling.length === 0) return;
    await localDb.transaction('rw', localDb.mistakeLibrary, async () => {
        for (const mistake of studentMistakes.spelling) {
            const originalWord = (mistake.correct || '').replace(/[.,]$/, '').toLowerCase();
            const typedWord = (mistake.wrong || '').replace(/[.,]$/, '').toLowerCase();
            if (!originalWord || !typedWord || originalWord === typedWord) continue;
            const existingEntry = await localDb.mistakeLibrary.where({ originalWord, typedWord }).first();
            if (existingEntry) { await localDb.mistakeLibrary.update(existingEntry.id, { count: existingEntry.count + 1 }); }
            else { await localDb.mistakeLibrary.add({ originalWord, typedWord, count: 1 }); }
        }
    });
}

async function updateOverallStats(newAttemptStats) {
    await localDb.transaction('rw', localDb.overallStats, async () => {
        const stats = await localDb.overallStats.get(1);
        const accuracy = parseFloat(newAttemptStats.accuracy);
        const wpm = parseFloat(newAttemptStats.wpm);
        if (!stats) {
            await localDb.overallStats.put({ id: 1, totalAttempts: 1, bestAccuracy: accuracy, bestWPM: wpm, avgAccuracy: accuracy, avgWpm: wpm });
            return;
        }
        const newTotal = (stats.totalAttempts || 0) + 1;
        const newAvgAccuracy = ((stats.avgAccuracy * stats.totalAttempts) + accuracy) / newTotal;
        const newAvgWpm = ((stats.avgWpm * stats.totalAttempts) + wpm) / newTotal;
        await localDb.overallStats.put({ id: 1, totalAttempts: newTotal, avgAccuracy: newAvgAccuracy, avgWpm: newAvgWpm, bestAccuracy: Math.max(stats.bestAccuracy, accuracy), bestWPM: Math.max(stats.bestWPM, wpm) });
    });
}

async function saveAttemptHybrid(original, typed, analysisResult) {
    if (!candidateId) return;
    const fullMistakesCount = (analysisResult.mistakeCounters.addition || 0) + (analysisResult.mistakeCounters.omission || 0);
    const fullResultData = {
        timestamp: new Date().toISOString(),
        dictationName: `Kailash Chandra - Volume ${g_vol.replace('vol', '')} / Transcript ${g_tran.replace('t', '')}`,
        accuracy: parseFloat(analysisResult.accuracy),
        wpm: parseFloat(analysisResult.wpm),
        originalText: original,
        typedText: typed,
        fullMistakes: fullMistakesCount,
        halfMistakes: analysisResult.halfBucketCount,
        highlightedHtml: analysisResult.resultHTML,
    };
    try {
        await localDb.attempts.add(fullResultData);
        await updateOverallStats(analysisResult);
        await updateMistakeLibrary(analysisResult.studentMistakes);
        await sendLightweightStatsToFirebase(analysisResult);
    } catch (err) {
        console.error("‚ùå Failed to save attempt:", err);
    }
}

async function sendLightweightStatsToFirebase(analysisResult) {
    if (!attemptsRef) return;
    const timeTakenSeconds = (transcriptionTimerTotalTime - timeLeft) > 0 ? (transcriptionTimerTotalTime - timeLeft) : 0;
    const lightweightStat = {
        accuracy: analysisResult.accuracy.toFixed(2) + "%",
        wpm: analysisResult.wpm,
        timeTakenSeconds: timeTakenSeconds,
        totalWords: analysisResult.totalWordsP1,
        volume: g_vol,
        transcript: g_tran,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    try { await attemptsRef.add(lightweightStat); } catch (e) { }
}

// --- Event Listeners and Interactivity ---
function initializeEventListeners() {
    document.getElementById('passage-grid').addEventListener('click', (e) => {
        const button = e.target.closest('.take-test-btn');
        if (button) { const card = button.closest('.passage-card'); loadPractice(card.dataset.volume, card.dataset.transcript); }
    });
    document.getElementById('passageSearch').addEventListener('input', debounce(renderGrid, 300));
    document.getElementById('filter-select').addEventListener('change', renderGrid);
    document.getElementById('sort-select').addEventListener('change', renderGrid);
    document.getElementById('startFirstTestBtn').addEventListener('click', () => document.querySelector('.passage-card .take-test-btn')?.click());
    document.getElementById('error-close-btn').addEventListener('click', () => document.getElementById('error-modal').classList.remove('visible'));

    const resetModal = document.getElementById('resetConfirmModal');
    document.getElementById('resetProgressBtn').addEventListener('click', () => resetModal.classList.add('visible'));
    document.getElementById('cancelResetBtn').addEventListener('click', () => resetModal.classList.remove('visible'));
    document.getElementById('confirmResetBtn').addEventListener('click', () => { resetProgress(); resetModal.classList.remove('visible'); });

    const welcomeModal = document.getElementById('resultsWelcomeModal');
    document.getElementById('closeWelcomeBtn').addEventListener('click', () => { if (document.getElementById('dontShowAgainCheckbox').checked) localStorage.setItem('hideResultsWelcome', 'true'); welcomeModal.classList.remove('visible'); });

    const reportModal = document.getElementById('reportErrorModal');
    document.getElementById('cancelReportBtn').addEventListener('click', () => reportModal.classList.remove('visible'));
    document.getElementById('submitReportBtn').addEventListener('click', submitErrorReport);
    document.getElementById('errorTypeSelect').addEventListener('change', validateReportForm);
    document.getElementById('otherErrorText').addEventListener('input', validateReportForm);
    document.getElementById('closeDeepAnalysisBtn').addEventListener('click', () => document.getElementById('deepAnalysisModal').classList.remove('visible'));
}

function initializeResultInteractivity() {
    const container = document.getElementById('resultSheetContainer');
    if (!container) return;

    document.getElementById('toggleReevaluateBtn').addEventListener('click', toggleReevaluateMode);
    document.getElementById('reportErrorBtn').addEventListener('click', showReportModal);
    document.getElementById('deepAnalysisBtn').addEventListener('click', showDeepAnalysisModal);
    
    initializeInteractiveLegend();
    
    // PERMANENT LISTENER: Attach to resultSheetContainer so it persists
    container.removeEventListener('click', aiIconClickHandler);
    container.addEventListener('click', aiIconClickHandler);
}

function aiIconClickHandler(e) {
    const icon = e.target.closest('.ai-icon');
    if (!icon) return;

    const highlight = icon.closest('.highlight');
    if (!highlight) return;

    e.stopPropagation();
    const type = highlight.dataset.mistakeType;

    let originalWord = highlight.getAttribute('data-correct') || "unknown";
    let typedWord = highlight.getAttribute('data-wrong') || "unknown";

    // Clean up if worker didn't provide specific attributes
    if (originalWord === "unknown") {
        const index = highlight.closest('.word-wrapper')?.dataset.index;
        const originalWordEl = document.querySelector(`#originalCol .word-wrapper[data-index="${index}"]`);
        if (originalWordEl) originalWord = originalWordEl.innerText.trim().replace(/[^\w\s-]/g, '');
    }

    triggerAiAnalysis(originalWord, typedWord, type);
}

function openTranscriptModal() {
    document.getElementById('transcriptTextBody').innerText = originalText;
    document.getElementById('transcriptModal').classList.add('visible');
    if(player && player.getPlayerState() === YT.PlayerState.PLAYING) player.pauseVideo();
}

function toggleReevaluateMode() {
    isReevaluateModeActive = !isReevaluateModeActive;
    const resultsView = document.getElementById('results-view');
    const toggleBtn = document.getElementById('toggleReevaluateBtn');
    const typedTextP = document.getElementById('editableTypedText');
    const originalTextP = document.getElementById('editableOriginalText');

    if (isReevaluateModeActive) {
        resultsView.classList.add('reevaluate-mode-active');
        toggleBtn.textContent = 'Calculate & Exit Mode';
        toggleBtn.style.backgroundColor = 'var(--accent-purple)'; 
        toggleBtn.style.color = 'white';
        typedTextP.innerHTML = g_lastAnalysisResult.userWords.join(' ');
        originalTextP.innerHTML = g_lastAnalysisResult.originalWords.join(' ');
        typedTextP.contentEditable = true; 
        originalTextP.contentEditable = true;
    } else {
        resultsView.classList.remove('reevaluate-mode-active');
        toggleBtn.textContent = 'Enter Re-evaluate Mode';
        toggleBtn.style.backgroundColor = ''; 
        toggleBtn.style.color = '';
        const correctedOriginalText = originalTextP.innerText;
        const correctedTypedText = typedTextP.innerText;
        g_lastTypedText = correctedTypedText;
        typedTextP.contentEditable = false; 
        originalTextP.contentEditable = false;
        if (!correctedOriginalText) {
            renderResultSheet(g_lastAnalysisResult, true);
            return;
        }
        document.getElementById('fullPageLoader').style.display = 'flex';
        const config = getCurrentConfigForWorker();
        analysisWorker.postMessage({
            originalText: correctedOriginalText,
            userText: correctedTypedText,
            config: config,
            synonymData: g_synonymData
        });
        analysisWorker.onmessage = function(event) {
            document.getElementById('fullPageLoader').style.display = 'none';
            renderResultSheet(event.data, true);
        };
    }
}

async function submitErrorReport() {
    const reportData = {
        candidateId: candidateId,
        volume: g_vol,
        transcript: g_tran,
        originalTextInSystem: originalText,
        userCorrectedText: document.getElementById('editableOriginalText').innerText,
        reason: `${document.getElementById('errorTypeSelect').value}: ${document.getElementById('otherErrorText').value}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        await db.collection("transcriptionReports").add(reportData);
        alert("Report submitted successfully.");
        document.getElementById('reportErrorModal').classList.remove('visible');
    } catch (error) {
        alert("Could not submit report.");
    }
}

function debounce(func, delay) { let timeout; return function (...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
function showErrorModal(title, message) { document.getElementById('error-title').textContent = title; document.getElementById('error-message').textContent = message; document.getElementById('error-modal').classList.add('visible'); }

function renderQuickResume() {
    const container = document.getElementById('quick-resume-container');
    container.innerHTML = '';
    const lastAttempt = JSON.parse(localStorage.getItem(`kcLastAttempt_${candidateId}`));
    if (lastAttempt && allPassageData.length > 0) {
        const { vol, tran } = lastAttempt;
        const currentPassage = allPassageData.find(p => p.volId === vol && p.tranId === tran);
        if (!currentPassage) return;
        const nextPassage = allPassageData.find(p => p.transcriptNumber === currentPassage.transcriptNumber + 1);
        const box = document.createElement('div');
        box.className = 'quick-resume-box';
        box.innerHTML = `<h3>Resume Practice</h3><p>Last attempt: <strong>Passage ${currentPassage.transcriptNumber}</strong></p><div class="intro-actions"><button id="resume-again-btn">Again</button>${nextPassage ? `<button id="resume-next-btn">Next (${nextPassage.transcriptNumber})</button>` : ''}</div>`;
        container.appendChild(box);
        document.getElementById('resume-again-btn').addEventListener('click', () => loadPractice(vol, tran));
        if (nextPassage) document.getElementById('resume-next-btn').addEventListener('click', () => loadPractice(nextPassage.volId, nextPassage.tranId));
    }
}

function initializeInteractiveLegend() {
    const legendContainer = document.getElementById('interactive-legend');
    if (!legendContainer || !g_lastAnalysisResult) return;
    const counters = g_lastAnalysisResult.mistakeCounters;
    const mistakeMap = {
        omission: counters.omission || 0,
        addition: counters.addition || 0,
        spelling: counters.spelling || 0,
        capitalization: counters.capitalization || 0,
        punctuation: (counters.punctuation.fullstop || 0) + (counters.punctuation.other || 0),
    };
    legendContainer.querySelectorAll('.legend-item').forEach(item => {
        item.querySelector('.mistake-count').textContent = `(${(mistakeMap[item.dataset.filterType] || 0)})`;
    });
    legendContainer.addEventListener('click', function(e) {
        const clickedItem = e.target.closest('.legend-item');
        if (!clickedItem) return;
        legendContainer.querySelectorAll('.legend-item').forEach(item => { if(item !== clickedItem) item.classList.remove('active'); });
        clickedItem.classList.toggle('active');
        applyFilters();
    });
    document.getElementById('reset-filter-btn').addEventListener('click', () => {
        legendContainer.querySelectorAll('.legend-item').forEach(item => item.classList.remove('active'));
        applyFilters();
    });
}

function applyFilters() {
    const activeFilters = Array.from(document.querySelectorAll('#interactive-legend .legend-item.active')).map(item => item.dataset.filterType);
    document.querySelectorAll('#editableTypedText .mis').forEach(el => {
        let isVisible = activeFilters.length === 0;
        if(!isVisible) {
            for(const filter of activeFilters) { if(el.classList.contains(filter)) { isVisible = true; break; } }
        }
        el.classList.toggle('hidden-mistake', !isVisible);
    });
}

function showDeepAnalysisModal() {
    if (!g_lastAnalysisResult) return;
    const { spelling, capitalisation, replacements } = g_lastAnalysisResult.studentMistakes;
    const tableBody = document.getElementById('deep-analysis-table-body');
    let rows = '';
    const mistakes = [
        ...spelling.map(m => ({ type: 'Spelling', wrong: m.wrong, correct: m.correct })),
        ...capitalisation.map(m => ({ type: 'Capitalization', wrong: m.wrong, correct: m.correct })),
        ...replacements.map(m => ({ type: 'Replacement', wrong: m.added, correct: m.omitted }))
    ];
    if (mistakes.length === 0) { rows = '<tr><td colspan="3" style="text-align:center;">No complex mistakes found.</td></tr>'; }
    else { mistakes.forEach(m => { rows += `<tr><td><strong>${m.type}</strong></td><td>${escapeHtml(m.wrong)}</td><td>${escapeHtml(m.correct)}</td></tr>`; }); }
    tableBody.innerHTML = rows;
    document.getElementById('deepAnalysisModal').classList.add('visible');
}

function validateReportForm() {
    const type = document.getElementById('errorTypeSelect').value;
    const text = document.getElementById('otherErrorText').value.trim();
    document.getElementById('submitReportBtn').disabled = !(type && text);
}

// ==========================================
// üß† AI INTEGRATION MODULE (Stable Backend)
// ==========================================

// PASTE YOUR GOOGLE SCRIPT URL HERE ‚Üì
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzw3pJIzS70de9tPcOlB53rHwjMzD9rficgN951XF0LptzZigJ5ngRNY2FgIv2PXmmE/exec"; 

let aiMistakesCache = null; 
let isAiFetching = false;

// 1. Trigger Analysis
async function triggerAiAnalysis(original, typed, type) {
    const modal = document.getElementById('aiModal');
    const content = document.getElementById('aiModalContent');
    const loader = document.getElementById('aiLoadingState');
    
    modal.classList.add('visible');
    const cacheKey = `${original}_${typed}`;
    
    if (aiMistakesCache && aiMistakesCache[cacheKey]) {
        renderAiResult(aiMistakesCache[cacheKey], original, typed);
        return;
    }

    if (isAiFetching) {
        content.style.display = 'none';
        loader.style.display = 'block';
        return;
    }

    isAiFetching = true;
    content.style.display = 'none';
    loader.style.display = 'block';

    try {
        const mistakesList = prepareMistakesList();
        if (mistakesList.length === 0) throw new Error("No complex mistakes to analyze.");

        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ mistakes: mistakesList })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || "AI Error");

        const cleanJson = data.reply.replace(/```json/g, '').replace(/```/g, '').trim();
        aiMistakesCache = JSON.parse(cleanJson);

        if (aiMistakesCache[cacheKey]) renderAiResult(aiMistakesCache[cacheKey], original, typed);
        else renderAiResult("AI Teacher says: Please double-check the spelling or capitalization of this word against the original transcript.", original, typed);

    } catch (error) {
        content.style.display = 'block';
        content.innerHTML = `<p style="color:#ef4444;">AI Analysis currently unavailable. Error: ${error.message}</p>`;
    } finally {
        isAiFetching = false;
        loader.style.display = 'none';
        content.style.display = 'block';
    }
}

function prepareMistakesList() {
    if (!g_lastAnalysisResult || !g_lastAnalysisResult.studentMistakes) return [];
    const sm = g_lastAnalysisResult.studentMistakes;
    const list = [];
    if (sm.spelling) sm.spelling.forEach(m => list.push({ Original: m.correct, Typed: m.wrong }));
    if (sm.capitalisation) sm.capitalisation.forEach(m => list.push({ Original: m.correct, Typed: m.wrong }));
    return list.slice(0, 25);
}

function renderAiResult(explanation, orig, typed) {
    const content = document.getElementById('aiModalContent');
    content.innerHTML = `
        <div class="ai-mistake-context">
            Original: <b style="color:#16a34a">${orig}</b> | Typed: <b style="color:#dc2626">${typed}</b>
        </div>
        <div>
            <span class="ai-rule-badge">Teacher Insight</span>
            <p class="ai-explanation-text">${explanation}</p>
        </div>
    `;
}

</script>
</body>
</html>
