<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Study Live | Digital Classroom</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root { --bg: #0f172a; --card: #1e293b; --accent: #6366f1; --success: #10b981; --text: #f8fafc; }
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
.hide { display: none !important; }

/* Layout */
.app-wrapper { display: flex; flex-direction: row; height: 100vh; overflow: hidden; }
.main-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
.sidebar { width: 320px; background: #161e2e; border-left: 1px solid #334155; padding: 20px; overflow-y: auto; }

/* Classroom Grid */
.classroom-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 15px; width: 100%; max-width: 900px; margin-top: 20px;
}
.desk { 
    background: var(--card); border: 1px solid #334155; border-radius: 12px; 
    padding: 15px; text-align: center; position: relative; transition: 0.3s;
}
.desk.live { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.1); }
.desk .avatar { width: 45px; height: 45px; border-radius: 50%; margin-bottom: 8px; border: 2px solid #334155; }
.desk .name { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.desk .exam { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;}
.desk .timer { font-family: monospace; font-size: 14px; font-weight: bold; color: var(--accent); }

/* Sidebar UI */
.leaderboard-item { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid #1f2937; }
.rank { font-weight: 900; color: #4b5563; width: 20px; }

/* Pulse Animation */
.pulse-dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }

/* Login & Onboarding Modals */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
.modal-card { background: var(--card); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #334155; }
.input-group { text-align: left; margin-bottom: 15px; }
.input-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; outline: none; }
.btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
.btn-primary { background: var(--accent); color: white; }
.btn-success { background: var(--success); color: white; margin-bottom: 10px;}

@media (max-width: 768px) {
    .app-wrapper { flex-direction: column; overflow-y: auto; height: auto; }
    .sidebar { width: 100%; border-left: none; border-top: 1px solid #334155; }
}
</style>
</head>
<body>

<!-- 1. LOGIN SCREEN -->
<div id="loginOverlay" class="modal-overlay">
    <div class="modal-card">
        <h1>ðŸ“š Study Live</h1>
        <p style="color: #94a3b8">Enter the Global Library</p>
        <button class="btn btn-primary" id="googleLoginBtn">Sign in with Google</button>
    </div>
</div>

<!-- 2. ONBOARDING SCREEN -->
<div id="onboardOverlay" class="modal-overlay hide">
    <div class="modal-card">
        <h2>Who are you?</h2>
        <p style="color: #94a3b8; margin-bottom: 20px;">Let others know who's studying</p>
        <div class="input-group">
            <label>DISPLAY NAME</label>
            <input type="text" id="userNameInput" placeholder="Enter your name">
        </div>
        <div class="input-group">
            <label>WHICH EXAM?</label>
            <input type="text" id="userExamInput" placeholder="e.g., UPSC, JEE, SAT, Finals">
        </div>
        <button class="btn btn-primary" id="joinClassBtn">Join Classroom</button>
    </div>
</div>

<!-- 3. MAIN APP -->
<div id="appContainer" class="app-wrapper hide">
    <div class="main-content">
        <div class="modal-card" style="max-width: 500px; margin-bottom: 0;">
            <div id="statusHeader">Ready to start?</div>
            <div class="time" id="mainClock" style="font-size: 4rem; margin: 10px 0;">00:00:00</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" id="startBtn">START STUDYING</button>
                <button class="btn" id="stopBtn" style="background:#ef4444; color:white;" class="hide">STOP</button>
            </div>
        </div>

        <div class="classroom-grid" id="classroomGrid">
            <!-- Desks will appear here -->
        </div>
    </div>

    <!-- Sidebar Leaderboard -->
    <div class="sidebar">
        <h3>Top Focused Today</h3>
        <div id="sidebarList"></div>
        <button id="logoutBtn" style="margin-top: 20px; background: none; border: none; color: #64748b; cursor: pointer;">Logout</button>
    </div>
</div>

<!-- 4. ACTIVITY CHECK -->
<div id="activityCheck" class="modal-overlay hide">
    <div class="modal-card" style="max-width: 320px;">
        <h3>Taking a break?</h3>
        <p>Confirm you are still here in <span id="checkCountdown" style="color:#ef4444; font-weight:bold;">120</span>s</p>
        <button class="btn btn-primary" id="stillHereBtn">I'm still studying!</button>
    </div>
</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyAUnOQq5DvNnnacfzBLRlKaP5Oh2W7fQ1Y",
  authDomain: "study-live-cdc81.firebaseapp.com",
  projectId: "study-live-cdc81",
  storageBucket: "study-live-cdc81.firebasestorage.app",
  messagingSenderId: "656676120180",
  appId: "1:656676120180:web:7ea85f6e650b132e39d321"
});

const db = firebase.firestore();
const auth = firebase.auth();

/* STATE */
let userBank = 0;
let sessionStart = null;
let isLive = false;
let communityMap = {};
let myName = "", myExam = "";
let activityTimer, countdownInterval;

/* LOGIN & ONBOARDING LOGIC */
document.getElementById("googleLoginBtn").onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
document.getElementById("logoutBtn").onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById("loginOverlay").classList.add("hide");
        checkOnboarding(user);
    } else {
        document.getElementById("loginOverlay").classList.remove("hide");
        document.getElementById("appContainer").classList.add("hide");
    }
});

function checkOnboarding(user) {
    const today = new Date().toISOString().slice(0,10);
    db.collection("daily_leaderboard").doc(today).get().then(doc => {
        const data = doc.data();
        if(data && data.users && data.users[user.uid]) {
            const me = data.users[user.uid];
            myName = me.n;
            myExam = me.e;
            enterClassroom();
        } else {
            document.getElementById("onboardOverlay").classList.remove("hide");
            document.getElementById("userNameInput").value = user.displayName;
        }
    });
}

document.getElementById("joinClassBtn").onclick = () => {
    myName = document.getElementById("userNameInput").value;
    myExam = document.getElementById("userExamInput").value;
    if(!myName || !myExam) return alert("Fill both fields!");
    document.getElementById("onboardOverlay").classList.add("hide");
    enterClassroom();
};

function enterClassroom() {
    document.getElementById("appContainer").classList.remove("hide");
    startListening();
}

/* SYNC & DATABASE */
async function sync(status) {
    const user = auth.currentUser;
    const today = new Date().toISOString().slice(0,10);
    const docRef = db.collection("daily_leaderboard").doc(today);

    let total = userBank;
    if(status && sessionStart) total += Math.floor((Date.now() - sessionStart) / 1000);

    const data = {};
    data[`users.${user.uid}`] = {
        n: myName,
        e: myExam,
        p: user.photoURL,
        s: total,
        st: status ? firebase.firestore.FieldValue.serverTimestamp() : null,
        live: status
    };

    try {
        await docRef.update(data);
    } catch(e) {
        await docRef.set({ users: {} }, { merge: true });
        await docRef.update(data);
    }
}

/* SESSION BUTTONS */
document.getElementById("startBtn").onclick = async () => {
    isLive = true; sessionStart = Date.now();
    document.getElementById("startBtn").classList.add("hide");
    document.getElementById("stopBtn").classList.remove("hide");
    document.getElementById("statusHeader").innerText = "YOU ARE IN THE ZONE";
    await sync(true);
    triggerActivityTimer();
};

document.getElementById("stopBtn").onclick = async () => {
    if(!isLive) return;
    userBank += Math.floor((Date.now() - sessionStart) / 1000);
    isLive = false;
    document.getElementById("startBtn").classList.remove("hide");
    document.getElementById("stopBtn").classList.add("hide");
    document.getElementById("statusHeader").innerText = "Ready to start?";
    clearTimeout(activityTimer);
    clearInterval(countdownInterval);
    document.getElementById("activityCheck").classList.add("hide");
    await sync(false);
};

/* LEADERBOARD & GRID */
function startListening() {
    const today = new Date().toISOString().slice(0,10);
    db.collection("daily_leaderboard").doc(today).onSnapshot(doc => {
        if(!doc.exists) return;
        communityMap = doc.data().users || {};
        const me = communityMap[auth.currentUser.uid];
        if(me && !isLive) userBank = me.s;
    });
}

setInterval(() => {
    const now = Math.floor(Date.now() / 1000);
    if(isLive) document.getElementById("mainClock").innerText = formatTime(userBank + (now - Math.floor(sessionStart/1000)));

    const users = Object.values(communityMap);
    if(!users.length) return;

    // Sort for Leaderboard (Sidebar)
    const sorted = [...users].sort((a,b) => {
        const tA = a.s + (a.live && a.st ? (now - a.st.seconds) : 0);
        const tB = b.s + (b.live && b.st ? (now - b.st.seconds) : 0);
        return tB - tA;
    });

    // Render Grid & Sidebar
    let gridHTML = "";
    let sidebarHTML = "";

    sorted.forEach((u, i) => {
        const time = u.s + (u.live && u.st ? (now - u.st.seconds) : 0);
        
        // Grid Card (Desk)
        gridHTML += `
            <div class="desk ${u.live ? 'live' : ''}">
                ${u.live ? '<div class="pulse-dot"></div>' : ''}
                <img src="${u.p}" class="avatar">
                <div class="name">${u.n}</div>
                <div class="exam">${u.e}</div>
                <div class="timer">${formatTime(time)}</div>
            </div>
        `;

        // Sidebar Row
        sidebarHTML += `
            <div class="leaderboard-item">
                <div class="rank">#${i+1}</div>
                <img src="${u.p}" style="width:25px; border-radius:50%">
                <div style="flex:1; font-size:13px;">${u.n}</div>
                <div style="font-size:12px; font-family:monospace; color:var(--accent)">${formatTime(time)}</div>
            </div>
        `;
    });

    document.getElementById("classroomGrid").innerHTML = gridHTML;
    document.getElementById("sidebarList").innerHTML = sidebarHTML;
}, 1000);

/* ACTIVITY CHECK */
function triggerActivityTimer() {
    clearTimeout(activityTimer);
    activityTimer = setTimeout(() => {
        document.getElementById("activityCheck").classList.remove("hide");
        let left = 120;
        countdownInterval = setInterval(() => {
            left--;
            document.getElementById("checkCountdown").innerText = left;
            if(left <= 0) document.getElementById("stopBtn").onclick();
        }, 1000);
    }, 3600000); // 1 Hour
}

document.getElementById("stillHereBtn").onclick = () => {
    document.getElementById("activityCheck").classList.add("hide");
    clearInterval(countdownInterval);
    triggerActivityTimer();
};

/* HELPERS */
function formatTime(s) {
    if(s < 0) s = 0;
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sc = s%60;
    return [h,m,sc].map(v => String(v).padStart(2,'0')).join(':');
}
</script>
</body>
</html>
