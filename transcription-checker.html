<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex">
  <title>Modern Transcription Checker</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- 1. Global & Base Styles --- */
    :root {
      --bg-main: #f8fafc;
      --surface-card: #ffffff;
      --surface-light: #f1f5f9;
      --border-subtle: #e2e8f0;
      --text-header: #1e293b; 
      --text-body: #334155;
      --text-muted: #64748b;
      --primary-accent: #00796b; /* Teal Accent */
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-main);
      color: var(--text-body);
      padding: 20px;
      line-height: 1.6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .hidden { display: none !important; }

    .main-container {
      width: 100%;
      max-width: 900px;
      margin: 30px auto;
      background: var(--surface-card);
      padding: 40px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    #mainTitle {
      font-size: 2.5em;
      font-weight: 800;
      color: var(--text-header);
      text-align: center;
      margin-bottom: 35px;
    }
    
    /* --- 2. Choice Section --- */
    #choiceSection {
        text-align: center;
    }
    .choice-btn-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    .primary-btn, .secondary-btn {
        padding: 15px 25px;
        font-size: 1.1em;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }
    .primary-btn {
        background-color: var(--primary-accent);
        color: white;
    }
    .primary-btn:hover {
        background-color: #004d40;
        transform: translateY(-2px);
    }
    .secondary-btn {
        background-color: transparent;
        color: var(--primary-accent);
        border-color: var(--primary-accent);
    }
    .secondary-btn:hover {
        background-color: #e0f2f1; /* Light teal */
    }

    /* --- 3. Player & Transcription Sections --- */
    .form-group {
        margin-bottom: 25px;
    }
    textarea, input[type="number"] {
      width: 100%;
      margin-top: 8px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      resize: vertical;
    }
     textarea:focus, input[type="number"]:focus {
        outline: none;
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.2);
    }
    label {
      font-weight: 600;
      font-size: 1.05em;
      color: var(--text-header);
      display: block;
    }
    
    .file-upload-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }
    #fileName {
        color: var(--text-muted);
        font-size: 0.9em;
    }

    .navigation-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }


    /* --- 4. Modern Audio Player --- */
    .modern-player {
        background: var(--surface-light);
        border-radius: 12px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 15px;
    }
    .play-pause-btn {
        background: var(--primary-accent);
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: white;
        transition: transform 0.2s;
    }
    .play-pause-btn:hover { transform: scale(1.1); }
    .play-pause-btn svg { width: 24px; height: 24px; }

    .time-display {
        font-weight: 500;
        color: var(--text-body);
        font-size: 0.95em;
        min-width: 90px;
        text-align: center;
    }
    .seek-slider { flex-grow: 1; }
    
    .volume-controls { 
        display: flex; 
        align-items: center; 
        gap: 8px;
    }
    .volume-controls svg {
        color: var(--text-muted);
        width: 22px;
        height: 22px;
    }
    .volume-slider { width: 80px; }

    /* Custom Range Slider Styles */
    input[type="range"] {
        -webkit-appearance: none; appearance: none;
        width: 100%; cursor: pointer; outline: none;
        height: 6px; background: var(--border-subtle); border-radius: 8px;
        margin-top: 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        height: 20px; width: 20px;
        background-color: var(--primary-accent);
        border-radius: 50%; border: none;
    }
    input[type="range"]::-moz-range-thumb {
        height: 20px; width: 20px;
        background-color: var(--primary-accent);
        border-radius: 50%; border: none;
    }
    
    /* --- 5. Result View --- */
    #modern-results-view h1 { font-size: 2.25em; font-weight: 800; margin-bottom: 25px; }
  </style>
</head>
<body>
    
  <audio id="audioPlayer" class="hidden"></audio> <!-- Global Hidden Audio Engine -->
    
  <div id="appContainer" class="main-container">
    
    <!-- VIEW 1: Initial Choice -->
    <div id="choiceSection">
        <h1 id="mainTitle">Modern Transcription Checker</h1>
        <p>How would you like to start?</p>
        <div class="choice-btn-group">
            <button id="useAudioBtn" class="primary-btn">Use Audio Dictation</button>
            <button id="useTextBtn" class="secondary-btn">Use Text Passage</button>
        </div>
    </div>

    <!-- VIEW 2: Audio Player Setup -->
    <div id="audioPlayerSection" class="hidden">
        <h1 id="mainTitle">Audio Setup</h1>
        <div class="form-group">
            <label for="audioUpload">1. Upload Audio Dictation:</label>
            <div class="file-upload-wrapper">
                <input type="file" id="audioUpload" accept="audio/*">
                <span id="fileName">No file chosen</span>
            </div>
            <div class="modern-player">
                <button class="play-pause-btn" id="playPauseBtn">
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" /></svg>
                    <svg id="pauseIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V5.25a.75.75 0 00-.75-.75h-1.5zm6.5 0a.75.75 0 00-.75.75v10.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V5.25a.75.75 0 00-.75-.75h-1.5z" /></svg>
                </button>
                <div class="time-display"><span id="currentTime">0:00</span> / <span id="totalDuration">0:00</span></div>
                <input type="range" class="seek-slider" id="seekSlider" value="0" step="1">
                <div class="volume-controls">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 4.06c0-1.34-1.61-2.26-2.79-1.59L5.15 6H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.15l5.56 3.53c1.18.67 2.79-.25 2.79-1.59v-12Zm-2.19 12.72-4.1-2.61A.99.99 0 0 0 6.5 14H5V9.92h1.5c.34 0 .67-.17.86-.45l4.1-2.6V16.78Z M19 12a5 5 0 0 0-3.54 8.54l-1.41-1.41A3 3 0 0 1 16 12a3 3 0 0 1-1.95-5.13l1.41-1.41A5 5 0 0 0 19 12Z" /></svg>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="1">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="wordCount">2. Number of Words in Dictation:</label>
            <input type="number" id="wordCount" placeholder="e.g., 1000">
        </div>
        <div class="form-group">
            <label for="speedControl">3. Set Desired Playback Speed:</label>
            <label for="speedControl" style="font-weight: normal; font-size: 1em; text-align: center; margin-top: 10px;">Speed: <span id="speedValue">100</span> WPM</label>
            <input type="range" id="speedControl" min="60" max="160" value="100" step="5">
        </div>
        <div class="navigation-buttons">
            <button id="backToChoiceBtn" class="secondary-btn">Go Back</button>
            <button id="startTranscriptionBtn" class="primary-btn">Start Transcription</button>
        </div>
    </div>

    <!-- VIEW 3: Transcription Input -->
    <div id="transcriptionSection" class="hidden">
        <h1 id="mainTitle">Transcription</h1>
        <div id="originalPassageContainer" class="form-group">
            <label for="original">Original Passage:</label>
            <textarea id="original" rows="6" placeholder="Paste the original text here..."></textarea>
        </div>
        <div class="form-group">
            <label for="typed">Your Transcription:</label>
            <textarea id="typed" rows="10" placeholder="Listen to the audio and type here..."></textarea>
        </div>
        <label style="font-weight: normal; display: inline-flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="includeComma"> Count comma (,) mistakes
        </label>
        <button id="submitButton" class="primary-btn" style="margin-top:20px;">Check Accuracy</button>
    </div>

    <!-- VIEW 4: Results -->
    <div id="modern-results-view" class="hidden">
        <!-- Results will be rendered here by JavaScript -->
    </div>
  </div>

<script>
    // --- Global State & Worker Setup ---
    let analysisWorker;
    if (window.Worker) {
        analysisWorker = new Worker('worker.js'); // Assuming worker.js is correct
        analysisWorker.onmessage = handleWorkerResult;
    } else {
        alert("Your browser does not support Web Workers.");
    }

    // --- Core Transcription Logic ---
    function submitTranscription() {
        const originalText = document.getElementById("original").value.trim();
        const typedText = document.getElementById("typed").value.trim();
        if (!originalText && !typedText) {
            return alert("Please fill in both the original and transcription text boxes.");
        }
        document.getElementById('submitButton').disabled = true;
        document.getElementById('submitButton').textContent = 'Calculating...';
        const options = { countCommaMistakes: document.getElementById("includeComma").checked };
        analysisWorker.postMessage({ originalText, typedText, timeTakenSeconds: 0, options });
    }

    function handleWorkerResult(event) {
        renderResultSheet(event.data);
        document.getElementById("transcriptionSection").classList.add("hidden");
        document.getElementById("modern-results-view").classList.remove("hidden");
        document.getElementById('submitButton').disabled = false;
        document.getElementById('submitButton').textContent = 'Check Accuracy';
    }

    // --- Audio Player Logic ---
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimeDisplay() {
        const audio = document.getElementById('audioPlayer');
        if (isNaN(audio.duration)) return;
        document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
        document.getElementById('seekSlider').value = audio.currentTime;
    }
    
    function adjustPlaybackSpeed() {
        const audio = document.getElementById('audioPlayer');
        const wordCount = parseInt(document.getElementById('wordCount').value);
        const targetWPM = parseInt(document.getElementById('speedControl').value);
        document.getElementById('speedValue').textContent = targetWPM;
        if (!isNaN(wordCount) && wordCount > 0 && !isNaN(audio.duration) && audio.duration > 0) {
            const originalWPM = wordCount / (audio.duration / 60);
            const playbackRate = targetWPM / originalWPM;
            audio.playbackRate = isFinite(playbackRate) ? playbackRate : 1;
        } else {
            audio.playbackRate = 1;
        }
    }

    // --- UI & Event Handlers ---
    function resetState() {
        // Hide all sections except the choice section
        document.getElementById('audioPlayerSection').classList.add('hidden');
        document.getElementById('transcriptionSection').classList.add('hidden');
        document.getElementById('modern-results-view').classList.add('hidden');
        document.getElementById('choiceSection').classList.remove('hidden');

        // Reset inputs
        document.getElementById("original").value = "";
        document.getElementById("typed").value = "";
        document.getElementById("wordCount").value = "";
        document.getElementById("audioUpload").value = "";
        document.getElementById("fileName").textContent = "No file chosen";
        
        // Reset audio player
        const audio = document.getElementById('audioPlayer');
        audio.pause();
        audio.removeAttribute('src');
        audio.load(); // Important to clear the old source
        document.getElementById('currentTime').textContent = "0:00";
        document.getElementById('totalDuration').textContent = "0:00";
        document.getElementById('seekSlider').value = 0;
        document.getElementById('playIcon').classList.remove('hidden');
        document.getElementById('pauseIcon').classList.add('hidden');

        // Reset speed slider
        document.getElementById("speedControl").value = 100;
        document.getElementById("speedValue").textContent = 100;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        // --- Page Navigation ---
        document.getElementById('useAudioBtn').addEventListener('click', () => {
            document.getElementById('choiceSection').classList.add('hidden');
            document.getElementById('audioPlayerSection').classList.remove('hidden');
        });
        
        document.getElementById('useTextBtn').addEventListener('click', () => {
            document.getElementById('choiceSection').classList.add('hidden');
            document.getElementById('originalPassageContainer').classList.remove('hidden');
            document.getElementById('typed').placeholder = "Type your transcription here...";
            document.getElementById('transcriptionSection').classList.remove('hidden');
        });

        document.getElementById('backToChoiceBtn').addEventListener('click', resetState);

        document.getElementById('startTranscriptionBtn').addEventListener('click', () => {
            document.getElementById('audioPlayerSection').classList.add('hidden');
            document.getElementById('originalPassageContainer').classList.add('hidden'); // Hide original text box for audio transcription
            document.getElementById('typed').placeholder = "Listen to the audio and type here...";
            document.getElementById('transcriptionSection').classList.remove('hidden');
        });

        // --- Core Buttons ---
        document.getElementById('submitButton').addEventListener('click', submitTranscription);
        
        // --- Audio Player Listeners ---
        const audio = document.getElementById('audioPlayer');
        document.getElementById('audioUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                audio.src = URL.createObjectURL(file);
                audio.load();
            }
        });

        document.getElementById('playPauseBtn').addEventListener('click', () => audio.paused ? audio.play() : audio.pause());
        audio.addEventListener('play', () => {
            document.getElementById('playIcon').classList.add('hidden');
            document.getElementById('pauseIcon').classList.remove('hidden');
        });
        audio.addEventListener('pause', () => {
            document.getElementById('playIcon').classList.remove('hidden');
            document.getElementById('pauseIcon').classList.add('hidden');
        });
        audio.addEventListener('loadedmetadata', () => {
            document.getElementById('seekSlider').max = audio.duration;
            document.getElementById('totalDuration').textContent = formatTime(audio.duration);
            adjustPlaybackSpeed();
        });
        audio.addEventListener('timeupdate', updateTimeDisplay);
        document.getElementById('seekSlider').addEventListener('input', (e) => audio.currentTime = e.target.value);
        document.getElementById('volumeSlider').addEventListener('input', (e) => audio.volume = e.target.value);
        document.getElementById('wordCount').addEventListener('input', adjustPlaybackSpeed);
        document.getElementById('speedControl').addEventListener('input', adjustPlaybackSpeed);
    });

    // --- Result Sheet Rendering (Placeholder from previous version) ---
    function renderResultSheet(data) {
        const view = document.getElementById('modern-results-view');
        // Basic result rendering for demonstration
        view.innerHTML = `
            <h1>Result Sheet</h1>
            <p>Accuracy: ${data.accuracy}%</p>
            <p>Total Words: ${data.totalWords}</p>
            <p>Full Mistakes: ${data.fullMistakes}</p>
            <p>Half Mistakes: ${data.halfMistakes}</p>
            <button id="tryAnotherBtn" class="primary-btn">Start New Comparison</button>`;
        document.getElementById('tryAnotherBtn').addEventListener('click', resetState);
    }
</script>
</body>
</html>
