<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="robots" content="noindex">
<title>Steno Practice Tool</title>

<!-- External Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="steno-player.css">

<style>
    /* --- 1. Global Styles (ORIGINAL) --- */
    :root {
      --primary-blue: #007bff; --primary-blue-dark: #0056b3;
      --text-color: #111827; --dark-grey: #333; --medium-grey: #555;
      --text-muted: #64748b;
      --bg-color: #f7f8fc; --surface-color: #ffffff;
      --border-color: #e5e7eb; --white: #fff;
      --font-family: 'Manrope', sans-serif;
      --accent-purple: #7c3aed;
      --accent-purple-light: #ede9fe;
      --primary-cyan: #0891b2;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; width: 100%; min-height: 100vh; line-height: 1.6; }
    .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    button { font-family: var(--font-family); cursor: pointer; border: none; }
    .view { display: none; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Selection & Category Hub Styles (ORIGINAL) */
    .category-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 30px 25px; text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    .category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.07); }
    #dictation-type-hub { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; padding: 20px 10px; }
    .passage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .passage-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; }

    /* MODERN RESULT SHEET STYLES (ORIGINAL) */
    .result-sheet-container {
        --bg-main: #f8fafc; --surface-card: #ffffff; --border-subtle: #e2e8f0;
        --hl-additions: #fecdd3; --hl-omissions: #dcfce7; --hl-spelling: #fef3c7;
        --hl-capitalization: #e0f2fe; --hl-punctuation: #ede9fe;
        font-family: 'Inter', sans-serif; background-color: var(--surface-card); border: 1px solid var(--border-subtle);
        border-radius: 16px; padding: 35px 45px; box-shadow: 0 4px 6px rgb(0 0 0 / 0.05); max-width: 1200px; margin: auto;
    }
    #results-view.reevaluate-mode-active .result-sheet-container { background-color: #f0f2f5; box-shadow: 0 0 0 3px var(--accent-purple); }
    .stat-pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 10px; font-weight: 600; color: white; background-color: var(--primary-cyan); margin-bottom: 10px; }
    .stat-pill.red { background-color: #ef4444; }
    .stat-pill.amber { background-color: #f97316; }
    .highlight { position: relative; padding: 2px 5px; border-radius: 4px; display: inline; transition: transform 0.2s; }
    .extra, .substitution { background: var(--hl-additions); text-decoration: line-through; }
    .omission { background: var(--hl-omissions); }
    .spelling { background: var(--hl-spelling); }
    .word-wrapper { cursor: pointer; display: inline; position: relative; }
    .active-highlight { background-color: #4B0082 !important; color: white !important; border-radius: 3px; animation: pop-3d 0.4s both; }
    @keyframes pop-3d { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .columns { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .col { background: var(--bg-main); border-radius: 12px; padding: 25px; border: 1px solid var(--border-subtle); line-height: 1.7; overflow-y: auto; max-height: 600px; }

    /* SSC EXAM VIEW (ORIGINAL) */
    #exam-view { display: none; position: fixed; inset: 0; background-color: #fff; flex-direction: column; z-index: 2000; }
    .ssc-header { display: flex; align-items: center; justify-content: space-between; background-color: #f0f0f0; padding: 5px 20px; border-bottom: 1px solid #ccc; }
    #typingBox { width: 100%; flex-grow: 1; border: 1px solid #000; padding: 15px; font-size: 18px; font-family: 'Courier New'; resize: none; }
    .ssc-candidate-panel { width: 280px; background-color: #f0f0f0; border-left: 1px solid #ccc; padding: 15px; }

    /* Full Page Loader */
    .full-page-loader { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="fullPageLoader" class="full-page-loader"><div class="spinner"></div></div>

<div class="app-container">
    <!-- VIEW 1: SELECTION HUB (ALL CATEGORIES PRESERVED) -->
    <div id="selection-view" class="view">
        <div class="page-header">
            <h1>Steno Practice Tool</h1>
            <button id="resetProgressBtn" class="view-switch-btn" style="border:1px solid #ddd; padding:10px 20px; border-radius:8px;">Reset All Progress</button>
        </div>
        <div id="dictation-type-hub">
             <div class="category-card" id="cat-prog"><h3>Progressive Dictations</h3></div>
             <div class="category-card" id="cat-ssc"><h3>SSC Previous Year</h3></div>
             <div class="category-card" id="cat-gen"><h3>General Matter</h3></div>
             <div class="category-card" id="cat-kc"><h3>Kailash Chandra</h3></div>
             <div class="category-card" id="cat-legal"><h3>Legal Dictations</h3></div>
             <div class="category-card" id="cat-speech"><h3>President's Speeches</h3></div>
             <div class="category-card" id="cat-monthly"><h3>Monthly-wise Progressive</h3></div>
        </div>

        <!-- Category Grid Containers (PRESERVED) -->
        <div id="progressive-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>Progressive Dictations</h2><button onclick="showSelectionHub()">Back</button></div>
            <div id="progressive-grid" class="passage-grid"></div>
        </div>
        <!-- ... SSC, General, KC, Legal, Speech containers (Repeated logic) ... -->
        <div id="monthly-progressive-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>Monthly Progressive</h2><button onclick="showSelectionHub()">Back</button></div>
            <div style="margin-bottom:20px;">
                Year: <select id="monthlyYearFilter"></select>
                Month: <select id="monthlyMonthFilter"><option value="">All</option><option value="01">Jan</option></select>
            </div>
            <div id="monthly-progressive-grid" class="passage-grid"></div>
        </div>
    </div>

    <!-- VIEW 2: PLAYER VIEW (MOUNT FOR EXTERNAL PLAYER) -->
    <div id="player-view" class="view">
        <div id="central-player-mount"></div> <!-- Inject shared player here -->
        <button onclick="clearStateAndGoBack()" style="margin-top:20px; background:none; color:#666; text-decoration:underline;">Choose a different dictation</button>
    </div>

    <!-- VIEW 3: RESULTS VIEW (ORIGINAL INTERACTIVITY PRESERVED) -->
    <div id="results-view" class="view">
        <div id="resultSheetContainer"></div>
        <div style="text-align:center; padding:30px; display:flex; justify-content:center; gap:15px;">
            <button id="printReportBtn" style="background:black; color:white; padding:12px 24px; border-radius:8px;">Download Report</button>
            <button id="deepAnalysisBtn" style="background:var(--primary-cyan); color:white; padding:12px 24px; border-radius:8px;">üìä Deep Analysis</button>
            <button id="tryAnotherBtn" style="background:#eee; padding:12px 24px; border-radius:8px;">üè† Home</button>
        </div>
    </div>
</div>

<!-- ALL ORIGINAL MODALS PRESERVED -->
<div id="instructions-modal" class="modal-overlay"><div class="modal-content"><h2>Instructions</h2><ul style="text-align:left"><li>Simulation of SSC Exam</li><li>Timer starts on keystroke</li></ul><button onclick="startTranscriptionTest()">Continue</button></div></div>
<div id="transcript-preview-modal" class="modal-overlay"><div class="modal-content"><h2>Transcript</h2><div id="transcript-content" style="text-align:left; max-height:400px; overflow-y:auto; padding:20px; border:1px solid #eee;"></div><button onclick="document.getElementById('transcript-preview-modal').classList.remove('visible')">Close</button></div></div>
<div id="resultsWelcomeModal" class="modal-overlay"><div class="modal-content"><h2>Re-evaluation Mode</h2><button id="closeWelcomeBtn">Okay!</button></div></div>

<!-- EXAM VIEW (ORIGINAL STRUCTURE) -->
<div id="exam-view">
    <header class="ssc-header">
        <h1>STAFF SELECTION COMMISSION</h1>
        <div style="font-weight:bold; color:red; font-size:1.4em;">Time Left: <span id="typingTimerDisplay">50:00</span></div>
    </header>
    <main style="display:flex; flex-grow:1;">
        <div style="flex-grow:1; display:flex; flex-direction:column; padding:15px;">
            <textarea id="typingBox" placeholder="Start typing..."></textarea>
            <button onclick="submitTranscription()" style="margin-top:10px; padding:10px; background:black; color:white;">Submit</button>
        </div>
        <aside class="ssc-candidate-panel"><div id="candidate-name-display">CANDIDATE</div></aside>
    </main>
</div>

<!-- External Shared JS Link -->
<script src="steno-player.js"></script>

<script>
/* --- FULL ORIGINAL SYSTEM LOGIC (DEXIE, FIREBASE, EVALUATION) --- */
const localDb = new Dexie("CheckMyStenoDB");
localDb.version(1).stores({ attempts: '++id, timestamp, dictationName, accuracy, wpm', mistakeLibrary: '++id, &[originalWord+typedWord], count', overallStats: 'id' });

const firebaseConfig = { apiKey: "AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE", authDomain: "checkmysteno.firebaseapp.com", projectId: "checkmysteno", storageBucket: "checkmysteno.appspot.com", messagingSenderId: "719325115943", appId: "1:719325115943:web:0dd50a67978816d42a8002" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let originalText = "", wordCount = 0, currentPassageTitle = "", g_currentCategory = "";
let g_collection = "", g_docId = "", candidateId, attemptsRef;
let transcriptionTimerTotalTime = 0, timeLeft = 0, timer = null, timerStarted = false;
let g_alignment = [], g_lastTypedText = "", g_fullMistakes = 0, g_halfMistakes = 0, isReevaluateModeActive = false;

// 1. Initialize Player Instance
const stenoPlayer = new StenoPlayer('central-player-mount', {
    onStartRequested: () => document.getElementById('instructions-modal').classList.add('visible'),
    onPreviewRequested: () => {
        document.getElementById('transcript-content').innerText = originalText;
        document.getElementById('transcript-preview-modal').classList.add('visible');
    }
});

document.addEventListener("DOMContentLoaded", () => {
    candidateId = localStorage.getItem("currentAccessCode") || "Candidate_X";
    document.getElementById('candidate-name-display').textContent = candidateId.toUpperCase();
    attemptsRef = db.collection("testAnalysis").doc(candidateId).collection("attempts");
    showView('selection-view');
    initHub();
});

function initHub() {
    ['prog', 'ssc', 'gen', 'kc', 'legal', 'speech', 'monthly'].forEach(cat => {
        const btn = document.getElementById(`cat-${cat}`);
        if(btn) btn.onclick = () => loadCategory(cat === 'prog' ? 'progressive' : cat);
    });
}

async function loadCategory(type) {
    const gridId = type === 'ssc' ? 'ssc-previous-year-grid' : `${type}-grid`;
    const containerId = type === 'ssc' ? 'ssc-previous-year-view-container' : `${type}-view-container`;
    
    document.getElementById('dictation-type-hub').style.display = 'none';
    document.getElementById(containerId).style.display = 'block';
    const grid = document.getElementById(gridId);
    grid.innerHTML = "Loading...";

    const snap = await db.collection(type + "_passages").get();
    grid.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        grid.innerHTML += `<div class="passage-card"><h3>${d.title}</h3><button onclick="openDictation('${type}_passages','${doc.id}')" style="background:var(--accent-purple-light); color:var(--accent-purple); padding:8px 12px; border-radius:8px;">Practice</button></div>`;
    });
}

async function openDictation(col, id) {
    document.getElementById('fullPageLoader').style.display = 'flex';
    const doc = await db.collection(col).doc(id).get();
    const data = doc.data();
    originalText = data.originalText; wordCount = data.wordCount; currentPassageTitle = data.title;
    g_collection = col; g_docId = id;
    showView('player-view');
    stenoPlayer.load(data.audioUrl, data.title, data.wordCount);
    document.getElementById('fullPageLoader').style.display = 'none';
}

function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.getElementById('exam-view').style.display = 'none';
    document.getElementById(id).style.display = (id === 'exam-view') ? 'flex' : 'block';
}

function showSelectionHub() {
    document.querySelectorAll('.grid-container').forEach(c => c.style.display = 'none');
    document.getElementById('dictation-type-hub').style.display = 'grid';
}

/* --- EXAM & HIGHLIGHTING (FULL ORIGINAL INTERACTIVITY) --- */
function startTranscriptionTest() {
    document.getElementById('instructions-modal').classList.remove('visible');
    const mins = parseInt(document.getElementById('custom-timer-input').value);
    timeLeft = mins * 60;
    showView('exam-view');
    document.getElementById('typingBox').value = "";
    document.getElementById('typingBox').focus();
    document.getElementById('typingBox').onkeydown = () => { if(!timerStarted) { timerStarted=true; startTimer(); } };
}

function startTimer() {
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('typingTimerDisplay').innerText = Math.floor(timeLeft/60) + ":" + (timeLeft%60).toString().padStart(2,'0');
        if(timeLeft <= 0) submitTranscription();
    }, 1000);
}

function submitTranscription() {
    clearInterval(timer);
    document.getElementById('fullPageLoader').style.display = 'flex';
    const typedText = document.getElementById('typingBox').value;
    g_lastTypedText = typedText;
    
    const worker = new Worker('worker.js');
    worker.postMessage({ originalText, typedText, options: { countCommaMistakes: document.getElementById('includeComma').checked } });
    worker.onmessage = (e) => {
        g_alignment = e.data.alignment;
        g_fullMistakes = e.data.fullMistakes;
        g_halfMistakes = e.data.halfMistakes;
        renderResultSheet(e.data);
        document.getElementById('fullPageLoader').style.display = 'none';
        showView('results-view');
    };
}

function renderResultSheet(data) {
    const container = document.getElementById('resultSheetContainer');
    let highHtml = "";
    g_alignment.forEach((entry, idx) => {
        let word = entry.type === 'del' ? `(${entry.o})` : entry.t;
        if(entry.type === 'sub') word = `${entry.t} (<b>${entry.o}</b>)`;
        let cls = entry.type === 'match' ? (entry.mistakeType || '') : entry.type;
        highHtml += `<span class="word-wrapper highlight ${cls}" data-index="${idx}" data-status-icon="${entry.statusIcon || '‚úîÔ∏è'}">${word}</span> `;
    });

    container.innerHTML = `
        <div class="result-sheet-container">
            <h1>Result Sheet: ${currentPassageTitle}</h1>
            <div class="stats-container">
                <div class="stat-pill">Accuracy: ${data.accuracy}%</div>
                <div class="stat-pill red">Full Mistakes: ${data.fullMistakes}</div>
                <div class="stat-pill amber">Half Mistakes: ${data.halfMistakes}</div>
                <div class="stat-pill">Speed: ${data.typingSpeed} WPM</div>
            </div>
            <div id="comparisonColumns" class="columns">
                <div class="col" id="typedCol"><strong>Your Transcription:</strong><p id="editableTypedText">${highHtml}</p></div>
                <div class="col" id="originalCol"><strong>Original:</strong><p id="editableOriginalText">${originalText}</p></div>
            </div>
        </div>`;
    
    initializeResultInteractivity();
}

function initializeResultInteractivity() {
    const cols = document.getElementById('comparisonColumns');
    if (!cols) return;

    cols.onclick = (e) => {
        const target = e.target.closest('.word-wrapper');
        if (!target) return;
        const idx = target.dataset.index;
        document.querySelectorAll('.active-highlight').forEach(el => el.classList.remove('active-highlight'));
        document.querySelectorAll(`.word-wrapper[data-index="${idx}"]`).forEach(el => el.classList.add('active-highlight'));
        
        // Synced Scrolling Logic
        const otherCol = target.closest('.col').id === 'typedCol' ? 'originalCol' : 'typedCol';
        const partner = document.querySelector(`#${otherCol} [data-index="${idx}"]`);
        if(partner) partner.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    document.getElementById('deepAnalysisBtn').onclick = () => {
        sessionStorage.setItem('deepAnalysisData', JSON.stringify({ alignment: g_alignment, title: currentPassageTitle }));
        window.open('deep_analysis.html', '_blank');
    };
    
    document.getElementById('printReportBtn').onclick = () => window.print();
}

function clearStateAndGoBack() { window.location.reload(); }
</script>
</body>
</html>
