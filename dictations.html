<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="robots" content="noindex">
<title>Steno Practice Tool</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

<!-- CONNECT EXTERNAL PLAYER HERE -->
<script src="steno-player-module.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- 1. Global Styles --- */
    :root { --primary-blue: #007bff; --text-color: #111827; --bg-color: #f7f8fc; --surface-color: #ffffff; --border-color: #e5e7eb; --font-family: 'Manrope', sans-serif; --accent-purple: #7c3aed; --accent-purple-light: #ede9fe; --primary-cyan: #0891b2; --text-muted: #64748b; }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; width: 100%; min-height: 100vh; line-height: 1.6; }
    .app-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .view { display: none; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Selection Hub Styles --- */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    #dictation-type-hub { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
    .category-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; }
    .category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.07); }
    .icon-wrapper { width: 60px; height: 60px; margin: 0 auto 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    #cat-prog .icon-wrapper { background: linear-gradient(135deg, #818cf8, #6366f1); }
    /* ... (All other category colors remain same) */

    .passage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .passage-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); }
    .take-test-btn { background: var(--accent-purple-light); color: var(--accent-purple); width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }

    /* --- Exam View Styles --- */
    #exam-view { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; flex-direction: column; z-index: 2000; }
    .ssc-header { background: #f0f0f0; padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; }
    #typingBox { flex-grow: 1; padding: 15px; font-size: 18px; font-family: monospace; resize: none; border: 1px solid #000; }

    /* --- Result Styles --- */
    .result-sheet-container { background: white; padding: 40px; border-radius: 16px; border: 1px solid var(--border-color); max-width: 1100px; margin: auto; }
    .stat-pill { background: var(--primary-cyan); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; display: inline-block; margin: 5px; }

    /* --- Modals --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; }
    .modal-overlay.visible { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; text-align: center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="fullPageLoader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;display:none;justify-content:center;align-items:center"><div class="spinner"></div></div>

<div class="app-container">
    <!-- 1. SELECTION VIEW -->
    <div id="selection-view" class="view">
        <div class="page-header">
            <h1>Steno Practice Tool</h1>
            <button id="resetProgressBtn" style="background:none; border:1px solid #ddd; padding:8px; cursor:pointer">Reset Progress</button>
        </div>
        <div id="dictation-type-hub">
             <div class="category-card" id="cat-prog"><div class="icon-wrapper"></div><h3>Progressive Dictations</h3></div>
             <div class="category-card" id="cat-ssc"><div class="icon-wrapper"></div><h3>SSC PYQs</h3></div>
             <!-- ... other cards ... -->
        </div>

        <div id="progressive-view-container" class="grid-container" style="display:none">
            <button onclick="showSelectionHub()">Back</button>
            <div id="progressive-grid" class="passage-grid"></div>
        </div>
        <!-- ... other containers ... -->
    </div>

    <!-- 2. PLAYER VIEW (Content is now dynamic from module) -->
    <div id="player-view" class="view">
        <div id="player-module-container"></div>
        <button onclick="clearStateAndGoBack()" style="width:100%; background:none; color:gray; margin-top:20px; cursor:pointer">Choose different dictation</button>
    </div>

    <!-- 3. EXAM VIEW -->
    <div id="exam-view">
        <header class="ssc-header"><div>STAFF SELECTION COMMISSION</div><div id="typingTimerDisplay" style="font-weight:bold; color:red">50:00</div></header>
        <main style="display:flex; flex-grow:1">
            <div style="display:flex; flex-direction:column; flex-grow:1; padding:20px">
                <textarea id="typingBox" placeholder="Start typing..."></textarea>
                <button id="submitBtn" onclick="submitTranscription()" style="margin-top:10px; padding:10px; background:black; color:white; width:100px">Submit</button>
            </div>
            <aside style="width:280px; background:#f0f0f0; border-left:1px solid #ccc; padding:20px">Candidate Info Panel</aside>
        </main>
    </div>

    <!-- 4. RESULTS VIEW -->
    <div id="results-view" class="view">
        <div id="resultSheetContainer"></div>
        <div style="text-align:center; padding:20px">
            <button onclick="goHome()" style="padding:15px 30px; background:var(--accent-purple); color:white; border-radius:10px; cursor:pointer">Try Another</button>
        </div>
    </div>
</div>

<!-- ALL ORIGINAL MODALS -->
<div id="instructions-modal" class="modal-overlay">
    <div class="modal-content"><h2>Instructions</h2><p>Timer starts when you type.</p><button onclick="startTranscriptionTest()">Continue</button></div>
</div>

<div id="transcript-preview-modal" class="modal-overlay">
    <div class="modal-content"><div id="transcript-content"></div><button onclick="document.getElementById('transcript-preview-modal').classList.remove('visible')">Close</button></div>
</div>

<script>
    // --- PHOTO COPY OF YOUR FIREBASE / DEXIE / GLOBALS ---
    const localDb = new Dexie("CheckMyStenoDB");
    localDb.version(1).stores({ attempts: '++id, timestamp, dictationName, accuracy, wpm' });

    const firebaseConfig = { apiKey: "AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE", authDomain: "checkmysteno.firebaseapp.com", projectId: "checkmysteno" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let originalText = "", wordCount = 0, currentTitle = "";
    let timer = null, timeLeft = 0;

    // --- INITIALIZE PLAYER ---
    window.onYouTubeIframeAPIReady = function() {
        StenoPlayer.init('player-module-container');
    };

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.getElementById('exam-view').style.display = 'none';
        const target = document.getElementById(id);
        if (id === 'exam-view') target.style.display = 'flex'; else target.style.display = 'block';
    }

    async function loadPractice(col, id) {
        document.getElementById('fullPageLoader').style.display = 'flex';
        const doc = await db.collection(col).doc(id).get();
        const data = doc.data();
        originalText = data.originalText;
        wordCount = data.wordCount;
        currentTitle = data.title;

        showView('player-view');
        // CALL THE MODULE
        StenoPlayer.load(data.audioUrl, currentTitle, wordCount);
        document.getElementById('fullPageLoader').style.display = 'none';
    }

    function showInstructions() { 
        if (StenoPlayer.player) StenoPlayer.player.pauseVideo();
        document.getElementById('instructions-modal').classList.add('visible'); 
    }

    function showTranscriptPreview() {
        document.getElementById('transcript-content').innerText = originalText;
        document.getElementById('transcript-preview-modal').classList.add('visible');
    }

    function startTranscriptionTest() {
        document.getElementById('instructions-modal').classList.remove('visible');
        timeLeft = parseInt(document.getElementById('custom-timer-input').value) * 60;
        showView('exam-view');
        document.getElementById('typingBox').value = "";
        
        timer = setInterval(() => {
            if (--timeLeft <= 0) submitTranscription();
            document.getElementById('typingTimerDisplay').innerText = StenoPlayer.formatTime(timeLeft);
        }, 1000);
    }

    function submitTranscription() {
        clearInterval(timer);
        const typed = document.getElementById('typingBox').value;
        showView('results-view');
        document.getElementById('resultSheetContainer').innerHTML = `
            <div class="result-sheet-container">
                <h1>Results for ${currentTitle}</h1>
                <div class="stat-pill">Typed Words: ${typed.split(' ').length}</div>
                <div style="margin-top:20px; white-space:pre-wrap; border:1px solid #ddd; padding:20px">${typed}</div>
            </div>
        `;
    }

    function goHome() { location.reload(); }
    function showSelectionHub() { showView('selection-view'); }
    function clearStateAndGoBack() { goHome(); }

    document.getElementById('cat-prog').onclick = () => {
        // Your logic to load the grid...
        document.getElementById('progressive-view-container').style.display = 'block';
        document.getElementById('dictation-type-hub').style.display = 'none';
        // Mock load
        document.getElementById('progressive-grid').innerHTML = `<div class="passage-card"><h3>Sample</h3><button class="take-test-btn" onclick="loadPractice('progressive_passages','prog_001')">Take Test</button></div>`;
    };

    window.onload = () => showView('selection-view');
</script>
</body>
</html>
