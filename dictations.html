<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta name="robots" content="noindex">
<title>Steno Practice Tool</title>

<!-- External Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<!-- ADDED: The tool for our local database -->
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>


<!-- Google Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">


<style>
    /* --- 1. Global Styles --- */
    :root {
      --primary-blue: #007bff; --primary-blue-dark: #0056b3;
      --text-color: #111827; --dark-grey: #333; --medium-grey: #555;
      --bg-color: #f7f8fc; --surface-color: #ffffff;
      --border-color: #e5e7eb; --white: #fff;
      --font-family: 'Manrope', sans-serif;
      --accent-purple: #7c3aed;
      --accent-purple-light: #ede9fe;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color);
      margin: 0; padding: 0; width: 100%; min-height: 100vh; line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    button { font-family: var(--font-family); cursor: pointer; border: none; }
    .view { display: none; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 1a. NEW SELECTION VIEW STYLES --- */
    #selection-view { max-width: 1200px; }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 24px;
        padding: 0 10px;
    }
    .page-header h1, .page-header h2 {
        font-weight: 800;
        color: var(--text-color);
        margin: 0;
    }
     .search-wrapper-input {
        width: 280px; padding: 12px 16px; border: 1px solid var(--border-color);
        border-radius: 99px; font-size: 1em;
    }
    .filter-bar { display: flex; align-items: center; gap: 1rem; margin-bottom: 24px; padding: 0 10px; }
    .filter-bar label { font-weight: 600; }
    .filter-bar select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); }
  
    /* Category Hub Styles */
    #dictation-type-hub {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        padding: 20px 10px;
    }
    .category-card {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 30px 25px;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.07);
    }
    .category-card h3 {
        font-size: 1.3em;
        font-weight: 700;
        margin: 15px 0 10px 0;
        color: var(--text-color);
    }
    .category-card p {
        color: var(--medium-grey);
        font-size: 0.9em;
        margin: 0;
    }
    .category-card .icon-wrapper {
        width: 60px; height: 60px; margin: 0 auto; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
    }
    .category-card .icon-wrapper svg { width: 30px; height: 30px; color: white; }
    #cat-prog .icon-wrapper { background: linear-gradient(135deg, #818cf8, #6366f1); }
    #cat-ssc .icon-wrapper { background: linear-gradient(135deg, #f97316, #ea580c); }
    #cat-gen .icon-wrapper { background: linear-gradient(135deg, #22c55e, #16a34a); }
    #cat-kc .icon-wrapper { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
    #cat-legal .icon-wrapper { background: linear-gradient(135deg, #a855f7, #9333ea); }
    #cat-speech .icon-wrapper { background: linear-gradient(135deg, #ec4899, #db2777); }
    #cat-monthly .icon-wrapper { background: linear-gradient(135deg, #f59e0b, #d97706); }


    .passage-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }
    .passage-card {
        background-color: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        transition: all 0.2s ease;
    }
    .passage-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .card-title-group { display: flex; align-items: center; gap: 8px; }
    .card-title-group h3 { font-size: 1.25em; font-weight: 700; margin: 0; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #9ca3af; flex-shrink: 0; }
    .status-dot.attempted { background-color: #22c55e; }
    .card-header .status-tag { background-color: #e5e7eb; color: #4b5563; padding: 4px 10px; border-radius: 99px; font-size: 0.8em; font-weight: 600; white-space: nowrap; }
    .status-tag.attempted { background-color: #d1fae5; color: #065f46; }
    .card-meta { color: var(--medium-grey); font-size: 0.9em; margin-bottom: 16px; }
    .card-buttons { display: flex; gap: 10px; }
    .card-buttons button { flex: 1; padding: 12px; font-size: 1em; font-weight: 600; border-radius: 8px; transition: all 0.2s ease; }
    .take-test-btn { background-color: var(--accent-purple-light); color: var(--accent-purple); }
    .take-test-btn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    
    /* --- 2. MODERN PLAYER STYLES --- */
    #player-view { max-width: 800px; margin: 40px auto; }
    .practice-station { border: 1px solid var(--border-color); border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.04), 0 20px 40px -10px rgba(78, 93, 143, 0.08); background: var(--surface-color); overflow: hidden; }
    .player-card { padding: 2rem 2rem 1.5rem 2rem; text-align: center; position: relative; }
    .player-title { margin: 0; font-size: 1.5rem; font-weight: 700; color: #374151; }
    .player-subtitle { font-size: 0.9rem; color: #6b7280; margin-bottom: 2rem; }
    .controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 2rem; }
    .btn { background: #f3f4f8; color: #4b5563; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1rem; transition: all 0.2s ease; }
    .btn:hover { transform: scale(1.1); background-color: #e5e7eb; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: #f3f4f8; }
    .btn-main { width: 72px; height: 72px; font-size: 1.8rem; background: linear-gradient(135deg, #818cf8, #6366f1); box-shadow: 0 5px 15px -3px rgba(109, 115, 234, 0.5); color: white; }
    .btn-main svg { width: 30px; height: 30px; }
    #pauseBtn { display: none; }
    .progress-bar-wrapper { position: relative; width: 100%; background-color: #e0e7ff; height: 8px; border-radius: 4px; cursor: pointer; }
    #progress-fill { height: 100%; width: 0%; background-color: #6366f1; border-radius: 4px; transition: width 0.1s linear; }
    .time-display { display: flex; justify-content: space-between; font-size: 0.875rem; color: #6b7280; font-weight: 500; margin-top: 0.5rem; }
    .extra-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; }
    #wpmSpeed { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.4rem 2rem 0.4rem 0.8rem; font-family: 'Manrope', sans-serif; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
    .volume-control-group { position: relative; }
    #volume-slider { display: none; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); -webkit-appearance: none; appearance: none; width: 8px; height: 100px; background: #e5e7eb; border-radius: 4px; padding: 0; margin: 0; }
    #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #6366f1; border-radius: 50%; cursor: pointer; }
    #volume-btn:hover + #volume-slider, #volume-slider:hover { display: block; }
    .test-setup { background-color: #f9fafb; padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); }
    #timer-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; border: 1px solid var(--border-color); padding: 14px; border-radius: 12px; margin-top: 0; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
    #startTranscriptionBtn { font-size: 1.1em; padding: 16px; margin-top: 1rem; width: 100%; border-radius: 12px; font-weight: 600; transition: all 0.2s ease; }
    #startTranscriptionBtn:disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    #startTranscriptionBtn:not(:disabled) { background-color: #1f2937; color: white; }
    #startTranscriptionBtn:not(:disabled):hover { background-color: #111827; transform: translateY(-2px); }
    .back-btn { background: none; color: #9ca3af; font-size: 0.9em; margin-top: 1.5rem; width: 100%; text-decoration: none; font-weight: 500; }
    .back-btn:hover { text-decoration: underline; }
    .loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 24px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- 3. SSC EXAM VIEW STYLES --- */
    #exam-view { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #fff; flex-direction: column; padding: 0; font-family: 'Tahoma', Arial, sans-serif; }
    .ssc-header { display: flex; align-items: center; justify-content: space-between; background-color: #f0f0f0; padding: 5px 20px; border-bottom: 1px solid #ccc; flex-shrink: 0; }
    .ssc-header-left { display: flex; align-items: center; gap: 15px; }
    .ssc-logo img { height: 45px; }
    .ssc-title h1 { font-size: 1.1em; color: #000; margin: 0; font-weight: bold; }
    .ssc-title p { margin: 0; font-size: 0.8em; color: #555; }
    .ssc-header-right { font-size: 0.8em; text-align: right; }
    .ssc-main-content { display: flex; flex-grow: 1; }
    .ssc-typing-area { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; }
    #typingBox { width: 100%; flex-grow: 1; border: 1px solid #000; border-radius: 0; padding: 10px; font-size: 16px; font-family: 'Courier New', Courier, monospace; resize: none; }
    #typingBox:focus { outline: none; }
    #submitBtn { width: 90px; padding: 5px 10px; font-size: 0.9em; background-color: #000; border-radius: 0; color: white; margin-top: 10px; }
    .ssc-candidate-panel { width: 280px; background-color: #f0f0f0; border-left: 1px solid #ccc; padding: 15px; text-align: left; font-size: 0.9em; color: #333; }
    .ssc-timer-box { margin-bottom: 20px; }
    .ssc-timer-box span { font-weight: bold; }
    #typingTimerDisplay { font-size: 1.5em; font-weight: bold; color: #d00; }
    .ssc-photo-box { text-align: center; margin-bottom: 20px; }
    .ssc-candidate-photo { width: 100px; height: 120px; border: 1px solid #000; background-color: #fff; margin: 0 auto 5px auto; display: flex; align-items: center; justify-content: center; }
    .ssc-candidate-photo img { width: 60%; height: auto; opacity: 0.5; }
    .ssc-candidate-info { line-height: 1.8; }
    .ssc-candidate-info b { font-weight: bold; color: #000; }

    /* --- 4. NEW MODERN RESULT SHEET STYLES --- */
     #results-view { display: none; }
    .result-sheet-container {
        --bg-main: #f8fafc;
        --surface-card: #ffffff;
        --border-subtle: #e2e8f0;
        --text-header: #1e293b;
        --text-body: #334155;
        --text-muted: #64748b;
        --primary-cyan: #0891b2;
        --accent-red: #ef4444;
        --accent-amber: #f97316;
        --hl-additions: #fecdd3;     
        --hl-omissions: #d9f99d;     
        --hl-spelling: #fde68a;      
        --hl-capitalization: #bae6fd; 
        --hl-punctuation: #ddd6fe;   

        font-family: 'Inter', sans-serif;
        background-color: var(--surface-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 35px 45px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        max-width: 1200px;
        margin: auto;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    #results-view.reevaluate-mode-active .result-sheet-container {
        background-color: #f0f2f5;
        box-shadow: 0 0 0 3px var(--accent-purple), 0 8px 25px rgba(0,0,0,0.1);
    }

    #results-view.reevaluate-mode-active [contenteditable="true"] {
        outline: 2px solid var(--accent-purple);
        background-color: white;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        padding: 10px;
        border-radius: 8px;
    }

    .result-sheet-container h1 { font-size: 2.25em; font-weight: 800; margin: 0 0 25px 0; color: var(--text-header); }
    .stats-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
    .stats-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .stat-pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 0.95em; color: white; background-color: var(--primary-cyan); box-shadow: 0 4px 10px -2px rgba(8, 145, 178, 0.25); }
    .stat-pill.full-width { flex-grow: 1; font-size: 1.1em; }
    .stat-pill.red { background-color: var(--accent-red); box-shadow: 0 4px 10px -2px rgba(239, 68, 68, 0.2); }
    .stat-pill.amber { background-color: var(--accent-amber); box-shadow: 0 4px 10px -2px rgba(249, 115, 22, 0.2); }
    .stat-pill img, .stat-pill svg { width: 18px; height: 18px; }
    .legend-container { display: flex; flex-wrap: wrap; gap: 20px 30px; padding: 25px 0; margin-bottom: 25px; border-top: 1px solid var(--border-subtle); border-bottom: 1px solid var(--border-subtle); }
    .legend-item { display: flex; align-items: center; font-size: 0.9em; font-weight: 500; }
    .legend-color-box { width: 16px; height: 16px; border-radius: 4px; margin-right: 8px; }
    .result-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .filter-section { display: flex; align-items: center; gap: 10px; }
    .action-section { display: flex; align-items: center; gap: 10px; }
    .filter-section label { font-weight: 600; color: var(--text-body); }
    .filter-section select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-subtle); background-color: var(--bg-main); font-weight: 500; color: var(--text-color); }
    .view-switch-btn { background-color: var(--bg-main); border: 1px solid var(--border-subtle); padding: 8px 16px; border-radius: 8px; font-weight: 600; color: var(--text-body); cursor: pointer; transition: all 0.2s; }
    .view-switch-btn:hover { background-color: #e2e8f0; }
    .reevaluate-wrapper { position: relative; display: inline-flex; align-items: center; gap: 8px; }
    #toggleReevaluateBtn { background-color: var(--accent-amber); color: white; }
    .tooltip-icon { background-color: #9ca3af; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; cursor: help; position: relative; }
    .tooltip-icon:hover::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; white-space: nowrap; z-index: 10; opacity: 1; visibility: visible; transition: opacity 0.2s; }
    .tooltip-icon::after { content: attr(data-tooltip); opacity: 0; visibility: hidden; }
    .columns { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .columns.view-side-by-side { grid-template-columns: 1fr 1fr; } }
    .columns.view-top-bottom { grid-template-columns: 1fr; }
    .col { background: var(--bg-main); border-radius: 12px; padding: 25px; border: 1px solid var(--border-subtle); line-height: 1.7; font-size: 1.1em; word-wrap: break-word; }
    .col strong { display: block; margin-bottom: 12px; color: var(--text-header); font-weight: 700; }
    .col p { margin: 0; }
    .word-wrapper { cursor: pointer; display: inline; transition: background-color 0.2s ease, transform 0.2s ease; position: relative; }
    .active-highlight { background-color: #4B0082 !important; color: white !important; border-radius: 3px; animation: pop-3d 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
    @keyframes pop-3d { 0% { transform: scale3d(1, 1, 1); box-shadow: 0 0 0 rgba(0,0,0,0); } 50% { transform: scale3d(1.1, 1.1, 1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); } 100% { transform: scale3d(1, 1, 1); box-shadow: 0 0 0 rgba(0,0,0,0); } }
    .word-wrapper.status-shown::after { content: attr(data-status-icon); position: absolute; top: 50%; left: 50%; font-size: 1.8em; color: white; text-shadow: 0 2px 8px black; opacity: 0; animation: fade-in-out 0.8s ease-in-out forwards; pointer-events: none; z-index: 10; }
    @keyframes fade-in-out { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 30% { opacity: 0.9; } 80% { opacity: 0.9; } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }
    .highlight { position: relative; padding: 2px 5px; border-radius: 4px; margin: 0 1px; font-weight: 500; -webkit-box-decoration-break: clone; box-decoration-break: clone; display: inline; transition: transform 0.2s ease-out; }
    .highlight:hover { transform: scale(1.15); z-index: 5; }
    .highlight:hover::after { content: attr(data-tooltip-text); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; padding: 8px 12px; background-color: #111827; color: white; font-size: 0.8em; font-weight: 500; font-family: 'Inter', sans-serif; border-radius: 6px; white-space: nowrap; z-index: 10; opacity: 1; visibility: visible; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .extra, .substitution { background: var(--hl-additions); text-decoration: line-through; text-decoration-color: #a10000; }
    .omission { background: var(--hl-omissions); }
    .spelling { background: var(--hl-spelling); }
    .spelling b { font-weight: 700; color: #166534; }
    .capitalization { background: var(--hl-capitalization); }
    .punctuation { background: var(--hl-punctuation); }
    .hidden-mistake { background: none !important; text-decoration: none !important; color: inherit !important; padding: 0 !important; margin: 0 !important; border-radius: 0 !important; font-weight: normal !important; }
    .hidden-mistake b { font-weight: normal !important; color: inherit !important; }
    .action-buttons { text-align: center; padding-top: 30px; padding-bottom: 10px; }
    .action-buttons .primary-btn { background-color: #374151; max-width: 400px; margin: 10px auto; display: inline-block; color: white; padding: 12px 25px; border-radius: 8px; font-weight: 600; }
    .action-buttons .secondary-btn { background-color: var(--primary-cyan); color: white; }
    
    /* --- MODALS --- */
    #instructions-modal, .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(20, 20, 30, 0.8);
        backdrop-filter: blur(5px);
        display: none; justify-content: center; align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .modal-overlay.visible, #instructions-modal.visible {
        display: flex; opacity: 1;
    }
    .modal-content { background-color: var(--surface-color); color: var(--text-color); padding: 30px 40px; border-radius: 8px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-subtle); }
    .modal-content h2 { font-size: 1.8em; margin-top: 0; margin-bottom: 25px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 15px; color: var(--text-header);}
    .modal-content ul { text-align: left; list-style-position: inside; padding: 0; margin: 0 0 30px 0; line-height: 2.2; color: var(--text-body); }
    .modal-content ul li::marker { color: var(--accent-purple); }
    #continue-btn, .modal-close-btn { background-color: #1f2937; color: white; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border-radius: 8px; transition: background-color 0.2s; }
    #continue-btn:hover, .modal-close-btn:hover { background-color: #000; }
    @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    #resultsWelcomeModal .modal-content { max-width: 800px; width: 95%; text-align: left; font-family: 'Inter', sans-serif; border-radius: 12px; padding: 0; overflow: hidden; animation: fadeInScaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid var(--border-subtle); }
    .pro-modal-header { text-align: center; padding: 30px 35px; border-bottom: 1px solid var(--border-subtle); }
    .pro-modal-header h2 { font-size: 1.8em; font-weight: 700; margin: 0 0 8px 0; border: none; padding: 0; }
    .pro-modal-header p { color: var(--text-muted); max-width: 550px; margin: 0 auto; font-size: 1em; line-height: 1.6; }
    .pro-welcome-grid { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 30px 35px; }
    @media (min-width: 768px) { .pro-welcome-grid { grid-template-columns: 1fr 1fr; } }
    .pro-feature-box { background-color: var(--bg-main); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 25px; position: relative; overflow: hidden; }
    .pro-feature-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
    .pro-feature-icon { background-color: #f3f4f6; color: var(--text-header); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .pro-feature-icon svg { width: 22px; height: 22px; }
    .pro-feature-title { font-size: 1.1em; font-weight: 600; margin: 0; color: var(--text-header); }
    .pro-feature-box p { font-size: 0.9em; line-height: 1.6; color: var(--text-body); margin: 0 0 15px 0; }
    .pro-feature-box .pro-step-list { padding-left: 0; list-style: none; margin: 0; }
    .pro-step-list li { font-size: 0.9em; color: var(--text-body); margin-bottom: 10px; }
    .pro-step-list b { font-weight: 600; color: var(--text-header); }
    .pro-exclusive-badge { position: absolute; top: -1px; right: -1px; background: linear-gradient(135deg, #FFD700, #FDB813); color: #4a2c00; padding: 10px 15px; font-size: 0.7em; font-weight: 700; text-transform: uppercase; border-bottom-left-radius: 12px; border-top-right-radius: 11px; }
    .pro-modal-footer { background-color: #f8fafc; padding: 15px 35px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-subtle); }
    .pro-modal-footer label { font-size: 0.85em; cursor: pointer; color: var(--text-muted); }
    .pro-modal-footer input[type="checkbox"] { vertical-align: middle; margin-right: 5px; }
    #reportErrorModal .modal-content { max-width: 500px; text-align: left; }
    #reportErrorModal h2 { text-align: left; }
    #reportErrorModal p { color: var(--text-body); }
    #reportErrorModal label { font-weight: 600; color: var(--text-header); }
    #reportErrorModal select, #reportErrorModal textarea { width: 100%; padding: 10px 12px; background-color: var(--bg-main); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 1em; margin-top: 5px; color: var(--text-color); }
    #reportErrorModal select:focus, #reportErrorModal textarea:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
    #submitReportBtn:disabled { background-color: #d1d5db; opacity: 0.7; cursor: not-allowed; }
    .confirm-dialog { background: var(--surface-color); padding: 24px; border-radius: 16px; text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .confirm-dialog h3 { margin: 0 0 8px 0; font-size: 1.25em; }
    .confirm-dialog p { margin: 0 0 20px 0; color: var(--medium-grey); }
    .confirm-dialog-actions { display: flex; gap: 10px; justify-content: center; }
    .confirm-dialog-actions button { padding: 10px 20px; border-radius: 8px; font-weight: 600; }
    #confirmResetBtn { background-color: #ef4444; color: white; }
    #cancelResetBtn { background-color: #e5e7eb; color: #4b5563; }
    .full-page-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 9999; }
    
    /* --- PRINT STYLES --- */
    @media print {
      body, .app-container, .result-sheet-container { background: #fff !important; color: #000 !important; box-shadow: none; border: none; }
      .view { display: none !important; }
      #results-view { display: block !important; }
      .action-buttons, .result-controls, .legend-container, .back-btn { display: none !important; }
      .result-sheet-container { padding: 0; }
      .col { border: 1px solid #ccc; max-height: none; overflow-y: visible; }
      .columns { grid-template-columns: 1fr 1fr !important; }
    }

</style>
</head>
<body>

<div id="fullPageLoader" class="full-page-loader">
    <div class="spinner"></div>
</div>

<div class="app-container">
    <div id="selection-view" class="view">
        <div class="page-header">
            <h1>Steno Practice Tool</h1>
             <!-- NEW: Reset Button -->
            <button id="resetProgressBtn" class="view-switch-btn" style="background-color: transparent; color: var(--medium-grey); border: 1px solid var(--border-color);">Reset All Progress</button>
        </div>
        <div id="dictation-type-hub">
             <div class="category-card" id="cat-prog">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l-1-1.5m7.5 0l1 1.5m-1-1.5l1-1.5m0 0l-1.5-2.25a.75.75 0 00-1.125 0l-1.5 2.25m-5.25 0l-1.5-2.25a.75.75 0 00-1.125 0l-1.5 2.25m10.5 0l-1.5-2.25a.75.75 0 00-1.125 0l-1.5 2.25" /></svg>
                </div>
                <h3>Progressive Dictations</h3>
                <p>Magazine passages from start to finish.</p>
            </div>
             <div class="category-card" id="cat-ssc">
                 <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                </div>
                <h3>SSC Previous Year Dictations</h3>
                <p>Practice with actual past exam papers.</p>
            </div>
             <div class="category-card" id="cat-gen">
                 <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v2.25H6V7.5z" /></svg>
                </div>
                <h3>General Matter Dictations</h3>
                <p>A variety of passages on general topics.</p>
            </div>
             <div class="category-card" id="cat-kc">
                 <div class="icon-wrapper">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
                </div>
                <h3>Most Important Kailash Chandra</h3>
                <p>Curated selection of essential KC passages.</p>
            </div>
            <!-- NEW CATEGORY 1: LEGAL DICTATION -->
            <div class="category-card" id="cat-legal">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V21M5.25 3v18m13.5-18v18M2.25 6l19.5 0M2.25 12l19.5 0M2.25 18l19.5 0" /></svg>
                </div>
                <h3>Legal Dictations</h3>
                <p>Passages from court proceedings and legal journals.</p>
            </div>
            <!-- NEW CATEGORY 2: PRESIDENT SPEECH -->
            <div class="category-card" id="cat-speech">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5l.415-.207a.75.75 0 011.085.67V10.5m0 0h6m-6 0a.75.75 0 00.75.75h4.5a.75.75 0 00.75-.75v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 00-.75.75v4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h6a.75.75 0 01.75.75v10.5a.75.75 0 01-1.5 0V10.5H3.75a.75.75 0 01-.75-.75V9z" /></svg>
                </div>
                <h3>President's Speeches</h3>
                <p>Official speeches and addresses by the President.</p>
            </div>
            <!-- NEW CATEGORY 3: MONTHLY PROGRESSIVE -->
            <div class="category-card" id="cat-monthly">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 15.75h.008v.008H12v-.008z" /></svg>
                </div>
                <h3>Monthly-wise Progressive</h3>
                <p>New progressive passages released monthly.</p>
            </div>
        </div>

        <div id="progressive-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>Progressive Dictations</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="progressive-grid" class="passage-grid"></div>
        </div>
        <div id="ssc-previous-year-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>SSC Previous Year Dictations</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="ssc-previous-year-grid" class="passage-grid"></div>
        </div>
        <div id="general-matter-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>General Matter Dictations</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="general-matter-grid" class="passage-grid"></div>
        </div>
        <div id="important-kc-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>Most Important Kailash Chandra</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="important-kc-grid" class="passage-grid"></div>
        </div>
        <!-- NEW VIEW CONTAINER 1: LEGAL -->
        <div id="legal-dictation-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>Legal Dictations</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="legal-dictation-grid" class="passage-grid"></div>
        </div>
        <!-- NEW VIEW CONTAINER 2: SPEECH -->
        <div id="president-speech-view-container" class="grid-container" style="display: none;">
            <div class="page-header"><h2>President's Speeches</h2><button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button></div>
            <div id="president-speech-grid" class="passage-grid"></div>
        </div>
        <!-- NEW VIEW CONTAINER 3: MONTHLY -->
        <div id="monthly-progressive-view-container" class="grid-container" style="display: none;">
            <div class="page-header">
                <h2>Monthly-wise Progressive</h2>
                <button class="view-switch-btn" onclick="showSelectionHub()">Back to Selection</button>
            </div>
            <!-- NEW: MONTH/YEAR FILTERS START -->
            <div class="filter-bar">
                <label for="monthlyYearFilter">Year:</label>
                <select id="monthlyYearFilter">
                    <!-- Years will be populated by JS -->
                </select>
                <label for="monthlyMonthFilter">Month:</label>
                <select id="monthlyMonthFilter">
                    <option value="">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <!-- NEW: MONTH/YEAR FILTERS END -->
            <div id="monthly-progressive-grid" class="passage-grid"></div>
        </div>
    </div>
    
    <div id="player-view" class="view">
        <div id="player"></div>
        <div class="practice-station">
            <div class="player-card">
                <div id="player-loader" class="loader"><div class="spinner"></div></div>
                <h2 class="player-title">Dictation Player</h2>
                <p id="player-subtitle" class="player-subtitle">&nbsp;</p>
                <div class="controls">
                  <button class="btn" onclick="restartVideo()" aria-label="Restart Audio"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L3 12"></path></svg></button>
                  <button id="playBtn" class="btn btn-main" onclick="togglePlay()" aria-label="Play Audio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 6V18L18 12L7 6Z"></path></svg></button>
                  <button id="pauseBtn" class="btn btn-main" onclick="togglePlay()" aria-label="Pause Audio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18H10V6H6V18ZM14 6V18H18V6H14Z"></path></svg></button>
                  <div class="volume-control-group">
                      <button id="volume-btn" class="btn" aria-label="Adjust Volume"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                      <input type="range" id="volume-slider" min="0" max="100" value="100" orient="vertical" aria-label="Volume Slider">
                  </div>
                </div>
                <div id="progressBar" class="progress-bar-wrapper"><div id="progress-fill"></div></div>
                <div class="time-display"><span id="current-time">00:00</span><span id="total-time">00:00</span></div>
                <div class="extra-controls">
                    <button class="btn speed-adjust-btn" onclick="adjustSpeed(-5)" aria-label="Decrease Speed by 5 WPM">-</button>
                    <div class="speed-control-wrapper">
                      <select id="wpmSpeed" onchange="setPlaybackSpeed()" aria-label="Select Dictation Speed in Words Per Minute"><script>for (let i = 60; i <= 160; i += 5) { document.write(`<option value="${i}">${i} WPM</option>`); }</script></select>
                    </div>
                    <button class="btn speed-adjust-btn" onclick="adjustSpeed(5)" aria-label="Increase Speed by 5 WPM">+</button>
                </div>
            </div>
            <div class="test-setup">
                <select id="timer-select"><option value="50" selected>50 Minute Timer</option><option value="40">40 Minute Timer</option></select>
                <label style="display: block; margin-top: 1rem; text-align: center; font-size: 0.9em; color: var(--text-body);">
                  <input type="checkbox" id="includeComma" style="vertical-align: middle; margin-right: 5px;">
                  Count comma (,) mistakes
                </label>
                <button id="startTranscriptionBtn" onclick="showInstructions()" disabled>🚀 Start Transcription Test</button>
            </div>
        </div>
        <button onclick="clearStateAndGoBack()" class="back-btn">Choose a different dictation</button>
    </div>

    <div id="results-view" class="view">
        <div id="resultSheetContainer"></div>
        <div class="action-buttons">
            <button id="printReportBtn" class="primary-btn">Download Report</button>
            <button onclick="goHome()" class="primary-btn">🏠 Try Another Dictation</button>
        </div>
    </div>
</div>

<div id="instructions-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Practice Test Instructions</h2>
        <ul>
            <li>This is a simulation of the official SSC Stenographer Skill Test.</li>
            <li>The timer will begin automatically as soon as you type the first character.</li>
            <li>Do not close or refresh this window during the test.</li>
            <li>Ensure you have a stable internet connection.</li>
            <li>Click the "Submit" button to finish the test and view your results.</li>
            <li>Good Luck!</li>
        </ul>
        <button id="continue-btn" onclick="startTranscriptionTest()">Continue</button>
    </div>
</div>

<div id="error-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="error-title">An Error Occurred</h2>
        <p id="error-message" style="line-height: 1.6; margin-bottom: 25px;">Could not load the requested passage. Please check your internet connection and try again.</p>
        <button id="error-close-btn" class="modal-close-btn">Close</button>
    </div>
</div>

<div id="reportErrorModal" class="modal-overlay">
    <div class="modal-content">
        <h2>Report Transcription Error</h2>
        <p>Help us improve! Please specify the error in the original passage.</p>
        <div style="margin-bottom: 15px; text-align: left;">
            <label for="errorTypeSelect" style="display: block; margin-bottom: 5px; font-weight: 600;">Type of Error:</label>
            <select id="errorTypeSelect" style="width: 100%; padding: 10px; color: #333; background-color: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px;">
                <option value="" disabled selected>-- Select an error type --</option>
                <option value="Year is incorrect">Year is incorrect</option>
                <option value="Word is different from audio">Word is different from audio</option>
                <option value="Punctuation mismatch">Punctuation mismatch</option>
                <option value="Word is missing/extra">Word is missing/extra</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div style="margin-bottom: 20px; text-align: left;">
            <label for="otherErrorText" style="display: block; margin-bottom: 5px; font-weight: 600;">Describe the mistake:</label>
            <textarea id="otherErrorText" rows="3" placeholder="e.g., The year should be 1985, not 1984." style="width: 100%; padding: 10px; color: #333; background-color: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; resize: vertical;"></textarea>
        </div>
        <div style="text-align: right;">
            <button id="cancelReportBtn" class="modal-close-btn" style="background-color: #777; margin-right: 10px;">Cancel</button>
            <button id="submitReportBtn" class="modal-close-btn" disabled>Submit Report</button>
        </div>
    </div>
</div>

<div id="resultsWelcomeModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 550px;">
        <div class="pro-modal-header" style="padding: 25px 30px;">
            <h2 style="font-size: 1.6em;">Advanced Re-evaluation Mode</h2>
            <p style="font-size: 0.95em;">Instantly see how corrections impact your score. In this mode, you can edit both the original text and your own transcription.</p>
        </div>
        
        <div class="pro-welcome-grid" style="padding: 20px 30px; grid-template-columns: 1fr;">
            <div class="pro-feature-box">
                <div class="pro-feature-header">
                    <div class="pro-feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                    </div>
                    <h3 class="pro-feature-title">How It Works</h3>
                </div>
                <ul class="pro-step-list">
                    <li><b>1. Enter Mode:</b> Click <b>"Enter Re-evaluate Mode"</b>.</li>
                    <li><b>2. Edit:</b> Click directly on words in either box to make corrections. The highlights will guide you.</li>
                    <li><b>3. Calculate:</b> Click <b>"Calculate & Exit Mode"</b> to see your new score.</li>
                </ul>
            </div>
        </div>

        <div class="pro-modal-footer" style="padding: 15px 30px;">
            <label>
                <input type="checkbox" id="dontShowAgainCheckbox">
                Don't show me this again
            </label>
            <button id="closeWelcomeBtn" class="modal-close-btn">Okay, Got It!</button>
        </div>
    </div>
</div>

<div id="exam-view">
    <header class="ssc-header">
        <div class="ssc-header-left">
            <div class="ssc-logo">
                <img id="ssc-logo-img" src="" alt="SSC Logo">
            </div>
            <div class="ssc-title">
                <h1>STAFF SELECTION COMMISSION</h1>
                <p>SSC STENOGRAPHER GRADE C & D EXAMINATION - 2024</p>
            </div>
        </div>
        <div class="ssc-header-right">
            <div id="exam-date"><b>Exam Date:</b> </div>
            <div><b>Shift:</b> 1st Shift (Morning)</div>
            <div><b>Exam Centre:</b> Your Assigned Centre</div>
        </div>
    </header>
    <main class="ssc-main-content">
        <div class="ssc-typing-area">
            <textarea id="typingBox" placeholder="Start typing..." autocapitalize="off" autocorrect="off" spellcheck="false"></textarea>
            <button id="submitBtn" onclick="submitTranscription()">Submit</button>
        </div>
        <aside class="ssc-candidate-panel">
            <div class="ssc-timer-box">
                <span>Time Left:</span>
                <span id="typingTimerDisplay">50:00</span>
            </div>
            <div class="ssc-photo-box">
                <div class="ssc-candidate-photo">
                    <img src="" alt="Candidate Photo">
                </div>
                <span>Profile Picture</span>
            </div>
            <div class="ssc-candidate-info">
                <div><b>Name:</b> <span id="candidate-name-display">CANDIDATE</span></div>
                <div><b>Roll No.:</b> 9876543210</div>
                <div><b>Language:</b> English</div>
                <div><b>Exam -</b> SSC Stenographer Grade C & D Examination - 2024</div>
            </div>
        </aside>
    </main>
</div>

<div id="resetConfirmModal" class="modal-overlay">
    <div class="confirm-dialog">
        <h3>Reset All Progress?</h3>
        <p>This will permanently delete all your saved scores and attempt history from this browser and the cloud. This action cannot be undone.</p>
        <div class="confirm-dialog-actions">
            <button id="cancelResetBtn">Cancel</button>
            <button id="confirmResetBtn">Confirm & Reset</button>
        </div>
    </div>
</div>

<!-- 
    CHANGE 1: The script tag for evaluation2.js has been REMOVED from here.
    Its logic is now inside the new worker.js file.
-->

<script>
 // --- [NEW] Dexie.js Local Database Setup ---
 const localDb = new Dexie("CheckMyStenoDB");
 
 localDb.version(1).stores({
   attempts: '++id, timestamp, dictationName, accuracy, wpm',
   mistakeLibrary: '++id, &[originalWord+typedWord], count',
   overallStats: 'id'
 });

 // --- Firebase Configuration ---
  const firebaseConfig = { apiKey: "AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE", authDomain: "checkmysteno.firebaseapp.com", projectId: "checkmysteno", storageBucket: "checkmysteno.appspot.com", messagingSenderId: "719325115943", appId: "1:719325115943:web:0dd50a67978816d42a8002" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Global State Variables ---
  let player;
  let originalText = "", wordCount = 0, currentPassageTitle = "";
  let totalVideoDuration = 0, currentPlaybackRate = 1, progressInterval;
  let g_collection = "", g_docId = "", candidateId, attemptsRef;
  let transcriptionTimerTotalTime = 0, timeLeft = 0, timer = null, timerStarted = false;
  let g_alignment = [];
  let g_lastTypedText = ""; 
  let g_fullMistakes = 0, g_halfMistakes = 0;
  let isReevaluateModeActive = false;
  
  // --- Initialization ---
  document.addEventListener("DOMContentLoaded", () => {
    initializePractice();
  });
  
  async function initializePractice() {
    const accessCode = localStorage.getItem("currentAccessCode");
    if (!accessCode) {
        showErrorModal("Access Denied", "No access code found. Please log in first.");
        document.body.innerHTML = '';
        return;
    }
    candidateId = accessCode;
    document.getElementById('candidate-name-display').textContent = candidateId.toUpperCase();
    attemptsRef = db.collection("testAnalysis").doc(candidateId).collection("attempts");
    
    // Core setup functions
    setupProgressBar();
    setupExtraControls();
    setLogoSource();
    
    // Initial view is always the selection hub
    showView('selection-view');
    initializeEventListeners();
  }

  function setLogoSource() {
    // Paste your Base64 codes in the variables below.
    const sscLogoBase64 = ""; 
    const candidatePhotoBase64 = "";

    const logoImg = document.getElementById('ssc-logo-img');
    const candidatePhotoImg = document.querySelector('.ssc-candidate-photo img');

    if (logoImg && sscLogoBase64) {
        logoImg.src = sscLogoBase64;
    }
    if (candidatePhotoImg && candidatePhotoBase64) {
        candidatePhotoImg.src = candidatePhotoBase64;
    }
  }
  
  // --- UI AND VIEW MANAGEMENT ---
  function showView(viewId) {
      document.querySelectorAll('.view').forEach(el => el.style.display = 'none');
      document.getElementById('exam-view').style.display = 'none';
      
      const viewToShow = document.getElementById(viewId);
      if (viewToShow) {
        viewToShow.style.display = 'block';
      }
      
      if (viewId === 'exam-view') {
        document.querySelector('.app-container').style.display = 'none';
        document.getElementById('exam-view').style.display = 'flex';
      } else {
        document.querySelector('.app-container').style.display = 'block';
      }
      
      if (viewId === 'selection-view') {
          showSelectionHub();
          clearState();
          if(player && typeof player.stopVideo === 'function') player.stopVideo();
      }
  }
  
  function showSelectionHub() {
      document.getElementById('dictation-type-hub').style.display = 'grid';
      document.querySelectorAll('.grid-container').forEach(c => c.style.display = 'none');
  }

  function showDictationGrid(type) {
      document.getElementById('dictation-type-hub').style.display = 'none';
      document.querySelectorAll('.grid-container').forEach(c => c.style.display = 'none');
      
      const containerId = `${type}-view-container`;
      document.getElementById(containerId).style.display = 'block';
  }
  
  function goHome() {
      if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
      showView('selection-view');
  }
  
  function clearStateAndGoBack() {
      showView('selection-view');
  }
  
  // --- DATA LOADING AND GRID RENDERING ---
  async function loadAndRenderCategory(categoryConfig) {
      showDictationGrid(categoryConfig.type);
      const grid = document.getElementById(categoryConfig.gridId);
      grid.innerHTML = '<div class="spinner"></div>';

      try {
          const indexDocRef = db.collection(categoryConfig.indexCollection).doc('main');
          const indexDoc = await indexDocRef.get();

          if (!indexDoc.exists) throw new Error(`${categoryConfig.name} index not found.`);
          
          const indexData = indexDoc.data();
          const totalPassages = indexData.totalPassages || 50;
          const passageStatusMap = indexData.passages || {};
          const progressData = JSON.parse(localStorage.getItem(`stenoProgress_${candidateId}`) || '{}');

          grid.innerHTML = ''; 

          const renderCard = (docId, data, passageNum) => {
              const card = document.createElement('div');
              card.className = 'passage-card';
              card.dataset.collection = categoryConfig.dataCollection;
              card.dataset.docId = docId;

              let status = data.status || 'unavailable';
              let title = data.title || `${categoryConfig.name} Passage ${passageNum || docId}`;
              let meta = data.meta || categoryConfig.defaultMeta;
              const key = `${categoryConfig.dataCollection}-${docId}`;
              const attemptData = progressData[key];
              const isAttempted = !!attemptData;
              
              let statusTag = '', buttonHtml = '';
              switch(status) {
                  case 'available':
                      statusTag = isAttempted 
                          ? `<div class="status-tag attempted">${attemptData.accuracy}% | ${attemptData.wpm} WPM</div>`
                          : `<div class="status-tag attempted">Available</div>`;
                      buttonHtml = `<button class="take-test-btn">Take Test</button>`;
                      break;
                  case 'scheduled':
                      statusTag = `<div class="status-tag">Scheduled: ${data.scheduledDate || 'TBA'}</div>`;
                      buttonHtml = `<button class="take-test-btn" disabled>Scheduled</button>`;
                      break;
                  default:
                      statusTag = `<div class="status-tag">Not Available</div>`;
                      buttonHtml = `<button class="take-test-btn" disabled>Not Available</button>`;
                      break;
              }

              card.innerHTML = `
                  <div class="card-header">
                      <div class="card-title-group">
                          <span class="status-dot ${isAttempted ? 'attempted' : ''}"></span>
                          <h3>${title}</h3>
                      </div>
                      ${statusTag}
                  </div>
                  <div class="card-meta">${meta}</div>
                  <div class="card-buttons">${buttonHtml}</div>
              `;
              grid.appendChild(card);
          };

          if (categoryConfig.docPrefix) {
              for (let i = 1; i <= totalPassages; i++) {
                  const docId = `${categoryConfig.docPrefix}_${String(i).padStart(3, '0')}`;
                  const data = passageStatusMap[docId] || {};
                  renderCard(docId, data, i);
              }
          } else {
              const sortedKeys = Object.keys(passageStatusMap).sort().reverse(); 
              for (const docId of sortedKeys) {
                  const data = passageStatusMap[docId];
                  renderCard(docId, data, null);
              }
          }

      } catch (error) {
          console.error(`Error loading ${categoryConfig.name}:`, error);
          grid.innerHTML = `<p>Could not load ${categoryConfig.name.toLowerCase()}. Please try again.</p>`;
      }
  }

  function loadProgressiveDictations() {
    loadAndRenderCategory({
        type: 'progressive', name: 'Progressive Dictations', gridId: 'progressive-grid',
        indexCollection: 'progressive_index', dataCollection: 'progressive_passages',
        docPrefix: 'prog', defaultMeta: 'Progressive Magazine'
    });
  }
  
  function loadSscPreviousYearDictations() {
      loadAndRenderCategory({
          type: 'ssc-previous-year',
          name: 'SSC Previous Year Dictations',
          gridId: 'ssc-previous-year-grid',
          indexCollection: 'sscPreviousYear_index',
          dataCollection: 'sscPreviousYear_passages',
          docPrefix: null,
          defaultMeta: 'Official SSC Exam Paper'
      });
  }

  function loadGeneralMatterDictations() {
    loadAndRenderCategory({
        type: 'general-matter', name: 'General Matter Dictations', gridId: 'general-matter-grid',
        indexCollection: 'generalMatter_index', dataCollection: 'generalMatter_passages',
        docPrefix: 'gen', defaultMeta: 'General Topic'
    });
  }

  function loadImportantKCDictations() {
    loadAndRenderCategory({
        type: 'important-kc', name: 'Most Important Kailash Chandra', gridId: 'important-kc-grid',
        indexCollection: 'importantKC_index', dataCollection: 'importantKC_passages',
        docPrefix: 'kc', defaultMeta: 'Kailash Chandra Magazine'
    });
  }

  function loadLegalDictations() {
    loadAndRenderCategory({
        type: 'legal-dictation', name: 'Legal Dictations', gridId: 'legal-dictation-grid',
        indexCollection: 'legal_index', dataCollection: 'legal_passages',
        docPrefix: 'legal', defaultMeta: 'Legal Matter'
    });
  }

  function loadPresidentSpeeches() {
    loadAndRenderCategory({
        type: 'president-speech', name: "President's Speeches", gridId: 'president-speech-grid',
        indexCollection: 'presidentSpeech_index', dataCollection: 'presidentSpeech_passages',
        docPrefix: 'speech', defaultMeta: 'Official Address'
    });
  }

  function loadMonthlyProgressive() {
    showDictationGrid('monthly-progressive');
    loadAndRenderMonthlyProgressive();
  }

  async function loadAndRenderMonthlyProgressive(filterYear = '', filterMonth = '') {
      const grid = document.getElementById('monthly-progressive-grid');
      grid.innerHTML = '<div class="spinner"></div>';
      
      const config = {
          name: 'Monthly Progressive',
          indexCollection: 'monthlyProgressive_index',
          dataCollection: 'monthlyProgressive_passages',
          defaultMeta: 'Monthly Magazine Passage'
      };

      const renderCard = (docId, data, passageNum) => {
          const card = document.createElement('div');
          card.className = 'passage-card';
          card.dataset.collection = config.dataCollection;
          card.dataset.docId = docId;

          let status = data.status || 'unavailable';
          let title = data.title || `${config.name} Passage ${passageNum || docId}`;
          let meta = data.meta || config.defaultMeta;
          const key = `${config.dataCollection}-${docId}`;
          const progressData = JSON.parse(localStorage.getItem(`stenoProgress_${candidateId}`) || '{}');
          const attemptData = progressData[key];
          const isAttempted = !!attemptData;
          
          let statusTag = '', buttonHtml = '';
          switch(status) {
              case 'available':
                  statusTag = isAttempted ? `<div class="status-tag attempted">${attemptData.accuracy}% | ${attemptData.wpm} WPM</div>` : `<div class="status-tag attempted">Available</div>`;
                  buttonHtml = `<button class="take-test-btn">Take Test</button>`;
                  break;
              case 'scheduled':
                  statusTag = `<div class="status-tag">Scheduled: ${data.scheduledDate || 'TBA'}</div>`;
                  buttonHtml = `<button class="take-test-btn" disabled>Scheduled</button>`;
                  break;
              default:
                  statusTag = `<div class="status-tag">Not Available</div>`;
                  buttonHtml = `<button class="take-test-btn" disabled>Not Available</button>`;
                  break;
          }

          card.innerHTML = `
              <div class="card-header">
                  <div class="card-title-group">
                      <span class="status-dot ${isAttempted ? 'attempted' : ''}"></span>
                      <h3>${title}</h3>
                  </div>
                  ${statusTag}
              </div>
              <div class="card-meta">${meta}</div>
              <div class="card-buttons">${buttonHtml}</div>
          `;
          grid.appendChild(card);
      };

      try {
          let query;
          if (filterYear && filterMonth) {
              const docId = `${filterYear}_${filterMonth}`;
              query = db.collection(config.indexCollection).doc(docId).get();
          } else if (filterYear) {
               query = db.collection(config.indexCollection)
                         .where(firebase.firestore.FieldPath.documentId(), '>=', `${filterYear}_01`)
                         .where(firebase.firestore.FieldPath.documentId(), '<=', `${filterYear}_12`)
                         .get();
          } else {
              query = db.collection(config.indexCollection).orderBy(firebase.firestore.FieldPath.documentId(), "desc").get();
          }
          
          const querySnapshot = await query;
          grid.innerHTML = '';
          let passagesFound = false;

          const processDoc = (doc) => {
              if (!doc.exists) return;
              passagesFound = true;
              const passageStatusMap = doc.data().passages || {};
              const sortedKeys = Object.keys(passageStatusMap).sort().reverse();
              for (const docId of sortedKeys) {
                  renderCard(docId, passageStatusMap[docId], null);
              }
          };

          if (querySnapshot.docs) { 
              querySnapshot.forEach(processDoc);
          } else { 
              processDoc(querySnapshot);
          }

          if (!passagesFound) {
              grid.innerHTML = `<p>No passages found for the selected filter.</p>`;
          }

      } catch (error) {
          console.error(`Error loading ${config.name}:`, error);
          grid.innerHTML = `<p>Could not load ${config.name.toLowerCase()}. Please try again.</p>`;
      }
  }

  async function loadPractice(collectionName, docId) {
    g_collection = collectionName;
    g_docId = docId;

    if (!collectionName || !docId) {
        showErrorModal("Passage Error", "Could not identify the passage.");
        return;
    }
    
    document.getElementById('fullPageLoader').style.display = 'flex';

    try {
        const docRef = db.collection(collectionName).doc(docId);
        const docSnap = await docRef.get();
        if (!docSnap.exists) throw new Error("Passage data not found.");
        
        const passageData = docSnap.data();
        originalText = passageData.originalText;
        wordCount = passageData.wordCount;
        currentPassageTitle = passageData.title;
        
        saveState({ view: 'player-view', g_collection, g_docId, originalText, wordCount, audioUrl: passageData.audioUrl, title: currentPassageTitle });

        showView('player-view');
        setPlayerLoading(true);
        document.getElementById('player-subtitle').textContent = currentPassageTitle;
        loadVideo(passageData.audioUrl, false);

    } catch (error) { 
        showErrorModal("Loading Error", "Error: " + error.message);
        showView('selection-view');
    } finally {
        document.getElementById('fullPageLoader').style.display = 'none';
    }
  }

  // --- STATE MANAGEMENT ---
  function saveState(state) { localStorage.setItem('stenoState', JSON.stringify(state)); }
  function clearState() { localStorage.removeItem('stenoState'); }
  function restoreSession() {
      const savedState = JSON.parse(localStorage.getItem('stenoState'));
      if (!savedState || savedState.view !== 'exam-view') {
          showView('selection-view');
          return;
      }
      g_collection = savedState.g_collection;
      g_docId = savedState.g_docId;
      originalText = savedState.originalText;
      wordCount = savedState.wordCount;
      currentPassageTitle = savedState.title;
      showView('exam-view');
      document.documentElement.requestFullscreen().catch(err => {});
      document.getElementById('typingBox').value = savedState.typedText || '';
      transcriptionTimerTotalTime = savedState.totalTime;
      timeLeft = savedState.timeLeft;
      timerStarted = true;
      startTimer();
  }
  
  // --- PLAYER AND EXAM LOGIC ---
  function onYouTubeIframeAPIReady() {}
  function extractVideoID(url) { if (typeof url !== 'string') return null; const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/; return (url.match(regex) || [])[1] || null; }
  function loadVideo(url, autoPlay = false) {
    const videoId = extractVideoID(url);
    if (!videoId) {
        showErrorModal("Invalid URL", "Invalid YouTube URL provided: " + url);
        return;
    }
    const onPlayerReady = (event) => {
    totalVideoDuration = event.target.getDuration();
    setPlayerLoading(false);
    setPlaybackSpeed();
};
    if (player && typeof player.loadVideoById === 'function' && player.getIframe()?.isConnected) {
        player.loadVideoById(videoId);
        const readyCheck = setInterval(() => {
            if (player.getDuration() > 0 && player.getPlayerState() !== -1) {
                clearInterval(readyCheck);
                onPlayerReady({target: player});
            }
        }, 100);
    } else {
        if(player && typeof player.destroy === 'function') player.destroy();
        player = new YT.Player('player', {
            height: '1',
            width: '1',
            videoId,
            playerVars: { 'autoplay': autoPlay ? 1 : 0, 'controls': 0 },
            events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
        });
    }
  }
  function onPlayerStateChange(event){
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    if(event.data === YT.PlayerState.PLAYING){
        playBtn.style.display = 'none'; pauseBtn.style.display = 'flex';
        trackProgress();
    } else {
        playBtn.style.display = 'flex'; pauseBtn.style.display = 'none';
        clearInterval(progressInterval);
    }
  }
  function setPlaybackSpeed(){
      if(!player||!player.setPlaybackRate)return;
      const targetWPM = parseInt(document.getElementById('wpmSpeed').value);
      if(isNaN(targetWPM)||!wordCount||!totalVideoDuration) currentPlaybackRate = 1;
      else { const originalWPM=wordCount/(totalVideoDuration/60); currentPlaybackRate=originalWPM>0?targetWPM/originalWPM:1; }
      player.setPlaybackRate(currentPlaybackRate);
      updateVideoTimeDisplay();
  }
  function togglePlay(){if(!player||!player.getPlayerState)return;player.getPlayerState()===YT.PlayerState.PLAYING?player.pauseVideo():player.playVideo();}
  function restartVideo() { if(player) { player.seekTo(0, true); player.playVideo(); } }
  function seekRelative(seconds) { if (!player || !player.getCurrentTime) return; const newTime = player.getCurrentTime() + seconds; player.seekTo(newTime, true); }
  function trackProgress(){
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
          if(!player || typeof player.getCurrentTime !== 'function' || !totalVideoDuration) return;
          updateVideoTimeDisplay();
      }, 250);
  }
  function setupProgressBar(){
      document.getElementById("progressBar").addEventListener("click", function(e){
          if(!player || !player.seekTo || !totalVideoDuration) return;
          const rect = e.currentTarget.getBoundingClientRect();
          const clickPosition = (e.clientX - rect.left) / rect.width;
          player.seekTo(clickPosition * totalVideoDuration, true);
      });
  }
  function formatTime(s){const m=Math.floor(s/60).toString().padStart(2,'0');const sec=Math.round(s%60).toString().padStart(2,'0');return isNaN(m)||isNaN(sec)?"00:00":`${m}:${sec}`}
  function updateVideoTimeDisplay() {
      if (!player || typeof player.getCurrentTime !== 'function') return;
      const rawCurrentTime = player.getCurrentTime();
      const effectiveCurrentTime = rawCurrentTime / currentPlaybackRate;
      const effectiveTotalDuration = totalVideoDuration / currentPlaybackRate;
      document.getElementById("progress-fill").style.width = (rawCurrentTime / totalVideoDuration) * 100 + "%";
      document.getElementById('current-time').innerText = formatTime(effectiveCurrentTime);
      document.getElementById('total-time').innerText = formatTime(effectiveTotalDuration);
  }
  function setPlayerLoading(isLoading) {
      document.getElementById('player-loader').style.display = isLoading ? 'flex' : 'none';
      document.querySelectorAll('#player-view button, #player-view select').forEach(el => {
          if(el.id !== 'startTranscriptionBtn') el.disabled = isLoading;
      });
      document.getElementById('startTranscriptionBtn').disabled = true;
      if (!isLoading) {
          document.getElementById('startTranscriptionBtn').disabled = false;
      }
  }
  function setupExtraControls() {
      document.getElementById('volume-slider').addEventListener('input', (e) => player?.setVolume(e.target.value));
      document.addEventListener('keydown', (e) => {
          if (document.getElementById('player-view').style.display === 'block') {
             if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); togglePlay(); }
             if (e.code === 'ArrowLeft') { e.preventDefault(); seekRelative(-5); }
             if (e.code === 'ArrowRight') { e.preventDefault(); seekRelative(5); }
          }
      });
      const today = new Date();
      document.getElementById('exam-date').innerHTML = `<b>Exam Date:</b> ${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;
  }
  function adjustSpeed(amount) {
      const select = document.getElementById('wpmSpeed');
      const currentIndex = select.selectedIndex;
      const newIndex = currentIndex + (amount / 5);
      if (newIndex >= 0 && newIndex < select.options.length) {
          select.selectedIndex = newIndex;
          setPlaybackSpeed();
      }
  }
  function showInstructions() {
      if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
      document.getElementById('instructions-modal').classList.add('visible');
  }
  function startTranscriptionTest() {
      document.getElementById('instructions-modal').classList.remove('visible');
      document.documentElement.requestFullscreen().catch(err => console.warn(`Fullscreen failed: ${err.message}.`));
      showView('exam-view');
      transcriptionTimerTotalTime = parseInt(document.getElementById('timer-select').value) * 60;
      timeLeft = transcriptionTimerTotalTime;
      document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
      document.getElementById('typingBox').value = '';
      document.getElementById('typingBox').focus();
      document.getElementById('typingBox').addEventListener('keydown', handleFirstKeydown);
      
      const currentState = JSON.parse(localStorage.getItem('stenoState'));
      saveState({ ...currentState, view: 'exam-view', totalTime: transcriptionTimerTotalTime, timeLeft: timeLeft, typedText: '' });
  }
  function handleFirstKeydown() { if (!timerStarted) { timerStarted = true; startTimer(); document.getElementById('typingBox').removeEventListener('keydown', handleFirstKeydown); } }
  function startTimer() {
      if (timer) return;
      timer = setInterval(() => {
          if (--timeLeft < 0) {
              clearInterval(timer); alert("Time is up! Submitting automatically."); submitTranscription();
          } else {
              document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
              const currentState = JSON.parse(localStorage.getItem('stenoState'));
              if(currentState) saveState({ ...currentState, timeLeft, typedText: document.getElementById('typingBox').value });
          }
      }, 1000);
  }
  function resetTimer() {
    if (timer) clearInterval(timer);
    timer = null; timerStarted = false; timeLeft = transcriptionTimerTotalTime;
    document.getElementById("typingTimerDisplay").innerText = formatTime(timeLeft);
  }
  
  function escapeHtml(s=""){ return s.toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function displayAndRenderResults(resultData, originalTextForDisplay, isReevaluation = false) {
    g_alignment = resultData.alignment; // Save alignment for interactivity
    g_fullMistakes = resultData.fullMistakes;
    g_halfMistakes = resultData.halfMistakes;

    let resultHtmlContent = "";
    // Generate the highlighted HTML for the user's typed text from the alignment data
    for (let k = 0; k < g_alignment.length; k++) {
        const entry = g_alignment[k];
        let wordHtml = '', tooltipText = '', statusIcon = '✔️';

        if (entry.type === "match") {
            if(entry.mistakeType === 'capitalization') {
                tooltipText = `Capitalization: Typed "${escapeHtml(entry.t)}" (was "${escapeHtml(entry.o)}")`;
                wordHtml = `<span class='highlight capitalization' data-mistake-type='${entry.mistakeType}' data-tooltip-text='${tooltipText}'>${escapeHtml(entry.t)}</span>`;
                statusIcon = '⚠️';
            } else if (entry.mistakeType === 'punctuation') {
                tooltipText = `Punctuation: Typed "${escapeHtml(entry.t)}" (was "${escapeHtml(entry.o)}")`;
                wordHtml = `<span class='highlight punctuation' data-mistake-type='${entry.mistakeType}' data-tooltip-text='${tooltipText}'>${escapeHtml(entry.t)}</span>`;
                statusIcon = '⚠️';
            } else {
                 wordHtml = `<span>${escapeHtml(entry.t) || ''}</span>`;
                 tooltipText = "Correct";
            }
        } else if (entry.type === "del") {
            tooltipText = `Omitted: "${escapeHtml(entry.o)}"`;
            wordHtml = `<span class='highlight omission' data-mistake-type='omission' data-tooltip-text='${tooltipText}'>(${escapeHtml(entry.o)})</span>`;
            statusIcon = '❌';
        } else if (entry.type === "ins") {
            tooltipText = `Extra Word: "${escapeHtml(entry.t)}"`;
            wordHtml = `<span class='highlight extra' data-mistake-type='extra' data-tooltip-text='${tooltipText}'>${escapeHtml(entry.t)}</span>`;
            statusIcon = '❌';
        } else if (entry.type === "sub") {
            tooltipText = `You typed: "${escapeHtml(entry.t)}" (was "${escapeHtml(entry.o)}")`;
            wordHtml = `<span class='highlight spelling' data-mistake-type='spelling' data-tooltip-text='${tooltipText}'>${escapeHtml(entry.t)} (<b>${escapeHtml(entry.o)}</b>)</span>`;
            statusIcon = '⚠️';
        }
        entry.statusIcon = statusIcon;
        resultHtmlContent += `<span class="word-wrapper" data-index="${k}" data-status-icon="${statusIcon}" data-mistake-type="${entry.mistakeType}">${wordHtml}</span> `;
    }

    if (isReevaluation) {
        const reevalContainer = document.getElementById('reevaluated-accuracy-container');
        if(reevalContainer) { reevalContainer.innerHTML = `<div class="stats-row"><div class="stat-pill" style="background-color: var(--accent-purple);">Re-evaluated Accuracy: ${resultData.accuracy}%</div></div>`; }
        document.getElementById('editableTypedText').innerHTML = resultHtmlContent;
        let originalTextHtml = g_alignment.map((entry, index) => { if (entry.type === 'ins') return ''; return `<span class="word-wrapper" data-index="${index}" data-mistake-type="${entry.mistakeType}">${escapeHtml(entry.o || '')}</span>`; }).join(' ');
        document.getElementById('editableOriginalText').innerHTML = originalTextHtml;
        initializeResultInteractivity();
    } else {
        const renderData = {
            dictationName: currentPassageTitle || "Practice Passage",
            totalWords: resultData.totalWords,
            typedWords: resultData.typedWords,
            fullMistakes: resultData.fullMistakes,
            halfMistakes: resultData.halfMistakes,
            mistakePercent: resultData.mistakePercent,
            accuracy: resultData.accuracy,
            typedKeystrokes: resultData.typedKeystrokes,
            typingSpeed: resultData.typingSpeed,
            testDate: new Date().toLocaleString('en-IN', { dateStyle: 'long', timeStyle: 'short' }),
            highlightedHtml: resultHtmlContent
        };
        renderResultSheet(renderData, originalTextForDisplay);
        showView('results-view');
    }
  }


function renderResultSheet(data, originalTextForDisplay) {
    const container = document.getElementById('resultSheetContainer');
    let originalTextHtml = g_alignment.map((entry, index) => { let mistakeType = entry.mistakeType || 'correct'; if (entry.type === 'ins') return ''; return `<span class="word-wrapper" data-index="${index}" data-mistake-type="${mistakeType}">${escapeHtml(entry.o || '')}</span>`; }).join(' ');
    
    container.innerHTML = `
    <div class="result-sheet-container">
        <h1>Result Sheet:</h1>
        <div class="stats-container">
            <div class="stats-row"><div class="stat-pill full-width">${escapeHtml(data.dictationName)}</div></div>
            <div class="stats-row">
                <div class="stat-pill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>Total Words: ${data.totalWords}</div>
                <div class="stat-pill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>Typed Words: ${data.typedWords}</div>
                <div class="stat-pill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13.25a.75.75 0 00-1.5 0v6.5c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75v-5.5z" clip-rule="evenodd" /></svg>Typing Speed: ${data.typingSpeed} WPM</div>
            </div>
            <div class="stats-row">
                <div class="stat-pill red"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>Full Mistakes: ${data.fullMistakes}</div>
                <div class="stat-pill amber"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>Half Mistakes: ${data.halfMistakes}</div>
                <div class="stat-pill">Total % of Mistakes: ${data.mistakePercent}%</div>
                <div class="stat-pill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Accuracy: ${data.accuracy}%</div>
            </div>
            <div id="reevaluated-accuracy-container"></div>
            <div class="stats-row"><div class="stat-pill">Test Date: ${escapeHtml(data.testDate)}</div></div>
        </div>
        <div class="legend-container">
            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--hl-additions);"></span> Additions / Substitutions</div>
            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--hl-omissions);"></span> Omissions</div>
            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--hl-spelling);"></span> Spelling Mistakes</div>
            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--hl-capitalization);"></span> Capitalization Mistakes</div>
            <div class="legend-item"><span class="legend-color-box" style="background-color: var(--hl-punctuation);"></span> Punctuation Mistakes</div>
        </div>
        <div class="result-controls">
            <div class="filter-section">
                <label for="mistakeFilter">Filter Mistakes:</label>
                <select id="mistakeFilter" onchange="filterMistakes(this.value)"><option value="all">Show All Mistakes</option><option value="omission">Omissions Only</option><option value="extra">Additions Only</option><option value="spelling">Spelling Only</option><option value="capitalization">Capitalization Only</option><option value="punctuation">Punctuation Only</option></select>
            </div>
            <div class="action-section"><div class="reevaluate-wrapper"><button id="toggleReevaluateBtn" class="view-switch-btn">Enter Re-evaluate Mode</button><span class="tooltip-icon" data-tooltip="Enter a special mode to edit BOTH your text and the original text, then recalculate your score to see the difference.">?</span></div><button id="reportErrorBtn" class="view-switch-btn" style="background-color: #f97316; color: white;">Report Error</button></div>
            <button id="viewSwitchBtn" class="view-switch-btn">Switch to Top/Bottom View</button>
        </div>
        <div id="comparisonColumns" class="columns view-side-by-side">
            <div class="col" id="typedCol"><strong>Your Transcription:</strong><p id="editableTypedText" contenteditable="false">${data.highlightedHtml}</p></div>
            <div class="col" id="originalCol"><strong>Original Text (Click to edit):</strong><p id="editableOriginalText" contenteditable="false">${originalTextHtml}</p></div>
        </div>
    </div>`;
    
    if (!localStorage.getItem('hideResultsWelcome')) { document.getElementById('resultsWelcomeModal').classList.add('visible'); }
    const switchBtn = document.getElementById('viewSwitchBtn'); const columnsContainer = document.getElementById('comparisonColumns'); const typedCol = document.getElementById('typedCol'); const originalCol = document.getElementById('originalCol'); switchBtn.addEventListener('click', () => { const isSideBySide = columnsContainer.classList.contains('view-side-by-side'); if (isSideBySide) { columnsContainer.classList.remove('view-side-by-side'); columnsContainer.classList.add('view-top-bottom'); columnsContainer.prepend(typedCol); switchBtn.textContent = 'Switch to Side-by-Side View'; } else { columnsContainer.classList.remove('view-top-bottom'); columnsContainer.classList.add('view-side-by-side'); columnsContainer.appendChild(originalCol); switchBtn.textContent = 'Switch to Top/Bottom View'; } }); 
    document.getElementById('printReportBtn').addEventListener('click', () => window.print()); 
    initializeResultInteractivity(); 
}

function initializeResultInteractivity() {
    const columns = document.getElementById('comparisonColumns'); if (!columns) return;
    const originalTextP = document.getElementById('editableOriginalText'); if (originalTextP) { originalTextP.contentEditable = false; }
    columns.addEventListener('click', (e) => { const target = e.target.closest('.word-wrapper'); if (!target) return; const wordIndex = target.dataset.index; if (wordIndex === null) return; document.querySelectorAll('.active-highlight').forEach(el => el.classList.remove('active-highlight')); document.querySelectorAll(`.word-wrapper[data-index="${wordIndex}"]`).forEach(el => el.classList.add('active-highlight')); const parentCol = target.closest('.col'); if (!parentCol) return; const otherColId = parentCol.id === 'typedCol' ? 'originalCol' : 'typedCol'; const correspondingWord = document.querySelector(`#${otherColId} .word-wrapper[data-index="${wordIndex}"]`); if (correspondingWord) { correspondingWord.scrollIntoView({ behavior: 'smooth', block: 'center' }); } });
    document.getElementById('toggleReevaluateBtn').addEventListener('click', toggleReevaluateMode);
    document.getElementById('reportErrorBtn').addEventListener('click', showReportModal);
}
function getCleanTextFromAlignment(type = 'typed') {
    if (!g_alignment || g_alignment.length === 0) return "";
    let textParts = []; g_alignment.forEach(entry => { if (type === 'typed') { if (entry.type === 'match' || entry.type === 'sub' || entry.type === 'ins') { textParts.push(entry.t || ''); } } else { if (entry.type === 'match' || entry.type === 'sub' || entry.type === 'del') { textParts.push(entry.o || ''); } } });
    return textParts.join(' ').replace(/\s+/g, ' ').trim();
}

function toggleReevaluateMode() {
    isReevaluateModeActive = !isReevaluateModeActive;
    const resultsView = document.getElementById('results-view'); const toggleBtn = document.getElementById('toggleReevaluateBtn'); const typedTextP = document.getElementById('editableTypedText'); const originalTextP = document.getElementById('editableOriginalText');
    if (isReevaluateModeActive) { resultsView.classList.add('reevaluate-mode-active'); toggleBtn.textContent = 'Calculate & Exit Mode'; toggleBtn.style.backgroundColor = 'var(--accent-purple)'; toggleBtn.style.color = 'white'; const cleanTypedText = getCleanTextFromAlignment('typed'); const cleanOriginalText = getCleanTextFromAlignment('original'); typedTextP.innerHTML = cleanTypedText; originalTextP.innerHTML = cleanOriginalText; typedTextP.contentEditable = true; originalTextP.contentEditable = true; alert("Re-evaluate Mode is ON. You can now edit both your transcription and the original text.");
    } else { 
        // --- SPINNER IS SHOWN HERE ---
        document.getElementById('fullPageLoader').style.display = 'flex';
        
        resultsView.classList.remove('reevaluate-mode-active'); 
        toggleBtn.textContent = 'Enter Re-evaluate Mode'; 
        toggleBtn.style.backgroundColor = ''; 
        toggleBtn.style.color = ''; 
        
        const correctedOriginalText = originalTextP.innerText; 
        const correctedTypedText = typedTextP.innerText; 
        g_lastTypedText = correctedTypedText; 
        
        typedTextP.contentEditable = false; 
        originalTextP.contentEditable = false; 
        
        if (!correctedOriginalText) { 
            alert("The original text cannot be empty for re-evaluation.");
            const analysisOptions = { countCommaMistakes: document.getElementById("includeComma")?.checked || false };
            
            const reevaluateWorker = new Worker('worker.js');
            reevaluateWorker.onmessage = function(event) {
                const result = event.data;
                displayAndRenderResults(result, originalText, true);
                document.getElementById('fullPageLoader').style.display = 'none'; // Hide spinner on completion
                reevaluateWorker.terminate();
            };
            reevaluateWorker.postMessage({
                originalText: originalText,
                typedText: g_lastTypedText,
                timeTakenSeconds: 0,
                options: analysisOptions
            });
            return; 
        } 
        
        const analysisOptions = { countCommaMistakes: document.getElementById("includeComma")?.checked || false };
        
        const finalReevaluateWorker = new Worker('worker.js');
        finalReevaluateWorker.onmessage = function(event) {
            const result = event.data;
            displayAndRenderResults(result, correctedOriginalText, true);
            
            // --- SPINNER IS HIDDEN HERE ---
            document.getElementById('fullPageLoader').style.display = 'none';
            
            alert("Score has been re-evaluated with your corrections. Note: This updated score is for your reference only and is not saved.");
            finalReevaluateWorker.terminate();
        };
        finalReevaluateWorker.postMessage({
            originalText: correctedOriginalText,
            typedText: correctedTypedText,
            timeTakenSeconds: 0,
            options: analysisOptions
        });
    }
}


// =================================================================================
// CHANGE 2: THIS IS THE UPDATED FUNCTION THAT USES THE WEB WORKER
// =================================================================================
async function submitTranscription() {
    const timeTakenSeconds = (transcriptionTimerTotalTime - timeLeft) > 0 ? (transcriptionTimerTotalTime - timeLeft) : 0;
    clearState();
    if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});

    // Show a loading spinner so the user knows work is being done in the background
    document.getElementById('fullPageLoader').style.display = 'flex';

    try {
        if (!originalText) {
            throw new Error("Original transcript not found. Please try the test again.");
        }
        const typedText = document.getElementById('typingBox').value;
        g_lastTypedText = typedText;

        if (typedText.trim().split(/\s+/).filter(Boolean).length < 10) {
            alert("Please type at least 10 words.");
            goHome();
            document.getElementById('fullPageLoader').style.display = 'none'; // Hide loader
            return;
        }

        // --- CORE CHANGE IS HERE ---
        // 1. Create a new worker from the worker.js file.
        const analysisWorker = new Worker('worker.js');

        // 2. Set up a listener to wait for the worker to send the results back.
        analysisWorker.onmessage = function(event) {
            console.log("Main page received results from worker!");
            const result = event.data; // The result object is sent back from the worker

            // 3. The job is done! Now use the results to update the page.
            // This part is the same as your old function.
            displayAndRenderResults(result, originalText, false);
            saveProgressToLocalStorage({ accuracy: result.accuracy, typingSpeed: result.typingSpeed });
            saveAttemptHybrid(originalText, typedText, parseFloat(result.accuracy), result.fullMistakes, result.halfMistakes, parseFloat(result.typingSpeed), timeTakenSeconds, result.totalWords);
            
            // 4. Hide the loader and terminate the worker to save resources
            document.getElementById('fullPageLoader').style.display = 'none';
            analysisWorker.terminate();
            resetTimer();
        };

        // 5. Define the options and send the job TO the worker to start the calculation.
        const analysisOptions = {
            countCommaMistakes: document.getElementById("includeComma")?.checked || false
        };

        console.log("Main page is sending the job to the worker.");
        analysisWorker.postMessage({
            originalText: originalText,
            typedText: typedText,
            timeTakenSeconds: timeTakenSeconds,
            options: analysisOptions
        });
        
    } catch (error) { 
        console.error("!!! ERROR during transcription processing:", error); 
        showErrorModal("Result Error", "An error occurred while generating your results. Please try again.");
        document.getElementById('fullPageLoader').style.display = 'none'; // Hide loader on error
        goHome(); 
        resetTimer();
    }
}


function filterMistakes(type) {
    document.querySelectorAll('.active-highlight').forEach(el => el.classList.remove('active-highlight'));
    const wordWrappers = document.querySelectorAll('#comparisonColumns .word-wrapper');
    wordWrappers.forEach(wrapper => { const mistakeType = wrapper.getAttribute('data-mistake-type'); let shouldShow = false; if (type === "all" || mistakeType === 'correct') { shouldShow = true; } else if (type === "omission-substitution") { if (mistakeType === 'omission' || mistakeType === 'extra') { shouldShow = true; } } else { if (mistakeType === type) { shouldShow = true; } } wrapper.style.display = shouldShow ? 'inline' : 'none'; });
}

// --- [NEW] UPDATE MISTAKE LIBRARY FUNCTION ---
async function updateMistakeLibrary(alignmentData) {
    const spellingMistakes = alignmentData.filter(e => e.type === 'sub');
    if (spellingMistakes.length === 0) {
        console.log("No spelling mistakes to log.");
        return;
    }

    await localDb.transaction('rw', localDb.mistakeLibrary, async () => {
        for (const mistake of spellingMistakes) {
            const originalWord = (mistake.o || '').replace(/[.,]$/, '').toLowerCase();
            const typedWord = (mistake.t || '').replace(/[.,]$/, '').toLowerCase();

            if (!originalWord || !typedWord || originalWord === typedWord) continue;

            const existingEntry = await localDb.mistakeLibrary.where({ originalWord, typedWord }).first();
            
            if (existingEntry) {
                await localDb.mistakeLibrary.update(existingEntry.id, { count: existingEntry.count + 1 });
            } else {
                await localDb.mistakeLibrary.add({ originalWord, typedWord, count: 1 });
            }
        }
    });
    console.log(`📚 ${spellingMistakes.length} spelling mistake(s) processed for the library.`);
}

// --- [NEW] UPDATE OVERALL STATS FUNCTION ---
async function updateOverallStats(newAttemptStats) {
    await localDb.transaction('rw', localDb.overallStats, async () => {
        const stats = await localDb.overallStats.get(1);

        if (!stats) {
            await localDb.overallStats.put({
                id: 1, totalAttempts: 1,
                bestAccuracy: newAttemptStats.accuracy, bestWPM: newAttemptStats.wpm,
                avgAccuracy: newAttemptStats.accuracy, avgWpm: newAttemptStats.wpm
            });
            console.log("📊 First-ever overall stats record created.");
            return;
        }

        const oldTotal = stats.totalAttempts || 0;
        const newTotal = oldTotal + 1;
        const newAvgAccuracy = ((stats.avgAccuracy * oldTotal) + newAttemptStats.accuracy) / newTotal;
        const newAvgWpm = ((stats.avgWpm * oldTotal) + newAttemptStats.wpm) / newTotal;

        await localDb.overallStats.put({
            id: 1, totalAttempts: newTotal,
            avgAccuracy: newAvgAccuracy, avgWpm: newAvgWpm,
            bestAccuracy: Math.max(stats.bestAccuracy, newAttemptStats.accuracy),
            bestWPM: Math.max(stats.bestWPM, newAttemptStats.wpm)
        });
        console.log("📊 Overall stats updated in the background.");
    });
}

// --- [MODIFIED] HYBRID SAVE SYSTEM ---
async function saveAttemptHybrid(original, typed, accuracy, full, half, wpm, time, words) {
  if (!candidateId) { console.error("Candidate not initialized, cannot save."); return; }
  
  const finalHtmlContent = document.getElementById('editableTypedText').innerHTML;
  const numericAccuracy = parseFloat(accuracy);
  const numericWpm = parseFloat(wpm);

  const fullResultData = {
    timestamp: new Date().toISOString(),
    dictationName: currentPassageTitle || `${g_collection} - ${g_docId}`,
    accuracy: numericAccuracy, wpm: numericWpm,
    originalText: original, typedText: typed,
    fullMistakes: full, halfMistakes: half,
    highlightedHtml: finalHtmlContent,
  };

  try {
    await localDb.attempts.add(fullResultData);
    console.log("✅ Full attempt with HTML saved locally.");
    
    await updateOverallStats({ accuracy: numericAccuracy, wpm: numericWpm });
    await updateMistakeLibrary(g_alignment);
    
    await sendLightweightStatsToFirebase(accuracy.toFixed(2), wpm.toFixed(2), time, words);
    
  } catch (err) {
    console.error("❌ Failed to save attempt using hybrid system:", err);
  }
}

async function sendLightweightStatsToFirebase(accuracy, spm, time, words) {
  const includeCommaMistakes = document.getElementById("includeComma")?.checked || false;
  const lightweightStat = {
    accuracy: accuracy + "%", 
    fullMistakes: g_fullMistakes, 
    halfMistakes: g_halfMistakes, 
    strokesPerMinute: spm, 
    timeTakenSeconds: time, 
    totalWords: words, 
    collection: g_collection,
    docId: g_docId,
    title: currentPassageTitle || g_docId || "Untitled Passage", 
    includeComma: includeCommaMistakes,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  if (attemptsRef) {
    try { await attemptsRef.add(lightweightStat); console.log("✅ Lightweight stats sent to Firebase."); } 
    catch (e) { console.error("Firebase save failed:", e); }
  }
}

function saveProgressToLocalStorage(resultData) {
    if (!candidateId) return; 
    const key = `${g_collection}-${g_docId}`; 
    const progressData = JSON.parse(localStorage.getItem(`stenoProgress_${candidateId}`) || '{}');
    const newScore = { accuracy: parseFloat(resultData.accuracy), wpm: parseFloat(resultData.typingSpeed) };
    const existingScore = progressData[key]; 
    if (!existingScore || newScore.accuracy > existingScore.accuracy) { 
        progressData[key] = newScore; 
        localStorage.setItem(`stenoProgress_${candidateId}`, JSON.stringify(progressData)); 
    }
    localStorage.setItem(`stenoLastAttempt_${candidateId}`, JSON.stringify({ collection: g_collection, docId: g_docId }));
}

// [NEW] Reset Progress Function
async function resetProgress() {
    if (!candidateId || !attemptsRef) {
        showErrorModal("Action Failed", "Cannot reset progress. User not identified.");
        return;
    }
    
    localStorage.removeItem(`stenoProgress_${candidateId}`);
    localStorage.removeItem(`stenoLastAttempt_${candidateId}`);
    localStorage.removeItem('hideResultsWelcome');
    
    try {
        await localDb.attempts.clear();
        await localDb.overallStats.clear();
        await localDb.mistakeLibrary.clear();
        console.log("Local database cleared.");
        
        const querySnapshot = await attemptsRef.get();
        const deletePromises = [];
        querySnapshot.forEach(doc => {
            deletePromises.push(doc.ref.delete());
        });
        await Promise.all(deletePromises);
        console.log("Firebase attempts cleared.");

        alert("Your progress has been successfully reset.");
        window.location.reload();
    } catch (error) {
        console.error("Error during reset:", error);
        showErrorModal("Reset Error", "Could not clear all data. Please check your connection and try again.");
    }
}

function validateReportForm() {
    const errorType = document.getElementById('errorTypeSelect').value; const otherText = document.getElementById('otherErrorText').value.trim(); const submitBtn = document.getElementById('submitReportBtn');
    submitBtn.disabled = !(errorType && otherText);
}
function showReportModal() { document.getElementById('reportErrorModal').classList.add('visible'); validateReportForm(); }
async function submitErrorReport() {
    const reportModal = document.getElementById('reportErrorModal'); const errorType = document.getElementById('errorTypeSelect').value; const otherText = document.getElementById('otherErrorText').value; const correctedText = document.getElementById('editableOriginalText').innerText;
    const reportData = { candidateId: candidateId, collection: g_collection, docId: g_docId, title: currentPassageTitle, originalTextInSystem: originalText, userCorrectedText: correctedText, reason: `${errorType}: ${otherText}`, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
    try { await db.collection("transcriptionReports").add(reportData); alert("Thank you! Your report has been submitted successfully."); reportModal.classList.remove('visible'); } catch (error) { console.error("Error submitting report:", error); alert("Could not submit report. Please check your internet connection."); }
}
function debounce(func, delay) { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; }
function initializeEventListeners() {
    document.getElementById('cat-prog').addEventListener('click', loadProgressiveDictations);
    document.getElementById('cat-ssc').addEventListener('click', loadSscPreviousYearDictations);
    document.getElementById('cat-gen').addEventListener('click', loadGeneralMatterDictations);
    document.getElementById('cat-kc').addEventListener('click', loadImportantKCDictations);
    document.getElementById('cat-legal').addEventListener('click', loadLegalDictations);
    document.getElementById('cat-speech').addEventListener('click', loadPresidentSpeeches);
    document.getElementById('cat-monthly').addEventListener('click', loadMonthlyProgressive);

    document.querySelector('.app-container').addEventListener('click', (e) => { const button = e.target.closest('.take-test-btn'); if (button && !button.disabled) { const card = button.closest('.passage-card'); if (card && card.dataset.collection && card.dataset.docId) { loadPractice(card.dataset.collection, card.dataset.docId); } } });
    document.getElementById('error-close-btn').addEventListener('click', () => { document.getElementById('error-modal').classList.remove('visible'); });
    
    // --- Reset Modal Listeners ---
    const resetModal = document.getElementById('resetConfirmModal');
    document.getElementById('resetProgressBtn').addEventListener('click', () => resetModal.classList.add('visible'));
    document.getElementById('cancelResetBtn').addEventListener('click', () => resetModal.classList.remove('visible'));
    document.getElementById('confirmResetBtn').addEventListener('click', () => { resetProgress(); resetModal.classList.remove('visible'); });

    // --- Welcome Modal Listeners ---
    const welcomeModal = document.getElementById('resultsWelcomeModal');
    document.getElementById('closeWelcomeBtn').addEventListener('click', () => { if (document.getElementById('dontShowAgainCheckbox').checked) { localStorage.setItem('hideResultsWelcome', 'true'); } welcomeModal.classList.remove('visible'); });
    
    // --- Report Modal Listeners ---
    const reportModal = document.getElementById('reportErrorModal');
    document.getElementById('cancelReportBtn').addEventListener('click', () => reportModal.classList.remove('visible'));
    document.getElementById('submitReportBtn').addEventListener('click', submitErrorReport);
    document.getElementById('errorTypeSelect').addEventListener('change', validateReportForm);
    document.getElementById('otherErrorText').addEventListener('input', validateReportForm);
    
    // --- NEW: Monthly Filter Listeners ---
    const yearFilter = document.getElementById('monthlyYearFilter');
    const monthFilter = document.getElementById('monthlyMonthFilter');
    
    // Populate year filter dynamically
    const currentYear = new Date().getFullYear();
    yearFilter.innerHTML = '<option value="">All Years</option>';
    for (let i = currentYear; i >= currentYear - 5; i--) {
        yearFilter.innerHTML += `<option value="${i}">${i}</option>`;
    }

    const applyMonthlyFilter = () => {
        const selectedYear = yearFilter.value;
        const selectedMonth = monthFilter.value;
        
        if (!selectedYear) {
            // If the year is cleared, reset the month filter and load all passages
            monthFilter.value = '';
            loadAndRenderMonthlyProgressive();
        } else {
             // If a year is selected (month can be "" for all months that year)
            loadAndRenderMonthlyProgressive(selectedYear, selectedMonth);
        }
    };
    
    yearFilter.addEventListener('change', applyMonthlyFilter);
    monthFilter.addEventListener('change', applyMonthlyFilter);
}
function showErrorModal(title, message) { document.getElementById('error-title').textContent = title; document.getElementById('error-message').textContent = message; document.getElementById('error-modal').classList.add('visible'); }
</script>
</body>
</html>
